<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Zeiterfassung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Zeiterfassung" />
  <meta name="theme-color" content="#111" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#f4f4f6; --card:#fff; --text:#111; --muted:rgba(0,0,0,.62);
      --shadow:0 2px 12px rgba(0,0,0,.08);
      --r:16px; --r2:12px;
      --okbg:#dcfce7; --ok:#166534;
      --warnbg:#fef3c7; --warn:#92400e;
      --badbg:#fee2e2; --bad:#991b1b;
      --blue:#2563eb; --green:#16a34a; --red:#dc2626; --dark:#0f172a;
    }
    body{ margin:0; padding:16px; font-family:-apple-system,system-ui; background:var(--bg); color:var(--text); }
    .card{ background:var(--card); border-radius:var(--r); padding:14px; margin-bottom:14px; box-shadow:var(--shadow); }
    h1{ margin:0 0 6px 0; font-size:20px; }
    h2{ margin:6px 0 10px 0; font-size:16px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.35; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .right{ margin-left:auto; }

    input, select, button{
      font-size:16px; padding:10px 12px; border-radius:var(--r2);
      border:1px solid #ddd; background:#fff;
    }
    button{ border:none; font-weight:800; cursor:pointer; }
    .btn-start{ background:var(--green); color:#fff; }
    .btn-pause{ background:var(--dark); color:#fff; }
    .btn-stop{ background:var(--red); color:#fff; }
    .btn-blue{ background:var(--blue); color:#fff; }
    .btn-ghost{ background:#eee; color:#111; }
    .btn-sm{ padding:8px 10px; font-size:14px; border-radius:10px; font-weight:800; }

    .pill{ display:inline-block; padding:6px 12px; border-radius:999px; font-size:13px; background:#eee; }
    .pill.ok{ background:var(--okbg); color:var(--ok); }
    .pill.warn{ background:var(--warnbg); color:var(--warn); }
    .pill.bad{ background:var(--badbg); color:var(--bad); }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ padding:10px 14px; border-radius:var(--r2); background:#eee; cursor:pointer; user-select:none; }
    .tab.active{ background:#111; color:#fff; }

    table{ width:100%; border-collapse:collapse; }
    td, th{ padding:8px; border-bottom:1px solid #eee; font-size:14px; vertical-align:top; }
    th{ text-align:left; color:rgba(0,0,0,.7); }

    .box{ background:#fafafa; border:1px solid #eee; border-radius:14px; padding:12px; }

    /* Kompakte Felder */
    .w-emp{ width:280px; max-width:92vw; }
    .w-note{ width:200px; max-width:92vw; }
    .w-mgr-name{ width:240px; max-width:92vw; }
    .w-mgr-mail{ width:260px; max-width:92vw; }
    .w-save{ width:170px; max-width:92vw; }

    /* Speichern nicht angeklebt */
    .stack{ display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
    .stack input{ margin-bottom:6px; }
    .stack button{ margin-top:4px; }

    /* Auf sehr kleinen Phones volle Breite */
    @media (max-width: 390px){
      .w-emp, .w-note, .w-mgr-name, .w-mgr-mail, .w-save{ width:92vw; }
    }

    .errCard{ display:none; border:2px solid var(--red); }
  </style>
</head>

<body>
  <div class="card errCard" id="errBox">
    <h2 style="margin:0 0 6px 0">â— Fehler</h2>
    <div class="mono" id="errText" style="white-space:pre-wrap"></div>
    <div class="muted" style="margin-top:8px">Tipp: Safari Tab schlieÃŸen & neu Ã¶ffnen.</div>
  </div>

  <div class="card">
    <h1>â±ï¸ Zeiterfassung</h1>
    <div class="muted">Offline Â· Auto-Pause <b>55 min</b> (nur wenn Brutto â‰¥ 55) Â· â¸ Pause zÃ¤hlt extra Â· CSV/Teilen</div>
  </div>

  <div class="card">
    <div class="tabs">
      <div class="tab active" data-tab="timer">â±ï¸ Timer</div>
      <div class="tab" data-tab="overview">ğŸ“Š Ãœbersicht</div>
      <div class="tab" data-tab="edit">âœï¸ RÃ¼ckwirkend</div>
      <div class="tab" data-tab="absence">ğŸ–ï¸ Abwesenheit</div>
      <div class="tab" data-tab="entries">ğŸ§¾ EintrÃ¤ge</div>
      <div class="tab" data-tab="settings">âš™ï¸ Settings</div>
    </div>
  </div>

  <!-- TIMER -->
  <div class="card" id="timer">
    <h2>â±ï¸ Timer</h2>

    <div class="stack">
      <div class="muted">ğŸ‘¤ Mitarbeiter</div>
      <input id="empName" class="w-emp" placeholder="Vorname Nachname" />
      <button class="btn-ghost w-save" id="btnSaveName">ğŸ’¾ Speichern</button>
      <div class="muted" id="nameMsg"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <div class="muted">ğŸ“… Datum</div>
        <input type="date" id="timerDate">
      </div>
      <div>
        <div class="muted">ğŸ“ Notiz</div>
        <input id="timerNote" class="w-note" placeholder="z.B. Workshop">
      </div>
      <span class="right muted mono" id="timerMini"></span>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn-start" id="btnStart">â–¶ï¸ Start</button>
      <button class="btn-pause" id="btnPause" disabled>â¸ï¸ Pause</button>
      <button class="btn-stop" id="btnStop">â–  Stop</button>
      <span class="pill" id="timerStatus">âšª bereit</span>
      <span class="right muted mono" id="timerInfo"></span>
    </div>
  </div>

  <!-- OVERVIEW -->
  <div class="card" id="overview" style="display:none">
    <h2>ğŸ“Š Ãœbersicht</h2>

    <div class="row">
      <div>
        <div class="muted">ğŸ“… Jahr</div>
        <select id="yearSelect"></select>
      </div>
      <div>
        <div class="muted">ğŸ¯ Wochen-Soll</div>
        <select id="weeklyTarget">
          <option value="2400">40:00 ğŸ‡©ğŸ‡ª</option>
          <option value="2310">38:30 ğŸ‡¦ğŸ‡¹</option>
        </select>
      </div>
      <div>
        <div class="muted">ğŸ§­ Modus</div>
        <select id="mode">
          <option value="week">Woche (ISO)</option>
          <option value="month">Monat</option>
          <option value="year">Jahr</option>
        </select>
      </div>
      <div>
        <div class="muted">ğŸ“Œ Referenz</div>
        <input type="date" id="refDate">
      </div>
      <button class="btn-ghost" id="btnRefresh">â†» Refresh</button>
      <button class="btn-blue" id="btnCSV">â¬‡ï¸ CSV</button>
      <button class="btn-ghost" id="btnShare">ğŸ“¤ Senden</button>
    </div>

    <div style="margin-top:10px">
      <span class="pill ok" id="sumPill">â€”</span>
      <span class="pill" id="avgPill" style="display:none;margin-left:6px">â€”</span>
    </div>

    <div class="box" style="margin-top:12px">
      <h2 style="margin-top:0">ğŸ‘” Manager</h2>
      <div class="stack">
        <div class="muted">Name</div>
        <input id="mgrName" class="w-mgr-name" placeholder="z.B. Max Mustermann">
        <div class="muted">E-Mail</div>
        <input id="mgrMail" class="w-mgr-mail" placeholder="manager@firma.de">
        <button class="btn-ghost w-save" id="btnSaveMgr">ğŸ’¾ Speichern</button>
        <div class="muted">Wird fÃ¼r â€Sendenâ€œ als Vorschlag genutzt (du wÃ¤hlst im Share-MenÃ¼ die App).</div>
      </div>
    </div>

    <div id="overviewTable" style="margin-top:12px"></div>
  </div>

  <!-- EDIT -->
  <div class="card" id="edit" style="display:none">
    <h2>âœï¸ RÃ¼ckwirkend</h2>
    <div class="row">
      <div>
        <div class="muted">ğŸ“… Datum</div>
        <input type="date" id="eDate">
      </div>
      <div>
        <div class="muted">ğŸŸ¢ Start</div>
        <input type="time" id="eStart">
      </div>
      <div>
        <div class="muted">ğŸ”´ Ende</div>
        <input type="time" id="eEnd">
      </div>
      <div>
        <div class="muted">ğŸ“ Notiz</div>
        <input id="eNote" class="w-note" placeholder="kurz">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn-ghost" id="btnSaveManual">ğŸ’¾ Speichern</button>
      <button class="btn-ghost" id="btnNewManual">ğŸ§½ Neu</button>
      <span class="right muted mono" id="editMsg"></span>
    </div>
    <div class="muted" style="margin-top:8px">Regeln: Ende nach Start Â· Auto-Pause 55 min (wenn Brutto â‰¥ 55)</div>
  </div>

  <!-- ABSENCE -->
  <div class="card" id="absence" style="display:none">
    <h2>ğŸ–ï¸ Abwesenheit</h2>
    <div class="row">
      <div>
        <div class="muted">ğŸ“… Datum</div>
        <input type="date" id="aDate">
      </div>
      <div>
        <div class="muted">ğŸ·ï¸ Typ</div>
        <select id="aType">
          <option value="vac">ğŸ–ï¸ Urlaub</option>
          <option value="sick">ğŸ¤’ Krank</option>
          <option value="hol">ğŸŒ Feiertag</option>
        </select>
      </div>
      <button class="btn-ghost" id="btnAddAbs">â• Speichern</button>
      <span class="muted">Reduziert Soll nur Moâ€“Fr.</span>
    </div>
    <div id="absList" style="margin-top:12px"></div>
  </div>

  <!-- ENTRIES -->
  <div class="card" id="entries" style="display:none">
    <h2>ğŸ§¾ EintrÃ¤ge</h2>
    <div class="muted">âœï¸ = bearbeiten Â· ğŸ—‘ï¸ = lÃ¶schen</div>
    <div id="entryList" style="margin-top:10px"></div>
  </div>

  <!-- SETTINGS -->
  <div class="card" id="settings" style="display:none">
    <h2>âš™ï¸ Settings</h2>
    <div class="muted">Daten liegen lokal im Browser (offline). Pro Jahr getrennt gespeichert â€“ neues Jahr startet bei 0.</div>
    <div class="row" style="margin-top:10px">
      <button class="btn-stop" id="btnReset">ğŸ§¹ Daten dieses Jahres lÃ¶schen</button>
      <button class="btn-ghost" id="btnResetAllYears">ğŸ§¨ Alles lÃ¶schen (alle Jahre)</button>
    </div>
  </div>

<script>
(() => {
  const APP_NS  = "ZEITERFASSUNG";
  const AUTO_BREAK_MIN = 55;
  const MONTH_TOL_MIN  = 10 * 60;

  function showErr(msg){
    const box = document.getElementById("errBox");
    const txt = document.getElementById("errText");
    if(!box || !txt) return;
    box.style.display = "";
    txt.textContent = String(msg || "Unbekannter Fehler");
  }
  window.addEventListener("error", (e) => {
    showErr(`${e.message}\n${e.filename||""}:${e.lineno||""}:${e.colno||""}`);
  });
  window.addEventListener("unhandledrejection", (e) => {
    showErr(`Promise error: ${e.reason?.message || e.reason}`);
  });

  const $ = (id) => document.getElementById(id);
  const pad = (n) => String(n).padStart(2,"0");
  function hhmm(min){
    const sign = min < 0 ? "-" : "";
    min = Math.abs(Math.round(min));
    return sign + pad(Math.floor(min/60)) + ":" + pad(min%60);
  }
  function parseLocalDate(dStr){
    const [y,m,d] = dStr.split("-").map(Number);
    return new Date(y, m-1, d, 0,0,0,0);
  }
  function isWeekday(d){ const w=d.getDay(); return w>=1 && w<=5; }
  function minsBetween(a,b){ return Math.round((b - a) / 60000); }
  function autoPause(grossMin){ return grossMin >= AUTO_BREAK_MIN ? AUTO_BREAK_MIN : 0; }

  function isoWeekKey(dateObj){
    const d = new Date(dateObj);
    d.setHours(0,0,0,0);
    d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
    const isoYear = d.getFullYear();
    const week1 = new Date(isoYear,0,4);
    week1.setHours(0,0,0,0);
    week1.setDate(week1.getDate() + 3 - ((week1.getDay() + 6) % 7));
    const weekNo = 1 + Math.round((d - week1) / (7*24*60*60*1000));
    return `${isoYear}-W${String(weekNo).padStart(2,"0")}`;
  }
  function weekRangeISO(ref){
    const d = new Date(ref);
    d.setHours(0,0,0,0);
    const monIndex = (d.getDay() + 6) % 7;
    const start = new Date(d); start.setDate(d.getDate() - monIndex);
    const end = new Date(start); end.setDate(start.getDate() + 6);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function monthRange(ref){
    const d = new Date(ref);
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth()+1, 0);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function yearRange(y){
    const start = new Date(y,0,1); start.setHours(0,0,0,0);
    const end = new Date(y,11,31); end.setHours(0,0,0,0);
    return [start,end];
  }
  function inRange(dateStr, start, end){
    const t = parseLocalDate(dateStr).getTime();
    return t >= start.getTime() && t <= end.getTime();
  }

  function weeklyTargetMin(){ return Number($("weeklyTarget").value || 2400); }
  function dayTargetMin(){ return Math.round(weeklyTargetMin()/5); }

  function absLabel(t){
    if(t==="vac") return "Urlaub";
    if(t==="sick") return "Krank";
    if(t==="hol") return "Feiertag";
    return t;
  }

  function dbKeyForYear(y){ return `${APP_NS}::${y}`; }
  function listKnownYears(){
    const years = new Set();
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && k.startsWith(`${APP_NS}::`)){
        const y = k.split("::")[1];
        if(/^\d{4}$/.test(y)) years.add(Number(y));
      }
    }
    return [...years].sort((a,b)=>b-a);
  }

  let state=null;
  let activeYear=new Date().getFullYear();

  function loadYear(y){
    activeYear = y;
    const raw = localStorage.getItem(dbKeyForYear(y));
    state = raw ? JSON.parse(raw) : { empName:"", mgr:{name:"",mail:""}, entries:[], abs:[] };
    $("empName").value = state.empName || "";
    $("mgrName").value = state.mgr.name || "";
    $("mgrMail").value = state.mgr.mail || "";
  }
  function saveYear(){ localStorage.setItem(dbKeyForYear(activeYear), JSON.stringify(state)); }

  function makeId(){
    return (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)+"_"+Date.now());
  }

  function showTab(name){
    document.querySelectorAll(".tab").forEach(t=>{
      t.classList.toggle("active", t.getAttribute("data-tab")===name);
    });
    ["timer","overview","edit","absence","entries","settings"].forEach(id=>{
      $(id).style.display = (id===name) ? "" : "none";
    });
  }
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click", ()=>showTab(tab.getAttribute("data-tab")));
  });

  let running=null;
  function setTimerStatus(text, cls){
    const pill = $("timerStatus");
    pill.textContent = text;
    pill.className = "pill" + (cls ? (" " + cls) : "");
  }
  function netMinutes(entry){
    const s = new Date(entry.start);
    const e = new Date(entry.end);
    const gross = minsBetween(s,e);
    return Math.max(0, gross - (entry.pause||0));
  }
  function absMinusForDate(dateStr){
    const d = parseLocalDate(dateStr);
    if(!isWeekday(d)) return 0;
    return state.abs.some(a => a.date === dateStr) ? dayTargetMin() : 0;
  }

  function saveName(){
    const v = ($("empName").value || "").trim();
    state.empName = v;
    saveYear();
    $("nameMsg").textContent = v ? "âœ… gespeichert" : "âš ï¸ Name fehlt";
    $("timerMini").textContent = v ? `ğŸ‘¤ ${v}` : "";
    renderAll();
  }
  function saveManager(){
    state.mgr = { name: ($("mgrName").value||"").trim(), mail: ($("mgrMail").value||"").trim() };
    saveYear(); alert("âœ… Manager gespeichert");
  }

  function startTimer(){
    if(running) return alert("Timer lÃ¤uft bereits.");
    if(!state.empName) return alert("Bitte Mitarbeitername speichern.");
    const dateStr = $("timerDate").value;
    if(!dateStr) return alert("Bitte Datum wÃ¤hlen.");

    const now = new Date(); now.setSeconds(0,0);
    const d = parseLocalDate(dateStr);
    const startDt = new Date(d.getFullYear(), d.getMonth(), d.getDate(), now.getHours(), now.getMinutes(), 0);

    running = { dateStr, startDt, pauseStartDt:null, pauseMin:0, note: ($("timerNote").value||"").trim() };
    $("btnPause").disabled = false;
    $("btnPause").textContent = "â¸ï¸ Pause";
    setTimerStatus("ğŸŸ¢ lÃ¤uft", "ok");
    $("timerInfo").textContent = `Start ${pad(startDt.getHours())}:${pad(startDt.getMinutes())}`;
  }
  function togglePause(){
    if(!running) return;
    const now = new Date(); now.setSeconds(0,0);
    if(!running.pauseStartDt){
      running.pauseStartDt = now;
      $("btnPause").textContent = "â–¶ï¸ Weiter";
      setTimerStatus("â¸ï¸ Pause", "warn");
      $("timerInfo").textContent = `Pause seit ${pad(now.getHours())}:${pad(now.getMinutes())}`;
    } else {
      running.pauseMin += Math.max(0, minsBetween(running.pauseStartDt, now));
      running.pauseStartDt = null;
      $("btnPause").textContent = "â¸ï¸ Pause";
      setTimerStatus("ğŸŸ¢ lÃ¤uft", "ok");
      $("timerInfo").textContent = `Pausenzeit ${hhmm(running.pauseMin)}`;
    }
  }
  function stopTimer(){
    if(!running) return alert("Kein laufender Timer.");
    const end = new Date(); end.setSeconds(0,0);

    if(running.pauseStartDt){
      running.pauseMin += Math.max(0, minsBetween(running.pauseStartDt, end));
      running.pauseStartDt = null;
    }
    const gross = minsBetween(running.startDt, end);
    if(gross <= 0) return alert("UngÃ¼ltige Zeit (Ende vor Start).");

    const pause = autoPause(gross) + Math.max(0, running.pauseMin);

    state.entries.push({
      id: makeId(), date: running.dateStr,
      start: running.startDt.toISOString(), end: end.toISOString(),
      pause, note: running.note || ""
    });

    running=null;
    saveYear();
    $("btnPause").disabled = true;
    $("btnPause").textContent = "â¸ï¸ Pause";
    setTimerStatus("âšª bereit", "");
    $("timerInfo").textContent = "âœ… gespeichert";
    renderAll();
  }

  let editingId=null;
  function clearManual(){
    editingId=null; $("eStart").value=""; $("eEnd").value=""; $("eNote").value=""; $("editMsg").textContent="";
  }
  function saveManual(){
    if(running) return alert("Bitte Timer zuerst stoppen.");
    const dStr=$("eDate").value, st=$("eStart").value, en=$("eEnd").value;
    if(!dStr||!st||!en){ $("editMsg").textContent="âš ï¸ Datum/Start/Ende fehlt."; return; }
    const d=parseLocalDate(dStr);
    const [sh,sm]=st.split(":").map(Number), [eh,em]=en.split(":").map(Number);
    const start=new Date(d.getFullYear(),d.getMonth(),d.getDate(),sh,sm,0);
    const end=new Date(d.getFullYear(),d.getMonth(),d.getDate(),eh,em,0);
    const gross=minsBetween(start,end);
    if(gross<=0){ $("editMsg").textContent="âš ï¸ Ende muss nach Start liegen."; return; }

    const obj={ id: editingId||makeId(), date:dStr, start:start.toISOString(), end:end.toISOString(),
      pause:autoPause(gross), note:($("eNote").value||"").trim()
    };
    if(editingId){
      const idx=state.entries.findIndex(x=>x.id===editingId);
      if(idx>=0) state.entries[idx]=obj; else state.entries.push(obj);
      $("editMsg").textContent="âœ… aktualisiert";
    } else { state.entries.push(obj); editingId=obj.id; $("editMsg").textContent="âœ… gespeichert"; }
    saveYear(); renderAll();
  }

  function addAbs(){
    const d=$("aDate").value, t=$("aType").value;
    if(!d) return alert("Datum fehlt.");
    state.abs.push({id:makeId(), date:d, type:t});
    saveYear(); renderAll();
  }

  function workMinutesByDateInRange(start,end){
    const map={};
    for(const e of state.entries){
      if(!e.end) continue;
      if(!inRange(e.date,start,end)) continue;
      map[e.date]=(map[e.date]||0)+netMinutes(e);
    }
    return map;
  }
  function summaryForRange(start,end){
    const workByDate=workMinutesByDateInRange(start,end);
    let ist=0,soll=0;
    const cur=new Date(start); cur.setHours(0,0,0,0);
    while(cur<=end){
      const ds=`${cur.getFullYear()}-${pad(cur.getMonth()+1)}-${pad(cur.getDate())}`;
      const dayIst=workByDate[ds]||0;
      const baseSoll=isWeekday(cur)?dayTargetMin():0;
      const minus=absMinusForDate(ds);
      ist+=dayIst; soll+=Math.max(0,baseSoll-minus);
      cur.setDate(cur.getDate()+1);
    }
    return {ist,soll,saldo:ist-soll,workByDate};
  }

  function monthAverageWeeklyScaled(refDate){
    const [ms,me]=monthRange(refDate);
    const workByDate=workMinutesByDateInRange(ms,me);
    const buckets=new Map();
    const cur=new Date(ms); cur.setHours(0,0,0,0);
    while(cur<=me){
      const ds=`${cur.getFullYear()}-${pad(cur.getMonth()+1)}-${pad(cur.getDate())}`;
      const key=isoWeekKey(cur);
      if(!buckets.has(key)) buckets.set(key,{ist:0,weekdays:0,absWeekdays:0});
      const b=buckets.get(key);
      b.ist += (workByDate[ds]||0);
      if(isWeekday(cur)){
        b.weekdays+=1;
        if(absMinusForDate(ds)>0) b.absWeekdays+=1;
      }
      cur.setDate(cur.getDate()+1);
    }
    const active=[...buckets.values()].filter(b=>b.weekdays>0);
    const scaledIst=active.map(b=>b.ist*(5/b.weekdays));
    const avgScaledIst=scaledIst.length?(scaledIst.reduce((s,v)=>s+v,0)/scaledIst.length):0;

    const W=weeklyTargetMin(), DAY=dayTargetMin();
    const scaledSoll=active.map(b=>W-(b.absWeekdays*DAY));
    const avgSoll=scaledSoll.length?(scaledSoll.reduce((s,v)=>s+v,0)/scaledSoll.length):W;
    return {avgScaledIst,avgSoll,weeksCount:active.length};
  }

  function renderOverview(){
    const mode=$("mode").value;
    const refStr=$("refDate").value;
    if(!refStr){ $("overviewTable").innerHTML=`<div class="muted">Bitte Referenzdatum wÃ¤hlen.</div>`; return; }
    const ref=parseLocalDate(refStr);
    let start,end;
    if(mode==="week") [start,end]=weekRangeISO(ref);
    else if(mode==="month") [start,end]=monthRange(ref);
    else [start,end]=yearRange(activeYear);

    const s=summaryForRange(start,end);
    const sumPill=$("sumPill"), avgPill=$("avgPill");
    avgPill.style.display="none";

    let cls="ok";
    if(mode==="month"){
      const avg=monthAverageWeeklyScaled(ref);
      const W=weeklyTargetMin();
      const low=W-MONTH_TOL_MIN, high=W+MONTH_TOL_MIN;
      avgPill.style.display="";
      avgPill.textContent=`ğŸ“ˆ Ã˜/Woche ${hhmm(Math.round(avg.avgScaledIst))} (Soll ${hhmm(W)} Â±10:00)`;
      if(avg.avgScaledIst<low||avg.avgScaledIst>high){ cls="bad"; avgPill.className="pill bad"; }
      else if(Math.abs(avg.avgScaledIst-W)>1){ cls="warn"; avgPill.className="pill warn"; }
      else { cls="ok"; avgPill.className="pill ok"; }
    } else {
      if(Math.abs(s.saldo)>MONTH_TOL_MIN) cls="bad";
      else if(Math.abs(s.saldo)>1) cls="warn";
      else cls="ok";
    }
    sumPill.className=`pill ${cls}`;
    sumPill.textContent=`IST ${hhmm(s.ist)} Â· SOLL ${hhmm(s.soll)} Â· SALDO ${hhmm(s.saldo)}`;

    const workByDate=s.workByDate;
    const dayNames=["So","Mo","Di","Mi","Do","Fr","Sa"];
    const DAY=dayTargetMin();

    let html=`<table><thead><tr>
      <th>Datum</th><th>Tag</th><th>IST</th><th>SOLL</th><th>Abw.</th><th>SALDO</th>
    </tr></thead><tbody>`;
    const cur=new Date(start); cur.setHours(0,0,0,0);
    while(cur<=end){
      const ds=`${cur.getFullYear()}-${pad(cur.getMonth()+1)}-${pad(cur.getDate())}`;
      const ist=workByDate[ds]||0;
      const baseSoll=isWeekday(cur)?DAY:0;
      const minus=absMinusForDate(ds);
      const soll=Math.max(0,baseSoll-minus);
      const saldo=ist-soll;

      const absTypes=state.abs.filter(a=>a.date===ds).map(a=>absLabel(a.type));
      html += `<tr>
        <td class="mono">${ds}</td>
        <td>${dayNames[cur.getDay()]}</td>
        <td class="mono">${hhmm(ist)}</td>
        <td class="mono">${hhmm(soll)}</td>
        <td>${absTypes.join(", ")}</td>
        <td class="mono">${hhmm(saldo)}</td>
      </tr>`;
      cur.setDate(cur.getDate()+1);
    }
    html += `</tbody></table>`;
    $("overviewTable").innerHTML=html;
  }

  function renderAbsList(){
    const abs=[...state.abs].sort((a,b)=>b.date.localeCompare(a.date));
    if(!abs.length){ $("absList").innerHTML=`<div class="muted">Keine Abwesenheiten.</div>`; return; }
    let html=`<table><thead><tr><th>Datum</th><th>Typ</th><th></th></tr></thead><tbody>`;
    for(const a of abs.slice(0,400)){
      html += `<tr>
        <td class="mono">${a.date}</td><td>${absLabel(a.type)}</td>
        <td><button class="btn-ghost btn-sm" data-del-abs="${a.id}">ğŸ—‘ï¸</button></td>
      </tr>`;
    }
    html += `</tbody></table>`;
    $("absList").innerHTML=html;
    document.querySelectorAll("[data-del-abs]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.getAttribute("data-del-abs");
        state.abs=state.abs.filter(x=>x.id!==id);
        saveYear(); renderAll();
      });
    });
  }

  function renderEntryList(){
    const entries=[...state.entries].sort((a,b)=>b.date.localeCompare(a.date));
    if(!entries.length){ $("entryList").innerHTML=`<div class="muted">Noch keine EintrÃ¤ge.</div>`; return; }

    let html=`<table><thead><tr><th>Datum</th><th>Info</th><th></th></tr></thead><tbody>`;
    for(const e of entries.slice(0,500)){
      const s=new Date(e.start), en=new Date(e.end);
      const info=`Netto ${hhmm(netMinutes(e))} Â· Pause ${hhmm(e.pause||0)} Â· ${pad(s.getHours())}:${pad(s.getMinutes())}â€“${pad(en.getHours())}:${pad(en.getMinutes())} Â· ${e.note||""}`;
      const safe=encodeURIComponent(JSON.stringify(e));
      html += `<tr>
        <td class="mono">${e.date}</td>
        <td class="mono">${info}</td>
        <td>
          <button class="btn-ghost btn-sm" data-edit="${safe}">âœï¸</button>
          <button class="btn-ghost btn-sm" data-del="${e.id}">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    }
    html += `</tbody></table>`;
    $("entryList").innerHTML=html;

    document.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id=btn.getAttribute("data-del");
        state.entries=state.entries.filter(x=>x.id!==id);
        saveYear(); renderAll();
      });
    });
    document.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const e=JSON.parse(decodeURIComponent(btn.getAttribute("data-edit")));
        editingId=e.id;
        $("eDate").value=e.date;
        const s=new Date(e.start), en=new Date(e.end);
        $("eStart").value=`${pad(s.getHours())}:${pad(s.getMinutes())}`;
        $("eEnd").value=`${pad(en.getHours())}:${pad(en.getMinutes())}`;
        $("eNote").value=e.note||"";
        $("editMsg").textContent="Bearbeiten aktiv";
        showTab("edit");
      });
    });
  }

  function buildCSV(){
    const sep=";";
    const header=["Mitarbeiter","Jahr","WochenSoll_min","Datum","Start","Ende","Pause_min","Netto_min","Netto_hhmm","Notiz"].join(sep);

    const mode=$("mode").value;
    const refStr=$("refDate").value || new Date().toISOString().slice(0,10);
    const ref=parseLocalDate(refStr);
    let start,end;
    if(mode==="week") [start,end]=weekRangeISO(ref);
    else if(mode==="month") [start,end]=monthRange(ref);
    else [start,end]=yearRange(activeYear);

    const rows=[header];
    const emp=(state.empName||"").trim();
    const W=weeklyTargetMin();

    const ents=state.entries.filter(e=>e.end && inRange(e.date,start,end)).sort((a,b)=>a.date.localeCompare(b.date));
    for(const e of ents){
      const net=netMinutes(e);
      rows.push([emp,String(activeYear),String(W),e.date,e.start,e.end,String(e.pause||0),String(net),hhmm(net),(e.note||"").replaceAll(";",",")].join(sep));
    }
    const abs=state.abs.filter(a=>inRange(a.date,start,end)).sort((a,b)=>a.date.localeCompare(b.date));
    for(const a of abs){
      rows.push([emp,String(activeYear),String(W),a.date,"","","0","0","00:00",absLabel(a.type)].join(sep));
    }
    const s=summaryForRange(start,end);
    rows.push("");
    rows.push(["SUMMARY","","","", "", "", "", String(s.ist), hhmm(s.ist), "IST"].join(sep));
    rows.push(["SUMMARY","","","", "", "", "", String(s.soll), hhmm(s.soll), "SOLL"].join(sep));
    rows.push(["SUMMARY","","","", "", "", "", String(s.saldo), hhmm(s.saldo), "SALDO"].join(sep));

    return rows.join("\n");
  }

  function downloadCSV(){
    if(!state.empName) return alert("Bitte Mitarbeitername speichern.");
    const csv=buildCSV();
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`Zeiterfassung_${activeYear}_${state.empName.replaceAll(" ","_")}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  async function shareCSV(){
    if(!state.empName) return alert("Bitte Mitarbeitername speichern.");
    const csv=buildCSV();
    const file=new File([new Blob([csv],{type:"text/csv"})], `zeiterfassung_${activeYear}.csv`, {type:"text/csv"});
    const title=`Zeiterfassung â€“ ${state.empName} (${activeYear})`;
    const text=`Zeiterfassung ${activeYear} â€“ ${state.empName}\nManager: ${state.mgr.name || ""} ${state.mgr.mail || ""}`.trim();

    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title,text,files:[file]});
      return;
    }
    // Fallback: wenigstens CSV Download
    alert("Teilen nicht verfÃ¼gbar. Bitte CSV herunterladen und dann senden.");
  }

  function resetYear(){
    if(confirm(`Wirklich alle Daten fÃ¼r ${activeYear} lÃ¶schen?`)){
      localStorage.removeItem(dbKeyForYear(activeYear));
      loadYear(activeYear); renderAll();
    }
  }
  function resetAllYears(){
    if(confirm("Wirklich ALLE Jahre lÃ¶schen?")){
      listKnownYears().forEach(y=>localStorage.removeItem(dbKeyForYear(y)));
      loadYear(new Date().getFullYear()); renderAll();
    }
  }

  // Jahr-Auswahl: immer mÃ¶glich (aktuelles Â±3 + bekannte Jahre)
  function renderYearSelect(){
    const nowY = new Date().getFullYear();
    const baseYears = [];
    for(let y = nowY - 3; y <= nowY + 3; y++) baseYears.push(y);
    const known = listKnownYears();
    const years = Array.from(new Set([...baseYears, ...known])).sort((a,b)=>b-a);

    $("yearSelect").innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
    $("yearSelect").value = String(activeYear);
  }

  function renderAll(){
    $("timerMini").textContent = state.empName ? `ğŸ‘¤ ${state.empName}` : "";
    $("nameMsg").textContent = state.empName ? "âœ… gespeichert" : "";
    renderAbsList();
    renderEntryList();
    renderOverview();
    renderYearSelect();
    saveYear();
  }

  function saveName(){
    const v = ($("empName").value || "").trim();
    state.empName = v;
    saveYear();
    renderAll();
  }
  function saveManager(){
    state.mgr = { name: ($("mgrName").value||"").trim(), mail: ($("mgrMail").value||"").trim() };
    saveYear(); alert("âœ… Manager gespeichert");
  }

  // Re-wire functions after hoisting
  $("btnSaveName").addEventListener("click", saveName);
  $("btnSaveMgr").addEventListener("click", saveManager);
  $("btnStart").addEventListener("click", startTimer);
  $("btnPause").addEventListener("click", togglePause);
  $("btnStop").addEventListener("click", stopTimer);
  $("btnSaveManual").addEventListener("click", saveManual);
  $("btnNewManual").addEventListener("click", clearManual);
  $("btnAddAbs").addEventListener("click", addAbs);
  $("btnRefresh").addEventListener("click", renderAll);
  $("btnCSV").addEventListener("click", downloadCSV);
  $("btnShare").addEventListener("click", shareCSV);
  $("btnReset").addEventListener("click", resetYear);
  $("btnResetAllYears").addEventListener("click", resetAllYears);

  ["weeklyTarget","mode","refDate"].forEach(id => $(id).addEventListener("change", renderAll));
  $("yearSelect").addEventListener("change", ()=>{
    const y=Number($("yearSelect").value);
    loadYear(y); renderAll();
  });

  function init(){
    const today=new Date().toISOString().slice(0,10);
    activeYear=new Date().getFullYear();
    loadYear(activeYear);

    $("timerDate").value=today;
    $("refDate").value=today;
    $("eDate").value=today;
    $("aDate").value=today;

    $("btnPause").disabled=true;
    setTimerStatus("âšª bereit","");
    $("timerInfo").textContent="";
    renderAll();
  }

  init();
})();
</script>
</body>
</html>
