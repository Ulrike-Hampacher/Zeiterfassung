<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Zeiterfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
/* ===== Grundlayout ===== */
body{
  margin:0;
  font-family:-apple-system,system-ui;
  background:#f4f6f8;
  color:#111;
}
.card{
  background:#fff;
  margin:12px;
  padding:14px;
  border-radius:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
h1{margin:0 0 6px 0;font-size:20px}
h2{margin:6px 0 10px 0;font-size:16px}
.muted{color:#666;font-size:13px}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.stack{display:flex;flex-direction:column;gap:6px}

input,select,button{
  font-size:16px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #ccc;
}
button{border:none;font-weight:600}

/* ===== Buttons ===== */
.start{background:#16a34a;color:#fff}
.pause{background:#0f172a;color:#fff}
.stop{background:#dc2626;color:#fff}
.blue{background:#2563eb;color:#fff}
.ghost{background:#eee}

/* ===== Tabs ===== */
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:10px;background:#eee;cursor:pointer}
.tab.active{background:#111;color:#fff}

/* ===== Inputs (mobil optimiert) ===== */
.w-name{width:200px}
.w-mail{width:280px}
.w-note{width:150px}
@media(max-width:360px){
  .w-mail{width:240px}
  .w-name{width:180px}
}

/* ===== PIN Overlay ===== */
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  padding:12px;
}
.modal{
  background:#fff;
  padding:16px;
  border-radius:16px;
  width:min(92vw,340px);
}
.pin{
  width:100%;
  text-align:center;
  font-size:18px;
  letter-spacing:.15em;
}

/* ===== Tabelle ===== */
table{width:100%;border-collapse:collapse}
th,td{padding:6px;border-bottom:1px solid #eee;font-size:14px}
.ok{color:#166534}
.bad{color:#991b1b;font-weight:700}
</style>
</head>

<body>

<div class="card">
  <h1>â±ï¸ Zeiterfassung</h1>
  <div class="muted">Offline Â· Auto-Pause 55 min Â· CSV</div>
</div>

<div class="card">
  <div class="tabs">
    <div class="tab active" onclick="showTab('timer', this)">Timer</div>
    <div class="tab" onclick="showTab('overview', this)">Ãœbersicht</div>
    <div class="tab" onclick="showTab('absence', this)">Abwesenheit</div>
    <div class="tab" onclick="showTab('settings', this)">Settings</div>
  </div>
</div>

<!-- TIMER -->
<div class="card" id="timer">
  <h2>Timer</h2>

  <div class="stack">
    <label>Mitarbeiter</label>
    <input id="emp" class="w-name" placeholder="Vorname Nachname">
    <button class="ghost" onclick="saveName()">ğŸ’¾ Speichern</button>
    <div class="muted" id="empMsg"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="stack">
      <label>Datum</label>
      <input type="date" id="tDate">
    </div>
    <div class="stack">
      <label>Notiz</label>
      <input placeholder="kurz" class="w-note" id="note">
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="start" onclick="startTimer()">â–¶ï¸ Start</button>
    <button class="pause" onclick="pauseInfo()">â¸ï¸ Pause</button>
    <button class="stop" onclick="stopTimer()">â–  Stop</button>
    <span id="status" class="muted"></span>
  </div>
</div>

<!-- ÃœBERSICHT -->
<div class="card" id="overview" style="display:none">
  <h2>Ãœbersicht</h2>

  <div class="row">
    <div class="stack">
      <label>Modus</label>
      <select id="mode" onchange="render()">
        <option value="week">Woche</option>
        <option value="month">Monat</option>
        <option value="year">Jahr</option>
      </select>
    </div>

    <div class="stack">
      <label>ğŸ“Œ Datum</label>
      <input type="date" id="ref" onchange="render()">
    </div>

    <div class="stack">
      <label>Wochen-Soll</label>
      <select id="target" onchange="render()">
        <option value="2400">40h ğŸ‡©ğŸ‡ª</option>
        <option value="2310">38,5h ğŸ‡¦ğŸ‡¹</option>
      </select>
    </div>

    <button class="ghost" onclick="render()">â†»</button>
    <button class="blue" onclick="downloadCSV()">â¬‡ï¸ CSV</button>
  </div>

  <div id="sum" style="margin:10px 0"></div>
  <div id="table"></div>

  <h2>Manager</h2>
  <div class="stack">
    <input id="mgrName" class="w-name" placeholder="Name">
    <input id="mgrMail" class="w-mail" placeholder="mail@firma.at">
    <button class="ghost" onclick="saveMgr()">ğŸ’¾ Speichern</button>
  </div>
</div>

<!-- ABWESENHEIT -->
<div class="card" id="absence" style="display:none">
  <h2>Abwesenheit</h2>
  <div class="row">
    <div class="stack">
      <label>Datum</label>
      <input type="date" id="aDate">
    </div>

    <div class="stack">
      <label>Typ</label>
      <select id="aType">
        <option value="Urlaub">ğŸ–ï¸ Urlaub</option>
        <option value="Krank">ğŸ¤’ Krank</option>
        <option value="Feiertag">ğŸ‰ Feiertag</option>
      </select>
    </div>

    <button class="ghost" onclick="addAbs()">â• Speichern</button>
  </div>

  <div id="absList" style="margin-top:10px"></div>
</div>

<!-- SETTINGS -->
<div class="card" id="settings" style="display:none">
  <h2>Settings</h2>
  <div class="muted">Tipp: Wenn Daten â€komischâ€œ wirken: Alles lÃ¶schen und neu starten.</div>
  <div class="row" style="margin-top:10px">
    <button class="stop" onclick="resetAll()">ğŸ§¨ Alles lÃ¶schen</button>
  </div>
</div>

<script>
/* ===== stabile Minimal-Logik ===== */
const LS="ZEITERFASSUNG_MINI";
const AUTO_BREAK=55;

let state={ emp:"", mgr:{name:"",mail:""}, E:[], A:[] };
let running=null;

function showTab(id, el){
  ["timer","overview","absence","settings"].forEach(x=>{
    document.getElementById(x).style.display = (x===id) ? "" : "none";
  });
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
}

function today(){ return new Date().toISOString().slice(0,10); }

function fmt(m){
  m=Math.max(0, Math.round(m));
  const h=Math.floor(m/60), mm=m%60;
  return String(h).padStart(2,"0")+":"+String(mm).padStart(2,"0");
}

function absLabel(t){
  if(t==="Urlaub") return "ğŸ–ï¸ Urlaub";
  if(t==="Krank") return "ğŸ¤’ Krank";
  if(t==="Feiertag") return "ğŸ‰ Feiertag";
  return t;
}

function load(){
  try{
    const raw=localStorage.getItem(LS);
    if(raw) state=JSON.parse(raw);
  }catch(e){}
  emp.value = state.emp || "";
  mgrName.value = state.mgr?.name || "";
  mgrMail.value = state.mgr?.mail || "";
}

function save(){
  localStorage.setItem(LS, JSON.stringify(state));
}

function saveName(){
  state.emp = (emp.value||"").trim();
  save();
  empMsg.textContent = state.emp ? "âœ… gespeichert" : "âš ï¸ bitte Name eintragen";
}

function saveMgr(){
  state.mgr = { name:(mgrName.value||"").trim(), mail:(mgrMail.value||"").trim() };
  save();
  alert("âœ… Manager gespeichert");
}

function startTimer(){
  if(!state.emp) return alert("Bitte Mitarbeiter speichern.");
  const d = tDate.value || today();
  running = { d, start: Date.now(), note: (note.value||"").trim() };
  status.textContent = "ğŸŸ¢ lÃ¤uft";
}

function pauseInfo(){
  alert("â¸ï¸ Pause wird automatisch (55 min) abgezogen.\n(Manuelle Pause folgt als nÃ¤chster Schritt, wenn du willst.)");
}

function stopTimer(){
  if(!running) return alert("Kein Timer lÃ¤uft.");
  const end=Date.now();
  const gross = Math.max(0, Math.round((end-running.start)/60000));
  const net = Math.max(0, gross - AUTO_BREAK);

  state.E.push({ d: running.d, m: net, n: running.note });
  running=null;
  save();
  status.textContent = "âœ… gespeichert";
  render();
}

function addAbs(){
  const d = aDate.value || today();
  const t = aType.value;
  state.A.push({ d, t });
  save();
  renderAbs();
  render(); // Ãœbersicht aktualisieren
}

function renderAbs(){
  if(!state.A.length){
    absList.innerHTML = "<div class='muted'>Keine Abwesenheiten.</div>";
    return;
  }
  const rows = state.A.slice().sort((a,b)=>b.d.localeCompare(a.d)).map((a,i)=>`
    <tr>
      <td>${a.d}</td>
      <td>${absLabel(a.t)}</td>
      <td><button class="ghost" onclick="delAbs(${i})">ğŸ—‘ï¸</button></td>
    </tr>
  `).join("");
  absList.innerHTML = `<table><tr><th>Datum</th><th>Typ</th><th></th></tr>${rows}</table>`;
}

function delAbs(i){
  state.A.splice(i,1);
  save();
  renderAbs();
  render();
}

function calcSollMinutesForPeriod(){
  const weekly = Number(target.value) || 2400;
  const daySoll = weekly/5;
  const modeVal = mode.value;
  // Minimal: SOLL = weekly fÃ¼r Woche, weekly*4.33 fÃ¼r Monat, weekly*52 fÃ¼r Jahr
  // (fÃ¼r diese stabile Mini-Version ohne Feiertagskalender-Berechnung)
  if(modeVal==="week") return weekly;
  if(modeVal==="month") return Math.round(weekly * 4.33);
  return weekly * 52;
}

function render(){
  // Tabelle: zeigt aktuell einfach die vorhandenen EintrÃ¤ge (stabil)
  let sumIst=0;
  let html="<table><tr><th>Datum</th><th>Netto</th><th>Notiz</th></tr>";
  state.E.slice().sort((a,b)=>b.d.localeCompare(a.d)).forEach(e=>{
    sumIst += (Number(e.m)||0);
    html += `<tr><td>${e.d}</td><td>${fmt(e.m)}</td><td>${e.n||""}</td></tr>`;
  });
  html += "</table>";
  table.innerHTML = state.E.length ? html : "<div class='muted'>Noch keine EintrÃ¤ge.</div>";

  const soll = calcSollMinutesForPeriod();
  const diff = sumIst - soll;
  const ok = (Math.abs(diff) <= 600); // +-10h

  sum.innerHTML = ok
    ? `<div class="ok">âœ… IST ${fmt(sumIst)} Â· SOLL ${fmt(soll)} Â· SALDO ${fmt(Math.abs(diff))}</div>`
    : `<div class="bad">âš ï¸ IST ${fmt(sumIst)} Â· SOLL ${fmt(soll)} Â· Abweichung > 10h</div>`;
}

function downloadCSV(){
  const rows = [];
  rows.push("Mitarbeiter;Datum;Netto_min;Netto_hhmm;Notiz;Manager;ManagerMail");
  state.E.forEach(e=>{
    rows.push([
      (state.emp||"").replaceAll(";"," "),
      e.d,
      String(e.m||0),
      fmt(e.m||0),
      (e.n||"").replaceAll(";"," "),
      (state.mgr?.name||"").replaceAll(";"," "),
      (state.mgr?.mail||"").replaceAll(";"," ")
    ].join(";"));
  });
  const csv = rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Zeiterfassung_${today()}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}

function resetAll(){
  if(confirm("Wirklich alles lÃ¶schen?")){
    localStorage.removeItem(LS);
    state={ emp:"", mgr:{name:"",mail:""}, E:[], A:[] };
    load();
    renderAbs();
    render();
  }
}

/* Init */
tDate.value = ref.value = aDate.value = today();
load();
renderAbs();
render();
</script>

</body>
</html>
