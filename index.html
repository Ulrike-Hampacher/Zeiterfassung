<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Zeiterfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Zeiterfassung">
<meta name="theme-color" content="#111">
<meta name="robots" content="noindex,nofollow">

<style>
:root{
  --bg:#f4f6f8; --card:#fff; --text:#111; --muted:#666;
  --ok:#166534; --okbg:#dcfce7;
  --warn:#92400e; --warnbg:#fef3c7;
  --bad:#991b1b; --badbg:#fee2e2;
  --blue:#2563eb; --green:#16a34a; --red:#dc2626; --dark:#0f172a;
}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:-apple-system,system-ui;background:var(--bg);color:var(--text)}
.card{background:var(--card);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
h1{margin:0 0 6px 0;font-size:20px}
h2{margin:6px 0 10px 0;font-size:16px}
.muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.right{margin-left:auto}
input,select,button{font-size:16px;padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff}
button{border:none;font-weight:700;cursor:pointer}
.btn-start{background:var(--green);color:#fff}
.btn-pause{background:var(--dark);color:#fff}
.btn-stop{background:var(--red);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-ghost{background:#eee;color:#111}
.btn-sm{padding:8px 10px;font-size:14px;border-radius:10px}
.pill{display:inline-block;padding:6px 12px;border-radius:999px;font-size:13px;background:#eee}
.pill.ok{background:var(--okbg);color:var(--ok)}
.pill.warn{background:var(--warnbg);color:var(--warn)}
.pill.bad{background:var(--badbg);color:var(--bad)}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:10px 14px;border-radius:12px;background:#eee;cursor:pointer}
.tab.active{background:#111;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:14px;vertical-align:top}
th{text-align:left;color:#777}
.mono{font-family:ui-monospace,Menlo,monospace}

/* âœ… kompakt */
.w-emp{width:220px;max-width:220px}
.w-note{width:160px;max-width:160px}
.w-save{width:140px;max-width:140px}

/* âœ… Manager (Name + Mail) fluchten, Mail links -7 */
.w-mgr-name{width:200px;max-width:200px;margin-left:-7px}
.w-mgr-mail{
  width:360px; max-width:90vw; min-width:280px;
  margin-left:-7px; /* wie besprochen */
}

/* Speichern nicht kleben */
.stack{display:flex;flex-direction:column;gap:8px;align-items:flex-start}
.stack input{margin-bottom:6px}
.stack button{margin-top:4px}

/* Ampel: Saldo-Spalte pro Tag */
tr.ok  td:last-child{color:var(--ok);font-weight:800}
tr.warn td:last-child{color:var(--warn);font-weight:800}
tr.bad td:last-child{color:var(--bad);font-weight:800}

/* sehr kleine Phones */
@media(max-width:340px){
  .w-emp{width:210px;max-width:210px}
  .w-note{width:150px;max-width:150px}
  .w-save{width:140px;max-width:140px}
  .w-mgr-name{width:190px;max-width:190px;margin-left:-7px}
  /* w-mgr-mail bleibt flexibel, nicht Ã¼berschreiben */
}
</style>
</head>

<body>

<div class="card">
  <h1>â±ï¸ Zeiterfassung</h1>
  <div class="muted">Offline Â· Auto-Pause <b>55 min</b> Â· CSV & Teilen Â· iOS/Android</div>
</div>

<div class="card">
  <div class="tabs">
    <div class="tab active" data-tab="timer">â±ï¸ Timer</div>
    <div class="tab" data-tab="overview">ğŸ“Š Ãœbersicht</div>
    <div class="tab" data-tab="edit">âœï¸ RÃ¼ckwirkend</div>
    <div class="tab" data-tab="absence">ğŸ–ï¸ Abwesenheit</div>
    <div class="tab" data-tab="entries">ğŸ§¾ EintrÃ¤ge</div>
    <div class="tab" data-tab="settings">âš™ï¸ Settings</div>
  </div>
</div>

<!-- TIMER -->
<div class="card" id="timer">
  <h2>â±ï¸ Timer</h2>

  <div class="stack">
    <div class="muted">ğŸ‘¤ Mitarbeiter</div>
    <input id="empName" class="w-emp" placeholder="Vorname Nachname">
    <button class="btn-ghost w-save" id="saveName">ğŸ’¾ Speichern</button>
    <div class="muted" id="nameMsg"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <div class="muted">ğŸ“… Datum</div>
      <input type="date" id="timerDate">
    </div>
    <div>
      <div class="muted">ğŸ“ Notiz</div>
      <input id="timerNote" class="w-note" placeholder="kurz">
    </div>
    <span class="right muted mono" id="timerMini"></span>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="btn-start" id="btnStart">â–¶ï¸ Start</button>
    <button class="btn-pause" id="btnPause" disabled>â¸ï¸ Pause</button>
    <button class="btn-stop" id="btnStop">â–  Stop</button>
    <span class="pill" id="timerStatus">âšª bereit</span>
    <span class="right muted mono" id="timerInfo"></span>
  </div>
</div>

<!-- OVERVIEW -->
<div class="card" id="overview" style="display:none">
  <h2>ğŸ“Š Ãœbersicht</h2>

  <div class="row">
    <div>
      <div class="muted">ğŸ§­ Modus</div>
      <select id="mode">
        <option value="week">Woche</option>
        <option value="month">Monat</option>
        <option value="year">Jahr</option>
      </select>
    </div>

    <div>
      <div class="muted">ğŸ“Œ Datum</div>
      <input type="date" id="refDate">
    </div>

    <div>
      <div class="muted">ğŸ¯ Wochen-Soll</div>
      <select id="weeklyTarget">
        <option value="2400">40:00 ğŸ‡©ğŸ‡ª</option>
        <option value="2310">38:30 ğŸ‡¦ğŸ‡¹</option>
      </select>
    </div>

    <button class="btn-ghost" id="btnRefresh">â†»</button>
    <button class="btn-blue" id="btnCSV">â¬‡ï¸ CSV</button>
    <button class="btn-ghost" id="btnShare">ğŸ“¤ Teilen</button>

    <span class="right muted mono" id="yearHint"></span>
  </div>

  <div style="margin-top:10px">
    <span class="pill ok" id="sumPill">â€”</span>
    <span class="pill" id="avgPill" style="display:none;margin-left:6px">â€”</span>
  </div>

  <div style="margin-top:12px">
    <h2>ğŸ‘” Manager</h2>
    <div class="stack">
      <div class="muted">Name</div>
      <input id="mgrName" class="w-mgr-name" placeholder="Name">
      <div class="muted">E-Mail</div>
      <input id="mgrMail" class="w-mgr-mail" placeholder="vorname.nachname@firma.de">
      <button class="btn-ghost w-save" id="saveMgr">ğŸ’¾ Speichern</button>
    </div>
  </div>

  <div id="overviewTable" style="margin-top:12px"></div>
</div>

<!-- EDIT -->
<div class="card" id="edit" style="display:none">
  <h2>âœï¸ RÃ¼ckwirkend</h2>
  <div class="row">
    <div><div class="muted">ğŸ“… Datum</div><input type="date" id="eDate"></div>
    <div><div class="muted">ğŸŸ¢ Start</div><input type="time" id="eStart"></div>
    <div><div class="muted">ğŸ”´ Ende</div><input type="time" id="eEnd"></div>
    <div><div class="muted">ğŸ“ Notiz</div><input id="eNote" class="w-note"></div>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn-ghost" id="saveManual">ğŸ’¾ Speichern</button>
    <button class="btn-ghost" id="newManual">ğŸ§½ Neu</button>
    <span class="right muted mono" id="editMsg"></span>
  </div>
</div>

<!-- ABSENCE -->
<div class="card" id="absence" style="display:none">
  <h2>ğŸ–ï¸ Abwesenheit</h2>
  <div class="row">
    <div><div class="muted">ğŸ“… Datum</div><input type="date" id="aDate"></div>
    <div>
      <div class="muted">ğŸ·ï¸ Typ</div>
      <select id="aType">
        <option value="vac">Urlaub</option>
        <option value="sick">Krank</option>
        <option value="hol">Feiertag</option>
      </select>
    </div>
    <button class="btn-ghost" id="addAbs">â• Speichern</button>
  </div>
  <div id="absList" style="margin-top:12px"></div>
</div>

<!-- ENTRIES -->
<div class="card" id="entries" style="display:none">
  <h2>ğŸ§¾ EintrÃ¤ge</h2>
  <div class="muted">âœï¸ bearbeiten Â· ğŸ—‘ï¸ lÃ¶schen</div>
  <div id="entryList" style="margin-top:10px"></div>
</div>

<!-- SETTINGS -->
<div class="card" id="settings" style="display:none">
  <h2>âš™ï¸ Settings</h2>
  <div class="muted">
    Offline: Daten liegen im Browser (pro Jahr getrennt). Wenn du viel am Code Ã¤nderst, kann Reset helfen.
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn-stop" id="btnResetThisYear">ğŸ§¹ Aktuelles Jahr lÃ¶schen</button>
    <button class="btn-ghost" id="btnResetAll">ğŸ§¨ Alle Jahre lÃ¶schen</button>
  </div>
  <div class="muted" style="margin-top:8px">
    Hinweis: â€Aktuelles Jahrâ€œ = Jahr vom ğŸ“Œ Datum in der Ãœbersicht.
  </div>
</div>

<script>
(() => {
  const NS="ZEITERFASSUNG";
  const AUTO_BREAK=55;          // Auto-Pause Minuten
  const TOL=10*60;              // Â±10h Ampel (Minuten)

  const $=id=>document.getElementById(id);
  const pad=n=>String(n).padStart(2,"0");

  const hhmm=(m)=>{
    if(!Number.isFinite(m)) return "--:--";
    const s=m<0?"-":"";
    m=Math.abs(Math.round(m));
    return s + pad(Math.floor(m/60)) + ":" + pad(m%60);
  };

  const d0=(s)=>{ const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); };
  const wd=(d)=> d.getDay()>=1 && d.getDay()<=5;
  const toDateStr=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function isoWeekKey(dateObj){
    const d=new Date(dateObj); d.setHours(0,0,0,0);
    d.setDate(d.getDate()+3-((d.getDay()+6)%7));
    const y=d.getFullYear();
    const week1=new Date(y,0,4); week1.setHours(0,0,0,0);
    week1.setDate(week1.getDate()+3-((week1.getDay()+6)%7));
    const w=1+Math.round((d-week1)/(7*24*60*60*1000));
    return `${y}-W${pad(w)}`;
  }
  function weekRangeISO(ref){
    const d=new Date(ref); d.setHours(0,0,0,0);
    const monIndex=(d.getDay()+6)%7;
    const start=new Date(d); start.setDate(d.getDate()-monIndex);
    const end=new Date(start); end.setDate(start.getDate()+6);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function monthRange(ref){
    const d=new Date(ref);
    const start=new Date(d.getFullYear(),d.getMonth(),1);
    const end=new Date(d.getFullYear(),d.getMonth()+1,0);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function yearRange(y){
    const start=new Date(y,0,1); start.setHours(0,0,0,0);
    const end=new Date(y,11,31); end.setHours(0,0,0,0);
    return [start,end];
  }

  function absLabel(t){
    if(t==="vac") return "Urlaub";
    if(t==="sick") return "Krank";
    if(t==="hol") return "Feiertag";
    return t;
  }

  function getWeeklyTargetMinutes(){
    const el=$("weeklyTarget");
    const v=el ? Number(el.value) : NaN;
    return (Number.isFinite(v) && v>0) ? v : 2400; // Fallback 40h
  }

  // State
  let Y=new Date().getFullYear();
  let S={emp:"",mgr:{name:"",mail:""},E:[],A:[]};
  let run=null;
  let editingId=null;

  const key=(y)=>NS+"::"+y;

  function load(y){
    Y=y;
    S=JSON.parse(localStorage.getItem(key(y))||'{"emp":"","mgr":{"name":"","mail":""},"E":[],"A":[]}');
    $("empName").value=S.emp||"";
    $("mgrName").value=S.mgr?.name||"";
    $("mgrMail").value=S.mgr?.mail||"";
  }
  function save(){ localStorage.setItem(key(Y),JSON.stringify(S)); }

  function tab(name){
    ["timer","overview","edit","absence","entries","settings"].forEach(id=>{
      $(id).style.display = (id===name) ? "" : "none";
    });
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===name));
  }
  document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>tab(t.dataset.tab));

  function setTimerStatus(txt,cls){
    $("timerStatus").textContent=txt;
    $("timerStatus").className="pill"+(cls?(" "+cls):"");
  }

  // âœ… Jahr & Referenz zusammengelegt:
  // refDate bestimmt das Jahr => automatisch laden
  function ensureYearFromRef(){
    const v=$("refDate").value;
    if(!v) return;
    const yr=d0(v).getFullYear();
    if(yr!==Y){
      // Auto-switch year store
      load(yr);
    }
    $("yearHint").textContent = `ğŸ“¦ Jahr: ${Y}`;
  }

  // Buttons: Name
  $("saveName").onclick=()=>{
    S.emp=$("empName").value.trim();
    save();
    $("nameMsg").textContent = S.emp ? "âœ… gespeichert" : "âš ï¸ fehlt";
    $("timerMini").textContent = S.emp ? ("ğŸ‘¤ "+S.emp) : "";
  };

  $("saveMgr").onclick=()=>{
    S.mgr={name:$("mgrName").value.trim(), mail:$("mgrMail").value.trim()};
    save();
    alert("âœ… Manager gespeichert");
  };

  // Timer
  $("btnStart").onclick=()=>{
    if(run) return alert("Timer lÃ¤uft schon.");
    if(!S.emp) return alert("Bitte Name speichern.");
    if(!$("timerDate").value) return alert("Bitte Datum wÃ¤hlen.");

    const now=new Date(); now.setSeconds(0,0);
    const d=d0($("timerDate").value);
    const start=new Date(d.getFullYear(),d.getMonth(),d.getDate(),now.getHours(),now.getMinutes(),0,0);

    run={date:$("timerDate").value, start, pauseMin:0, pauseStart:null, note:($("timerNote").value||"").trim()};
    $("btnPause").disabled=false;
    $("btnPause").textContent="â¸ï¸ Pause";
    setTimerStatus("ğŸŸ¢ lÃ¤uft","ok");
    $("timerInfo").textContent=`Start ${pad(start.getHours())}:${pad(start.getMinutes())}`;
  };

  $("btnPause").onclick=()=>{
    if(!run) return;
    const now=new Date(); now.setSeconds(0,0);
    if(!run.pauseStart){
      run.pauseStart=now;
      $("btnPause").textContent="â–¶ï¸ Weiter";
      setTimerStatus("â¸ï¸ Pause","warn");
    } else {
      run.pauseMin += Math.max(0, Math.round((now-run.pauseStart)/60000));
      run.pauseStart=null;
      $("btnPause").textContent="â¸ï¸ Pause";
      setTimerStatus("ğŸŸ¢ lÃ¤uft","ok");
    }
  };

  $("btnStop").onclick=()=>{
    if(!run) return alert("Kein Timer lÃ¤uft.");
    const end=new Date(); end.setSeconds(0,0);

    if(run.pauseStart){
      run.pauseMin += Math.max(0, Math.round((end-run.pauseStart)/60000));
      run.pauseStart=null;
    }

    const gross=Math.round((end-run.start)/60000);
    if(gross<=0) return alert("Zeit ungÃ¼ltig.");

    const auto = gross>=AUTO_BREAK ? AUTO_BREAK : 0;
    const pause = auto + run.pauseMin;

    // Speichere in "Jahr" des Timer-Datums
    const entryYear=d0(run.date).getFullYear();
    if(entryYear!==Y){
      load(entryYear);
    }

    S.E.push({
      id: (crypto.randomUUID ? crypto.randomUUID() : ("id_"+Date.now())),
      d: run.date,
      s: run.start.toISOString(),
      e: end.toISOString(),
      p: pause,
      n: run.note || ""
    });

    run=null;
    $("btnPause").disabled=true;
    $("btnPause").textContent="â¸ï¸ Pause";
    setTimerStatus("âšª bereit","");
    $("timerInfo").textContent="âœ… gespeichert";
    save();
    renderAll();
  };

  // Absence
  $("addAbs").onclick=()=>{
    if(!$("aDate").value) return alert("Datum fehlt.");
    const yr=d0($("aDate").value).getFullYear();
    if(yr!==Y) load(yr);
    S.A.push({id:(crypto.randomUUID?crypto.randomUUID():"a_"+Date.now()), d:$("aDate").value, t:$("aType").value});
    save(); renderAll();
  };

  // Edit
  $("newManual").onclick=()=>{
    editingId=null;
    $("eStart").value=""; $("eEnd").value=""; $("eNote").value="";
    $("editMsg").textContent="";
  };

  $("saveManual").onclick=()=>{
    if(!$("eDate").value||!$("eStart").value||!$("eEnd").value) return;

    const d=$("eDate").value;
    const [sh,sm]=$("eStart").value.split(":").map(Number);
    const [eh,em]=$("eEnd").value.split(":").map(Number);
    const s=new Date(d0(d).setHours(sh,sm,0,0));
    const e=new Date(d0(d).setHours(eh,em,0,0));
    const gross=Math.round((e-s)/60000);
    if(gross<=0){ $("editMsg").textContent="âš ï¸ Ende muss nach Start"; return; }

    const yr=d0(d).getFullYear();
    if(yr!==Y) load(yr);

    const obj={
      id: editingId || (crypto.randomUUID?crypto.randomUUID():"m_"+Date.now()),
      d, s:s.toISOString(), e:e.toISOString(),
      p:(gross>=AUTO_BREAK?AUTO_BREAK:0),
      n:($("eNote").value||"").trim()
    };

    if(editingId){
      const idx=S.E.findIndex(x=>x.id===editingId);
      if(idx>=0) S.E[idx]=obj; else S.E.push(obj);
      $("editMsg").textContent="âœ… aktualisiert";
    } else {
      S.E.push(obj);
      editingId=obj.id;
      $("editMsg").textContent="âœ… gespeichert";
    }
    save(); renderAll();
  };

  // Settings reset
  $("btnResetThisYear").onclick=()=>{
    // aktuelles Jahr = Jahr der refDate (wenn gesetzt), sonst Y
    const v=$("refDate").value;
    const yr=v ? d0(v).getFullYear() : Y;
    if(confirm(`Wirklich alle Daten fÃ¼r ${yr} lÃ¶schen?`)){
      localStorage.removeItem(key(yr));
      if(yr===Y) load(Y);
      renderAll();
      alert("âœ… Jahr gelÃ¶scht");
    }
  };
  $("btnResetAll").onclick=()=>{
    if(confirm("Wirklich ALLE Jahre lÃ¶schen?")){
      // Nur Keys lÃ¶schen, die zu dieser App gehÃ¶ren
      const del=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k && k.startsWith(NS+"::")) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      load(new Date().getFullYear());
      renderAll();
      alert("âœ… Alles gelÃ¶scht");
    }
  };

  // CSV/Share: exportiert den aktuell angezeigten Zeitraum (refDate+mode)
  function buildCSV(){
    const sep=";";
    const W=getWeeklyTargetMinutes();
    const emp=S.emp||"";
    const rows=[];
    rows.push(["Mitarbeiter","Jahr","WochenSoll_min","Datum","Start","Ende","Pause_min","Netto_min","Netto_hhmm","Notiz"].join(sep));

    const v=$("refDate").value;
    const ref=v ? d0(v) : new Date();
    const yr=ref.getFullYear();
    if(yr!==Y) load(yr); // exportiert das Jahr des Ref-Datums

    let start,end;
    if($("mode").value==="year") [start,end]=yearRange(yr);
    else if($("mode").value==="month") [start,end]=monthRange(ref);
    else [start,end]=weekRangeISO(ref);

    const inRangeStr=(ds)=> ds>=toDateStr(start) && ds<=toDateStr(end);

    const entries=S.E.filter(e=>inRangeStr(e.d)).sort((a,b)=>a.d.localeCompare(b.d));
    for(const e of entries){
      const net=((new Date(e.e)-new Date(e.s))/60000) - (e.p||0);
      rows.push([
        emp,String(yr),String(W),
        e.d,e.s,e.e,String(e.p||0),
        Number.isFinite(net)?String(Math.round(net)):"",
        hhmm(net),
        (e.n||"").replaceAll(";",",")
      ].join(sep));
    }
    const abs=S.A.filter(a=>inRangeStr(a.d)).sort((a,b)=>a.d.localeCompare(b.d));
    for(const a of abs){
      rows.push([emp,String(yr),String(W),a.d,"","","0","0","00:00",absLabel(a.t)].join(sep));
    }
    save();
    return rows.join("\n");
  }

  function downloadCSV(){
    if(!S.emp) return alert("Bitte Name speichern.");
    const csv=buildCSV();
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`Zeiterfassung_${$("refDate").value||Y}_${S.emp.replaceAll(" ","_")}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  async function shareCSV(){
    if(!S.emp) return alert("Bitte Name speichern.");
    const csv=buildCSV();
    const file=new File([new Blob([csv],{type:"text/csv"})], `zeiterfassung.csv`, {type:"text/csv"});
    const title=`Zeiterfassung â€“ ${S.emp}`;
    const text=`Zeiterfassung\nMitarbeiter: ${S.emp}\nManager: ${(S.mgr.name||"")} ${(S.mgr.mail||"")}`.trim();

    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title,text,files:[file]});
      return;
    }
    alert("Teilen nicht verfÃ¼gbar. Bitte CSV herunterladen und manuell senden.");
  }

  $("btnCSV").onclick=downloadCSV;
  $("btnShare").onclick=shareCSV;

  // Rendering
  function renderAbsList(){
    if(!S.A.length){ $("absList").innerHTML=`<div class="muted">Keine Abwesenheiten.</div>`; return; }
    const rows=S.A.slice().sort((a,b)=>b.d.localeCompare(a.d)).map(a=>`
      <tr>
        <td class="mono">${a.d}</td>
        <td>${absLabel(a.t)}</td>
        <td><button class="btn-ghost btn-sm" data-del-abs="${a.id}">ğŸ—‘ï¸</button></td>
      </tr>`).join("");
    $("absList").innerHTML=`<table><thead><tr><th>Datum</th><th>Typ</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
    document.querySelectorAll("[data-del-abs]").forEach(b=>{
      b.onclick=()=>{
        const id=b.getAttribute("data-del-abs");
        S.A=S.A.filter(x=>x.id!==id);
        save(); renderAll();
      };
    });
  }

  function renderEntryList(){
    const entries=S.E.slice().sort((a,b)=>b.d.localeCompare(a.d));
    if(!entries.length){ $("entryList").innerHTML=`<div class="muted">Noch keine EintrÃ¤ge.</div>`; return; }

    const rows=entries.map(e=>{
      const net = ((new Date(e.e)-new Date(e.s))/60000) - (e.p||0);
      const netTxt = hhmm(net);
      const bad = (netTxt==="--:--") ? ` <span class="pill bad">âš ï¸</span>` : "";
      return `
        <tr>
          <td class="mono">${e.d}</td>
          <td class="mono">Netto ${netTxt}${bad} Â· Pause ${hhmm(e.p||0)} Â· ${e.n||""}</td>
          <td>
            <button class="btn-ghost btn-sm" data-edit="${e.id}">âœï¸</button>
            <button class="btn-ghost btn-sm" data-del="${e.id}">ğŸ—‘ï¸</button>
          </td>
        </tr>`;
    }).join("");

    $("entryList").innerHTML=`<table><thead><tr><th>Datum</th><th>Info</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;

    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const id=b.getAttribute("data-del");
        S.E=S.E.filter(x=>x.id!==id);
        save(); renderAll();
      };
    });
    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const id=b.getAttribute("data-edit");
        const e=S.E.find(x=>x.id===id);
        if(!e) return;
        editingId=id;
        $("eDate").value=e.d;
        const s=new Date(e.s), en=new Date(e.e);
        $("eStart").value=`${pad(s.getHours())}:${pad(s.getMinutes())}`;
        $("eEnd").value=`${pad(en.getHours())}:${pad(en.getMinutes())}`;
        $("eNote").value=e.n||"";
        $("editMsg").textContent="Bearbeiten aktiv";
        tab("edit");
      };
    });
  }

  function renderOverviewTable(){
    ensureYearFromRef(); // lÃ¤dt automatisch das Jahr des Ref-Datums

    const W=getWeeklyTargetMinutes();
    const DAY=W/5;

    const v=$("refDate").value;
    const ref=v ? d0(v) : new Date();
    const yr=ref.getFullYear();
    $("yearHint").textContent = `ğŸ“¦ Jahr: ${yr}`;

    let start,end;
    if($("mode").value==="year") [start,end]=yearRange(yr);
    else if($("mode").value==="month") [start,end]=monthRange(ref);
    else [start,end]=weekRangeISO(ref);

    const istBy={};
    for(const e of S.E){
      if(e.d < toDateStr(start) || e.d > toDateStr(end)) continue;
      const net=((new Date(e.e)-new Date(e.s))/60000) - (e.p||0);
      if(!Number.isFinite(net)) continue;
      istBy[e.d]=(istBy[e.d]||0)+Math.round(net);
    }

    const dayNames=["So","Mo","Di","Mi","Do","Fr","Sa"];
    let istSum=0, sollSum=0;

    let html=`<table><thead><tr>
      <th>Datum</th><th>Tag</th><th>IST</th><th>SOLL</th><th>Abw.</th><th>SALDO</th>
    </tr></thead><tbody>`;

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const ds=toDateStr(d);
      const ist=Number.isFinite(istBy[ds]) ? istBy[ds] : 0;
      const isW=wd(d);
      const abs=S.A.filter(a=>a.d===ds).map(a=>absLabel(a.t));
      const absMinus = (isW && abs.length>0) ? DAY : 0;
      const soll=Math.round(isW ? (DAY-absMinus) : 0);
      const saldo=ist-soll;

      istSum += ist;
      sollSum += soll;

      const clsRow = (Math.abs(saldo) > TOL) ? "bad" : (Math.abs(saldo) > 1 ? "warn" : "ok");

      html+=`<tr class="${clsRow}">
        <td class="mono">${ds}</td>
        <td>${dayNames[d.getDay()]}</td>
        <td class="mono">${hhmm(ist)}</td>
        <td class="mono">${hhmm(soll)}</td>
        <td>${abs.join(", ")}</td>
        <td class="mono">${hhmm(saldo)}</td>
      </tr>`;
    }
    html+=`</tbody></table>`;
    $("overviewTable").innerHTML=html;

    const delta=istSum-sollSum;
    const cls=(Math.abs(delta)>TOL)?"bad":(Math.abs(delta)>1?"warn":"ok");
    $("sumPill").className="pill "+cls;
    $("sumPill").textContent=`IST ${hhmm(istSum)} Â· SOLL ${hhmm(sollSum)} Â· SALDO ${hhmm(delta)}`;

    // Monats-Ã˜/Woche
    if($("mode").value==="month"){
      const weeks=new Map();
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const ds=toDateStr(d);
        const wk=isoWeekKey(d);
        if(!weeks.has(wk)) weeks.set(wk,{ist:0,weekdays:0,absWeekdays:0});
        const b=weeks.get(wk);
        b.ist += (istBy[ds]||0);
        if(wd(d)){
          b.weekdays += 1;
          if(S.A.some(a=>a.d===ds)) b.absWeekdays += 1;
        }
      }
      const active=[...weeks.values()].filter(w=>w.weekdays>0);
      const avgIst = active.length ? active.map(w=>w.ist*(5/w.weekdays)).reduce((s,v)=>s+v,0)/active.length : 0;
      const avgSoll= active.length ? active.map(w=>W-(w.absWeekdays*DAY)).reduce((s,v)=>s+v,0)/active.length : W;
      const dAvg=avgIst-avgSoll;
      const clsAvg=(Math.abs(dAvg)>TOL)?"bad":(Math.abs(dAvg)>1?"warn":"ok");
      $("avgPill").style.display="";
      $("avgPill").className="pill "+clsAvg;
      $("avgPill").textContent=`Ã˜/Woche ${hhmm(avgIst)} (Soll ${hhmm(avgSoll)})`;
    } else {
      $("avgPill").style.display="none";
    }
  }

  function renderAll(){
    $("timerMini").textContent = S.emp ? ("ğŸ‘¤ "+S.emp) : "";
    $("nameMsg").textContent = S.emp ? "âœ… gespeichert" : "";
    renderOverviewTable();
    renderAbsList();
    renderEntryList();
    save();
  }

  // Wiring
  $("btnRefresh").onclick=renderAll;
  $("mode").onchange=renderAll;
  $("weeklyTarget").onchange=renderAll;

  $("refDate").onchange=()=>{
    ensureYearFromRef();
    renderAll();
  };

  // Init
  const today=new Date().toISOString().slice(0,10);
  $("timerDate").value = today;
  $("refDate").value   = today;
  $("eDate").value     = today;
  $("aDate").value     = today;

  load(new Date().getFullYear());
  $("btnPause").disabled=true;
  setTimerStatus("âšª bereit","");
  renderAll();
  tab("timer");
})();
</script>

</body>
</html>
