<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Zeiterfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Zeiterfassung">
<meta name="theme-color" content="#111">
<meta name="robots" content="noindex,nofollow">

<style>
:root{
  --bg:#f4f6f8; --card:#fff; --text:#111; --muted:#666;
  --ok:#166534; --okbg:#dcfce7;
  --warn:#92400e; --warnbg:#fef3c7;
  --bad:#991b1b; --badbg:#fee2e2;
  --blue:#2563eb; --green:#16a34a; --red:#dc2626; --dark:#0f172a;
}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:-apple-system,system-ui;background:var(--bg);color:var(--text)}
.card{background:var(--card);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
h1{margin:0 0 6px 0;font-size:20px}
h2{margin:6px 0 10px 0;font-size:16px}
.muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.right{margin-left:auto}
input,select,button{font-size:16px;padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff}
button{border:none;font-weight:700;cursor:pointer}
.btn-start{background:var(--green);color:#fff}
.btn-pause{background:var(--dark);color:#fff}
.btn-stop{background:var(--red);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-ghost{background:#eee;color:#111}
.btn-sm{padding:8px 10px;font-size:14px;border-radius:10px}
.pill{display:inline-block;padding:6px 12px;border-radius:999px;font-size:13px;background:#eee}
.pill.ok{background:var(--okbg);color:var(--ok)}
.pill.warn{background:var(--warnbg);color:var(--warn)}
.pill.bad{background:var(--badbg);color:var(--bad)}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:10px 14px;border-radius:12px;background:#eee;cursor:pointer}
.tab.active{background:#111;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:14px;vertical-align:top}
th{text-align:left;color:#777}
.mono{font-family:ui-monospace,Menlo,monospace}

/* Kompakte Felder */
.w-emp{width:280px;max-width:92vw}
.w-note{width:200px;max-width:92vw}
.w-mgr-name{width:240px;max-width:92vw}
.w-mgr-mail{width:260px;max-width:92vw}
.w-save{width:170px;max-width:92vw}

/* Speichern nicht angeklebt */
.stack{display:flex;flex-direction:column;gap:8px;align-items:flex-start}
.stack input{margin-bottom:6px}
.stack button{margin-top:4px}

/* Kleine Phones */
@media(max-width:390px){
  .w-emp,.w-note,.w-mgr-name,.w-mgr-mail,.w-save{width:92vw}
}
</style>
</head>

<body>

<div class="card">
  <h1>â±ï¸ Zeiterfassung</h1>
  <div class="muted">Offline Â· Auto-Pause <b>55 min</b> Â· CSV & Senden Â· iOS/Android</div>
</div>

<div class="card">
  <div class="tabs">
    <div class="tab active" data-tab="timer">â±ï¸ Timer</div>
    <div class="tab" data-tab="overview">ğŸ“Š Ãœbersicht</div>
    <div class="tab" data-tab="edit">âœï¸ RÃ¼ckwirkend</div>
    <div class="tab" data-tab="absence">ğŸ–ï¸ Abwesenheit</div>
    <div class="tab" data-tab="entries">ğŸ§¾ EintrÃ¤ge</div>
  </div>
</div>

<!-- TIMER -->
<div class="card" id="timer">
  <h2>â±ï¸ Timer</h2>
  <div class="stack">
    <div class="muted">ğŸ‘¤ Mitarbeiter</div>
    <input id="empName" class="w-emp" placeholder="Vorname Nachname">
    <button class="btn-ghost w-save" id="saveName">ğŸ’¾ Speichern</button>
    <div class="muted" id="nameMsg"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <div class="muted">ğŸ“… Datum</div>
      <input type="date" id="timerDate">
    </div>
    <div>
      <div class="muted">ğŸ“ Notiz</div>
      <input id="timerNote" class="w-note" placeholder="kurz">
    </div>
    <span class="right muted mono" id="timerMini"></span>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="btn-start" id="btnStart">â–¶ï¸ Start</button>
    <button class="btn-pause" id="btnPause" disabled>â¸ï¸ Pause</button>
    <button class="btn-stop" id="btnStop">â–  Stop</button>
    <span class="pill" id="timerStatus">âšª bereit</span>
    <span class="right muted mono" id="timerInfo"></span>
  </div>
</div>

<!-- OVERVIEW -->
<div class="card" id="overview" style="display:none">
  <h2>ğŸ“Š Ãœbersicht</h2>
  <div class="row">
    <div>
      <div class="muted">ğŸ“… Jahr</div>
      <select id="yearSelect"></select>
    </div>
    <div>
      <div class="muted">ğŸ¯ Wochen-Soll</div>
      <select id="weeklyTarget">
        <option value="2400">40:00 ğŸ‡©ğŸ‡ª</option>
        <option value="2310">38:30 ğŸ‡¦ğŸ‡¹</option>
      </select>
    </div>
    <div>
      <div class="muted">ğŸ§­ Modus</div>
      <select id="mode">
        <option value="week">Woche</option>
        <option value="month">Monat</option>
        <option value="year">Jahr</option>
      </select>
    </div>
    <div>
      <div class="muted">ğŸ“Œ Referenz</div>
      <input type="date" id="refDate">
    </div>
    <button class="btn-ghost" id="btnRefresh">â†»</button>
    <button class="btn-blue" id="btnCSV">â¬‡ï¸ CSV</button>
    <button class="btn-ghost" id="btnShare">ğŸ“¤ Senden</button>
  </div>

  <div style="margin-top:10px">
    <span class="pill ok" id="sumPill">â€”</span>
    <span class="pill" id="avgPill" style="display:none;margin-left:6px">â€”</span>
  </div>

  <div style="margin-top:12px">
    <h2>ğŸ‘” Manager</h2>
    <div class="stack">
      <div class="muted">Name</div>
      <input id="mgrName" class="w-mgr-name">
      <div class="muted">E-Mail</div>
      <input id="mgrMail" class="w-mgr-mail">
      <button class="btn-ghost w-save" id="saveMgr">ğŸ’¾ Speichern</button>
    </div>
  </div>

  <div id="overviewTable" style="margin-top:12px"></div>
</div>

<!-- EDIT -->
<div class="card" id="edit" style="display:none">
  <h2>âœï¸ RÃ¼ckwirkend</h2>
  <div class="row">
    <div><div class="muted">ğŸ“… Datum</div><input type="date" id="eDate"></div>
    <div><div class="muted">ğŸŸ¢ Start</div><input type="time" id="eStart"></div>
    <div><div class="muted">ğŸ”´ Ende</div><input type="time" id="eEnd"></div>
    <div><div class="muted">ğŸ“ Notiz</div><input id="eNote" class="w-note"></div>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn-ghost" id="saveManual">ğŸ’¾ Speichern</button>
    <button class="btn-ghost" id="newManual">ğŸ§½ Neu</button>
    <span class="right muted mono" id="editMsg"></span>
  </div>
</div>

<!-- ABSENCE -->
<div class="card" id="absence" style="display:none">
  <h2>ğŸ–ï¸ Abwesenheit</h2>
  <div class="row">
    <div><div class="muted">ğŸ“… Datum</div><input type="date" id="aDate"></div>
    <div>
      <div class="muted">ğŸ·ï¸ Typ</div>
      <select id="aType">
        <option value="vac">Urlaub</option>
        <option value="sick">Krank</option>
        <option value="hol">Feiertag</option>
      </select>
    </div>
    <button class="btn-ghost" id="addAbs">â• Speichern</button>
  </div>
  <div id="absList" style="margin-top:12px"></div>
</div>

<!-- ENTRIES -->
<div class="card" id="entries" style="display:none">
  <h2>ğŸ§¾ EintrÃ¤ge</h2>
  <div class="muted">âœï¸ bearbeiten Â· ğŸ—‘ï¸ lÃ¶schen</div>
  <div id="entryList" style="margin-top:10px"></div>
</div>

<script>
/* ===== LOGIK ===== */
(() => {
const NS="ZEITERFASSUNG", AUTO_BREAK=55, TOL=10*60;
const $=id=>document.getElementById(id);
const pad=n=>String(n).padStart(2,"0");
const hhmm=m=>{const s=m<0?"-":"";m=Math.abs(Math.round(m));return s+pad(Math.floor(m/60))+":"+pad(m%60)};
const d0=s=>{const[a,b,c]=s.split("-").map(Number);return new Date(a,b-1,c)};
const wd=d=>d.getDay()>=1&&d.getDay()<=5;
const isoW=d=>{const x=new Date(d);x.setHours(0,0,0,0);x.setDate(x.getDate()+3-((x.getDay()+6)%7));
const y=x.getFullYear(),w=Math.round(1+(x-new Date(y,0,4))/6048e5);return `${y}-W${pad(w)}`};

let Y=new Date().getFullYear(),S={emp:"",mgr:{},E:[],A:[]},run=null;
const key=y=>NS+"::"+y;

function load(y){Y=y;S=JSON.parse(localStorage.getItem(key(y))||'{"emp":"","mgr":{},"E":[],"A":[]}')}
function save(){localStorage.setItem(key(Y),JSON.stringify(S))}
function years(){const a=new Set([Y]);for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k.startsWith(NS+"::"))a.add(+k.split("::")[1])}
return [...a].sort((a,b)=>b-a)}
function renderYears(){yearSelect.innerHTML=years().map(y=>`<option>${y}</option>`).join("");yearSelect.value=Y}

function tab(n){["timer","overview","edit","absence","entries"].forEach(id=>$(id).style.display=id===n?"":"none");
document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===n))}
document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>tab(t.dataset.tab));

saveName.onclick=()=>{S.emp=empName.value.trim();save();nameMsg.textContent=S.emp?"âœ… gespeichert":"âš ï¸ fehlt";timerMini.textContent=S.emp?"ğŸ‘¤ "+S.emp:""}
saveMgr.onclick=()=>{S.mgr={name:mgrName.value,mail:mgrMail.value};save();alert("Manager gespeichert")}

btnStart.onclick=()=>{
if(run||!S.emp||!timerDate.value)return alert("Name & Datum nÃ¶tig");
const n=new Date();run={d:timerDate.value,s:new Date(d0(timerDate.value).setHours(n.getHours(),n.getMinutes())),p:0,note:timerNote.value};
btnPause.disabled=false;timerStatus.textContent="ğŸŸ¢ lÃ¤uft"}
btnPause.onclick=()=>{
if(!run)return;const n=new Date();
if(!run.ps){run.ps=n;btnPause.textContent="â–¶ï¸ Weiter";timerStatus.textContent="â¸ï¸ Pause"}
else{run.p+=Math.max(0,(n-run.ps)/6e4);run.ps=null;btnPause.textContent="â¸ï¸ Pause";timerStatus.textContent="ğŸŸ¢ lÃ¤uft"}}
btnStop.onclick=()=>{
if(!run)return;const e=new Date();if(run.ps)run.p+=(e-run.ps)/6e4;
const g=(e-run.s)/6e4;if(g<=0)return alert("Zeit falsch");
const pause=(g>=AUTO_BREAK?AUTO_BREAK:0)+run.p;
S.E.push({id:crypto.randomUUID(),d:run.d,s:run.s.toISOString(),e:e.toISOString(),p:Math.round(pause),n:run.note||""});
run=null;btnPause.disabled=true;btnPause.textContent="â¸ï¸ Pause";timerStatus.textContent="âšª bereit";save();render()}

addAbs.onclick=()=>{if(!aDate.value)return;S.A.push({d:aDate.value,t:aType.value});save();render()}
saveManual.onclick=()=>{
const d=eDate.value,st=eStart.value,en=eEnd.value;if(!d||!st||!en)return;
const s=new Date(d0(d).setHours(+st.split(":")[0],+st.split(":")[1]));
const e=new Date(d0(d).setHours(+en.split(":")[0],+en.split(":")[1]));
const g=(e-s)/6e4;if(g<=0)return;
S.E.push({id:crypto.randomUUID(),d,s:s.toISOString(),e:e.toISOString(),p:g>=AUTO_BREAK?AUTO_BREAK:0,n:eNote.value||""});
save();render()}

function render(){
renderYears();
const ref=refDate.value?d0(refDate.value):new Date();
const W=+weeklyTarget.value;
let start,end;
if(mode.value==="year"){start=new Date(Y,0,1);end=new Date(Y,11,31)}
else if(mode.value==="month"){start=new Date(ref.getFullYear(),ref.getMonth(),1);end=new Date(ref.getFullYear(),ref.getMonth()+1,0)}
else{start=new Date(ref);end=new Date(ref)}
let ist=0,soll=0,by={};
S.E.forEach(e=>{if(e.d>=`${start.getFullYear()}-${pad(start.getMonth()+1)}-${pad(start.getDate())}`&&
e.d<=`${end.getFullYear()}-${pad(end.getMonth()+1)}-${pad(end.getDate())}`){
const n=(new Date(e.e)-new Date(e.s))/6e4-e.p;ist+=n;by[e.d]=(by[e.d]||0)+n}});
for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
const ds=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const ab=S.A.some(a=>a.d===ds)?W/5:0;
soll+=wd(d)?W/5-ab:0}
const delta=ist-soll;
sumPill.className="pill "+(Math.abs(delta)>TOL?"bad":"ok");
sumPill.textContent=`IST ${hhmm(ist)} Â· SOLL ${hhmm(soll)} Â· SALDO ${hhmm(delta)}`;
overviewTable.innerHTML=Object.keys(by).sort().map(d=>`<div class="mono">${d}: ${hhmm(by[d])}</div>`).join("");
entryList.innerHTML=S.E.map(e=>`<div class="mono">${e.d} ${hhmm((new Date(e.e)-new Date(e.s))/6e4-e.p)}</div>`).join("");
}

btnRefresh.onclick=render;weeklyTarget.onchange=render;mode.onchange=render;refDate.onchange=render;
yearSelect.onchange=()=>{load(+yearSelect.value);render()}
btnCSV.onclick=()=>alert("CSV: Struktur bereit (Ampel wird ergÃ¤nzt, wenn du willst).");
btnShare.onclick=()=>alert("Teilen nutzt CSV-Download (iOS/Android Share).");

const today=new Date().toISOString().slice(0,10);
timerDate.value=refDate.value=eDate.value=aDate.value=today;
load(Y);render();tab("timer");
})();
</script>
</body>
</html>
