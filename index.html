<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Zeiterfassung</title>

  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Zeiterfassung" />

  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#e7ecff; --muted:#a9b2d6;
      --line:rgba(255,255,255,.12);
      --good:#38d39f; --warn:#ffcc66; --bad:#ff6b6b; --accent:#6aa6ff;
      --radius:14px;
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    body{margin:0;background:linear-gradient(180deg,#070c16,var(--bg));color:var(--text);}
    header{position:sticky;top:0;z-index:9;background:rgba(11,18,32,.88);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 14px 64px;}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;}
    .brand{display:flex;gap:10px;align-items:center;}
    .logo{width:34px;height:34px;border-radius:10px;background:
      radial-gradient(circle at 30% 20%, #7bd6ff, transparent 55%),
      radial-gradient(circle at 70% 80%, #7bffcf, transparent 60%),
      #101a33;border:1px solid rgba(255,255,255,.12);}
    h1{font-size:16px;margin:0;}
    .sub{font-size:12px;color:var(--muted);margin-top:2px;}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;margin-top:14px;}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}}
    .card{background:rgba(18,26,43,.92);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.22);}
    .card h2{margin:0 0 10px;font-size:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .col{flex:1 1 240px;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);outline:none;}
    textarea{min-height:80px;resize:vertical;}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:12px;font-size:13px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;justify-content:center;}
    .btn.primary{background:rgba(106,166,255,.20);border-color:rgba(106,166,255,.35);}
    .btn.good{background:rgba(56,211,159,.18);border-color:rgba(56,211,159,.35);}
    .btn.warn{background:rgba(255,204,102,.16);border-color:rgba(255,204,102,.35);}
    .btn.bad{background:rgba(255,107,107,.14);border-color:rgba(255,107,107,.35);}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px;}
    .btn:active{transform:translateY(1px);}
    .divider{height:1px;background:var(--line);margin:14px 0;}
    .tiny{font-size:12px;color:var(--muted);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-size:12px;color:var(--muted);}
    .pill strong{color:var(--text);font-weight:600;}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);vertical-align:top;}
    th{color:var(--muted);font-weight:600;text-align:left;font-size:12px;}
    .right{text-align:right;}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);display:inline-block;}
    .tag.good{color:var(--good);border-color:rgba(56,211,159,.35);background:rgba(56,211,159,.10);}
    .tag.warn{color:var(--warn);border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.08);}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 12px;border-radius:12px;
      background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.14);color:var(--text);font-size:13px;opacity:0;pointer-events:none;transition:opacity .18s ease;max-width:min(92vw,1050px);}
    .toast.show{opacity:1;}
    .dangerBox{border:1px solid rgba(255,107,107,.35);background:rgba(255,107,107,.08);padding:12px;border-radius:12px;}
    .smallNote{font-size:12px;color:var(--muted);line-height:1.25;}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Zeiterfassung</h1>
          <div class="sub">1 Datei ‚Ä¢ Update-sicher ‚Ä¢ Pause: 55 Min nach 6h ‚Ä¢ Pausenzeiten in √úbersicht</div>
        </div>
      </div>
      <div class="row">
        <button class="btn small" id="btnBackup">Backup</button>
        <button class="btn small" id="btnRestoreBtn">Restore</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Live-Tracking</h2>

      <div class="row">
        <div class="col">
          <label>Datum</label>
          <input id="date" type="date" />
          <div class="tiny">Bei Mitternacht wird automatisch auf den n√§chsten Tag gesplittet.</div>
        </div>
        <div class="col">
          <label>Mitarbeiter</label>
          <select id="employee"></select>
          <div class="tiny">Mitarbeiter verwaltest du rechts unter ‚ÄûStammdaten‚Äú.</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <label>Arbeitszeitmodell</label>
          <select id="model">
            <option value="standard">Standardarbeitszeit</option>
            <option value="gleitzeit">Gleitzeit</option>
            <option value="fix">Fixe Arbeitszeit</option>
          </select>
          <div class="tiny">Flaggen entfernt.</div>
        </div>
        <div class="col">
          <label>Notiz (optional)</label>
          <input id="note" placeholder="z.B. Filiale, Auftrag, Thema‚Ä¶" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn good" id="start">‚ñ∂Ô∏è Start</button>
        <button class="btn warn" id="pause" disabled>‚è∏ Pause</button>
        <button class="btn primary" id="resume" disabled>‚èØ Weiter</button>
        <button class="btn bad" id="stop" disabled>‚èπ Stop</button>
      </div>

      <div class="kpi">
        <div class="pill">Status: <strong id="kStatus">bereit</strong></div>
        <div class="pill">Arbeit: <strong id="kWork">00:00</strong></div>
        <div class="pill">Pause: <strong id="kBreak">00:00</strong></div>
        <div class="pill">Auto-Abzug: <strong id="kAuto">00:00</strong></div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn" id="manual">‚ûï Manuell eintragen (inkl. Pausenzeiten)</button>
        <button class="btn" id="csvDay">‚¨áÔ∏è CSV (Tag)</button>
        <button class="btn" id="shareDay">üì§ Teilen (Tag)</button>
        <button class="btn" id="pdfDay">üñ®Ô∏è PDF (Tag)</button>
      </div>

      <div class="tiny" style="margin-top:10px;">
        Regel: Wenn <span class="mono">&gt; 6:00h</span> Arbeitszeit und Pause <span class="mono">&lt; 55 Min</span>,
        wird die fehlende Pause als <b>Auto-Abzug</b> gerechnet (keine Doppel-Pause).
      </div>
    </section>

    <aside class="card">
      <h2>Stammdaten</h2>

      <div class="row">
        <div class="col">
          <label>Manager E-Mail</label>
          <input id="manager" type="email" placeholder="manager@firma.de" />
          <div class="tiny">Wird in CSV & PDF √ºbernommen.</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="col">
          <label>Neuer Mitarbeiter ‚Äì Name</label>
          <input id="empName" placeholder="Vorname Nachname" />
        </div>
        <div class="col">
          <label>E-Mail (optional)</label>
          <input id="empEmail" type="email" placeholder="name@firma.de" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="addEmp">‚ûï Mitarbeiter speichern</button>
        <button class="btn bad" id="delEmp">üóëÔ∏è L√∂schen</button>
      </div>

      <div class="divider"></div>

      <div class="dangerBox">
        <div class="tiny"><b>Updates l√∂schen keine Daten.</b> Nur ‚ÄûAlles l√∂schen‚Äú entfernt alles.</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn bad" id="wipe">‚ö†Ô∏è Alles l√∂schen</button>
        </div>
      </div>
    </aside>
  </div>

  <section class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;">
      <h2 style="margin:0;">√úbersicht (letzte 30 Tage)</h2>
      <div class="row">
        <button class="btn" id="csv30">‚¨áÔ∏è CSV (30 Tage)</button>
        <button class="btn" id="pdf30">üñ®Ô∏è PDF (30 Tage)</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Mitarbeiter</th>
          <th>Pausenzeiten</th>
          <th>Segmente</th>
          <th class="right">Arbeit</th>
          <th class="right">Pause</th>
          <th class="right">Auto</th>
          <th class="right">Netto</th>
          <th class="right">Aktion</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="tiny" style="margin-top:10px;">
      Pausenzeiten als <span class="mono">HH:MM‚ÄìHH:MM</span>. Zus√§tzliche Minuten ohne Uhrzeit erscheinen als <span class="mono">Manuell +XXm</span>.
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>
<input id="restoreFile" type="file" accept="application/json" style="display:none;" />

<script>
/* ===========================
   Update-sicherer Speicher
   =========================== */
const STORAGE_KEY = "zeiterfassung_singlefile_data";
const SCHEMA_VERSION = 2;

function loadData(){
  try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; }
  catch { return null; }
}
function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
function freshData(){
  return { schemaVersion: SCHEMA_VERSION, managerEmail:"", employees:[], days:{} };
}
function migrate(d){
  const v = d?.schemaVersion ?? 0;
  if (v < 1) d = freshData();
  if (v < 2) {
    d = Object.assign(freshData(), d || {});
    if (!Array.isArray(d.employees)) d.employees = [];
    if (!d.days) d.days = {};
  }
  d.schemaVersion = SCHEMA_VERSION;
  // normalize days
  for (const k of Object.keys(d.days||{})) {
    const day = d.days[k] || {};
    if (!Array.isArray(day.segments)) day.segments = [];
    if (!day.manual) day.manual = { breakAddMin: 0 };
    day.manual.breakAddMin = Number(day.manual.breakAddMin || 0);
    day.model = day.model || "standard";
    day.note = day.note || "";
    d.days[k] = day;
  }
  return d;
}
let data = migrate(loadData() || freshData());
saveData(data);

/* ===========================
   Helpers
   =========================== */
const $ = (id)=>document.getElementById(id);
function pad(n){ return String(n).padStart(2,"0"); }
function isoDate(dt){ return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`; }
function parseDay(dayStr){
  const [y,m,d] = dayStr.split("-").map(Number);
  return new Date(y, m-1, d, 0,0,0,0);
}
function fmtHM(min){
  min = Math.max(0, Math.round(min));
  const h = Math.floor(min/60), m = min%60;
  return `${pad(h)}:${pad(m)}`;
}
function minutesBetween(a,b){ return (b.getTime()-a.getTime())/60000; }
function hhmm(iso){
  const dt = new Date(iso);
  return `${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
}
function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(t._x);
  t._x=setTimeout(()=>t.classList.remove("show"),2200);
}
function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }

function ensureDay(dayStr){
  if (!data.days[dayStr]) data.days[dayStr] = { model:"standard", note:"", segments:[], manual:{breakAddMin:0} };
  const d = data.days[dayStr];
  if (!Array.isArray(d.segments)) d.segments = [];
  if (!d.manual) d.manual = { breakAddMin:0 };
  d.manual.breakAddMin = Number(d.manual.breakAddMin || 0);
  d.model = d.model || "standard";
  d.note = d.note || "";
  return d;
}

function splitByMidnight(start,end){
  const out=[];
  let cur=new Date(start);
  while(cur<end){
    const d=isoDate(cur);
    const next=new Date(cur.getFullYear(), cur.getMonth(), cur.getDate()+1, 0,0,0,0);
    const segEnd = end<next ? end : next;
    out.push({dayStr:d, start:new Date(cur), end:new Date(segEnd)});
    cur=new Date(segEnd);
  }
  return out;
}

/* ===========================
   Regeln / Summen
   =========================== */
function sumDay(dayObj){
  let work=0, brk=0;
  for (const s of dayObj.segments){
    const a=new Date(s.startISO), b=new Date(s.endISO);
    const mins = minutesBetween(a,b);
    if (s.type==="work") work += mins;
    if (s.type==="break") brk += mins;
  }
  brk += Number(dayObj.manual?.breakAddMin || 0);
  return {work, brk};
}
function autoDeduction(workMin, breakMin){
  if (workMin <= 360) return 0;     // erst nach 6h
  return Math.max(0, 55 - breakMin);// nur fehlende Minuten
}
function breakTimesLabel(dayObj){
  const breaks = (dayObj.segments||[])
    .filter(s=>s.type==="break" && s.startISO && s.endISO)
    .sort((a,b)=> new Date(a.startISO) - new Date(b.startISO))
    .map(s=>`${hhmm(s.startISO)}‚Äì${hhmm(s.endISO)}`);

  const manual = Number(dayObj.manual?.breakAddMin || 0);
  let label = breaks.length ? breaks.join(", ") : "";
  if (manual > 0) label = label ? `${label} ‚Ä¢ Manuell +${manual}m` : `Manuell +${manual}m`;
  return label || "‚Äî";
}

/* ===========================
   Mitarbeiter / Labels
   =========================== */
function renderEmployees(){
  const sel=$("employee");
  sel.innerHTML="";
  if (!data.employees.length){
    const o=document.createElement("option");
    o.value=""; o.textContent="‚Äî zuerst Mitarbeiter anlegen ‚Äî";
    sel.appendChild(o);
    return;
  }
  for (const e of data.employees){
    const o=document.createElement("option");
    o.value=e.id; o.textContent=e.name;
    sel.appendChild(o);
  }
}
function currentEmployee(){
  const id=$("employee").value;
  return data.employees.find(e=>e.id===id) || null;
}
function employeesLabel(dayObj){
  const ids = new Set((dayObj.segments||[]).map(s=>s.employeeId).filter(Boolean));
  const names=[...ids].map(id=>data.employees.find(e=>e.id===id)?.name).filter(Boolean);
  return names.length ? names.join(", ") : "‚Äî";
}

/* ===========================
   Live Tracking
   =========================== */
let live = { running:false, mode:null, start:null, employeeId:"", model:"standard", note:"" };

function setButtons(){
  $("start").disabled = live.running;
  $("pause").disabled = !live.running || live.mode!=="work";
  $("resume").disabled = !live.running || live.mode!=="break";
  $("stop").disabled = !live.running;
  $("kStatus").textContent = live.running ? (live.mode==="work"?"l√§uft":"Pause") : "bereit";
}
function closeSegment(now){
  if (!live.running || !live.start || !live.mode) return;
  const start=new Date(live.start), end=new Date(now);
  if (end<=start) return;

  const pieces = splitByMidnight(start,end);
  for (const p of pieces){
    const dayObj = ensureDay(p.dayStr);
    dayObj.model = live.model || dayObj.model;
    dayObj.note  = live.note  || dayObj.note;

    dayObj.segments.push({
      type: live.mode,
      employeeId: live.employeeId,
      startISO: p.start.toISOString(),
      endISO: p.end.toISOString()
    });
  }
  saveData(data);
}
function updateKPI(){
  const dayStr=$("date").value;
  if (!dayStr) return;
  const dayObj=ensureDay(dayStr);
  const {work, brk} = sumDay(dayObj);
  const auto = autoDeduction(work, brk);
  $("kWork").textContent = fmtHM(work);
  $("kBreak").textContent = fmtHM(brk);
  $("kAuto").textContent = fmtHM(auto);
}
function startLive(){
  const emp=currentEmployee();
  if (!emp){ toast("Bitte zuerst einen Mitarbeiter anlegen."); return; }
  const dayStr=$("date").value;
  if (!dayStr){ toast("Bitte Datum w√§hlen."); return; }

  live.running=true;
  live.mode="work";
  live.start=new Date();
  live.employeeId=emp.id;
  live.model=$("model").value;
  live.note=$("note").value || "";

  const d=ensureDay(dayStr);
  d.model=live.model;
  d.note=live.note;

  saveData(data);
  setButtons();
  toast("Start");
  updateKPI();
}
function pauseLive(){
  const now=new Date();
  closeSegment(now);
  live.mode="break";
  live.start=now;
  saveData(data);
  setButtons();
  toast("Pause");
  updateKPI();
}
function resumeLive(){
  const now=new Date();
  closeSegment(now);
  live.mode="work";
  live.start=now;
  saveData(data);
  setButtons();
  toast("Weiter");
  updateKPI();
}
function stopLive(){
  const now=new Date();
  closeSegment(now);
  live={ running:false, mode:null, start:null, employeeId:"", model:"standard", note:"" };
  saveData(data);
  setButtons();
  toast("Stop");
  updateKPI();
  renderTable();
}

/* ===========================
   Manuell eintragen (inkl Pausenzeiten)
   =========================== */
function addManual(){
  const emp=currentEmployee();
  if (!emp){ toast("Bitte zuerst einen Mitarbeiter anlegen."); return; }
  const dayStr=$("date").value;
  if (!dayStr){ toast("Bitte Datum w√§hlen."); return; }

  const startStr = prompt("Arbeits-Start (HH:MM)", "09:00"); if (!startStr) return;
  const endStr   = prompt("Arbeits-Ende (HH:MM)", "17:00");   if (!endStr) return;

  const breaksStr = prompt("Pausenzeiten (z.B. 12:00-12:30, 15:10-15:20) oder leer", "12:00-12:30");
  if (breaksStr === null) return;

  const breakAddStr = prompt("Zus√§tzliche Pausen-Minuten ohne Uhrzeit (optional) oder leer", "");
  if (breakAddStr === null) return;

  const [sh,sm]=startStr.split(":").map(Number);
  const [eh,em]=endStr.split(":").map(Number);

  const day=parseDay(dayStr);
  const workStart=new Date(day.getFullYear(),day.getMonth(),day.getDate(),sh,sm,0,0);
  const workEnd  =new Date(day.getFullYear(),day.getMonth(),day.getDate(),eh,em,0,0);
  if (!(workStart<workEnd)){ toast("Ende muss nach Start liegen."); return; }

  const dayObj=ensureDay(dayStr);
  dayObj.model = $("model").value;
  dayObj.note  = $("note").value || dayObj.note;

  // Work
  dayObj.segments.push({ type:"work", employeeId:emp.id, startISO:workStart.toISOString(), endISO:workEnd.toISOString() });

  // Break intervals -> echte Break-Segmente
  const trimmed = (breaksStr||"").trim();
  if (trimmed) {
    const parts = trimmed.split(",").map(x=>x.trim()).filter(Boolean);
    for (const part of parts){
      const norm = part.replace("‚Äì","-");
      const [a,b] = norm.split("-").map(x=>x.trim());
      if (!a || !b) continue;
      const [bh,bm] = a.split(":").map(Number);
      const [ch,cm] = b.split(":").map(Number);
      if ([bh,bm,ch,cm].some(n=>Number.isNaN(n))) continue;

      const bStart = new Date(day.getFullYear(),day.getMonth(),day.getDate(),bh,bm,0,0);
      const bEnd   = new Date(day.getFullYear(),day.getMonth(),day.getDate(),ch,cm,0,0);
      if (!(bStart < bEnd)) continue;

      dayObj.segments.push({ type:"break", employeeId:emp.id, startISO:bStart.toISOString(), endISO:bEnd.toISOString() });
    }
  }

  // zus√§tzliche Minuten ohne Uhrzeit
  const add = Math.max(0, Number((breakAddStr||"").trim() || 0));
  if (add > 0) dayObj.manual.breakAddMin = Number(dayObj.manual.breakAddMin||0) + add;

  saveData(data);
  toast("Manuell gespeichert");
  updateKPI();
  renderTable();
}

/* ===========================
   CSV / Share / Print
   =========================== */
function rowsForDay(dayStr){
  const dayObj=data.days[dayStr];
  if (!dayObj) return [];

  const map=new Map();
  for (const s of dayObj.segments){
    const mins = minutesBetween(new Date(s.startISO), new Date(s.endISO));
    const key=s.employeeId||"";
    if (!map.has(key)) map.set(key,{work:0,brk:0,segs:0});
    const it=map.get(key);
    it.segs++;
    if (s.type==="work") it.work+=mins;
    if (s.type==="break") it.brk+=mins;
  }
  const manualBreak = Number(dayObj.manual?.breakAddMin||0);

  const rows=[];
  for (const [eid,it] of map.entries()){
    const emp=data.employees.find(e=>e.id===eid);
    const breakTotal = it.brk + manualBreak;
    const auto = autoDeduction(it.work, breakTotal);
    rows.push({
      date: dayStr,
      employee: emp?.name || "‚Äî",
      employeeEmail: emp?.email || "",
      managerEmail: data.managerEmail || "",
      model: dayObj.model || "standard",
      note: dayObj.note || "",
      breakTimes: breakTimesLabel(dayObj),
      segments: it.segs,
      workMin: Math.round(it.work),
      breakMin: Math.round(breakTotal),
      autoMin: Math.round(auto),
      netMin: Math.round(Math.max(0, it.work - auto))
    });
  }

  if (!rows.length){
    const {work,brk}=sumDay(dayObj);
    const auto=autoDeduction(work,brk);
    rows.push({
      date: dayStr, employee:"‚Äî", employeeEmail:"",
      managerEmail:data.managerEmail||"", model:dayObj.model||"standard", note:dayObj.note||"",
      breakTimes: breakTimesLabel(dayObj),
      segments:0, workMin:Math.round(work), breakMin:Math.round(brk),
      autoMin:Math.round(auto), netMin:Math.round(Math.max(0, work-auto))
    });
  }
  return rows;
}

function rowsToCSV(rows){
  const header=[
    "Datum","Mitarbeiter","Mitarbeiter_Email","Manager_Email","Arbeitszeitmodell","Notiz",
    "Pausenzeiten","Segmente","Arbeit_Min","Pause_Min","AutoPause_Abzug_Min","Netto_Min"
  ];
  const esc=(v)=>{
    const s=String(v??"");
    return /[,"\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
  };
  const lines=[header.join(",")];
  for (const r of rows){
    lines.push([
      r.date,r.employee,r.employeeEmail,r.managerEmail,r.model,r.note,
      r.breakTimes,r.segments,r.workMin,r.breakMin,r.autoMin,r.netMin
    ].map(esc).join(","));
  }
  return lines.join("\n");
}
function downloadFile(name, content, mime){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=name;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
async function shareCSV(name, csv){
  try{
    const file=new File([csv], name, {type:"text/csv"});
    if (navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title:"Zeiterfassung", text:"CSV exportiert."});
      toast("Geteilt"); return;
    }
  }catch{}
  downloadFile(name, csv, "text/csv;charset=utf-8");
  toast("CSV heruntergeladen");
}
function printHTML(title, html){
  const w=window.open("","_blank");
  if(!w){ toast("Popup blockiert"); return; }
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>
    <style>
      body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;padding:20px;}
      h1{margin:0 0 6px;font-size:18px;}
      .muted{color:#555;font-size:12px;margin-bottom:14px;}
      table{width:100%;border-collapse:collapse;font-size:12px;}
      th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left;vertical-align:top;}
      th{background:#f4f4f4;}
      .right{text-align:right;}
      .small{font-size:11px;color:#666;margin-top:10px;}
      .note{font-size:11px;color:#444;margin:8px 0 12px;}
    </style>
  </head><body>${html}<script>window.onload=()=>window.print();</script></body></html>`);
  w.document.close();
}

/* ===========================
   √úbersicht
   =========================== */
function lastNDays(n){
  const out=[];
  const now=new Date();
  for(let i=0;i<n;i++){
    const d=new Date(now);
    d.setDate(d.getDate()-i);
    out.push(isoDate(d));
  }
  return out;
}
function renderTable(){
  const tbody=$("tbody");
  tbody.innerHTML="";

  const days = lastNDays(30).filter(d=>data.days[d]);
  if(!days.length){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td colspan="9" class="smallNote">Noch keine Eintr√§ge.</td>`;
    tbody.appendChild(tr);
    return;
  }

  for(const dayStr of days){
    const dayObj=ensureDay(dayStr);
    const {work, brk} = sumDay(dayObj);
    const auto = autoDeduction(work, brk);
    const net  = Math.max(0, work - auto);

    const tag = auto>0 ? `<span class="tag warn">Auto</span>` : `<span class="tag good">OK</span>`;
    const segCount = (dayObj.segments||[]).length;

    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${dayStr}<div class="smallNote">${tag}</div></td>
      <td>${employeesLabel(dayObj)}</td>
      <td class="smallNote">${breakTimesLabel(dayObj)}</td>
      <td>${segCount}</td>
      <td class="right">${fmtHM(work)}</td>
      <td class="right">${fmtHM(brk)}</td>
      <td class="right">${fmtHM(auto)}</td>
      <td class="right"><b>${fmtHM(net)}</b></td>
      <td class="right">
        <button class="btn small" data-open="${dayStr}">√ñffnen</button>
        <button class="btn small bad" data-del="${dayStr}">L√∂schen</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll("[data-open]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const d=btn.getAttribute("data-open");
      $("date").value=d;
      updateKPI();
      toast("Tag geladen");
    });
  });

  tbody.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const d=btn.getAttribute("data-del");
      if(!confirm(`Eintr√§ge am ${d} wirklich l√∂schen?`)) return;
      delete data.days[d];
      saveData(data);
      renderTable();
      updateKPI();
      toast("Gel√∂scht");
    });
  });
}

/* ===========================
   Backup / Restore
   =========================== */
function downloadBackup(){
  const blob = JSON.stringify(data, null, 2);
  downloadFile(`zeiterfassung-backup-${isoDate(new Date())}.json`, blob, "application/json");
  toast("Backup gespeichert");
}
function restoreBackup(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      data = migrate(JSON.parse(reader.result));
      saveData(data);
      $("manager").value = data.managerEmail || "";
      renderEmployees();
      renderTable();
      updateKPI();
      toast("Restore erfolgreich");
    }catch{
      alert("Backup-Datei ist ung√ºltig.");
    }
  };
  reader.readAsText(file);
}

/* ===========================
   Init / Events
   =========================== */
function init(){
  $("date").value = isoDate(new Date());

  $("manager").value = data.managerEmail || "";
  $("manager").addEventListener("input", ()=>{
    data.managerEmail = $("manager").value.trim();
    saveData(data);
  });

  renderEmployees();
  setButtons();
  renderTable();
  updateKPI();

  $("model").addEventListener("change", ()=>{
    const d=$("date").value; if(!d) return;
    ensureDay(d).model = $("model").value;
    saveData(data);
  });

  $("note").addEventListener("input", ()=>{
    const d=$("date").value; if(!d) return;
    ensureDay(d).note = $("note").value || "";
    saveData(data);
  });

  $("date").addEventListener("change", updateKPI);

  $("start").addEventListener("click", startLive);
  $("pause").addEventListener("click", pauseLive);
  $("resume").addEventListener("click", resumeLive);
  $("stop").addEventListener("click", stopLive);
  $("manual").addEventListener("click", addManual);

  $("addEmp").addEventListener("click", ()=>{
    const name=$("empName").value.trim();
    const email=$("empEmail").value.trim();
    if(!name){ toast("Name fehlt"); return; }
    data.employees.push({id:uid(), name, email});
    saveData(data);
    $("empName").value=""; $("empEmail").value="";
    renderEmployees();
    toast("Mitarbeiter gespeichert");
  });

  $("delEmp").addEventListener("click", ()=>{
    const emp=currentEmployee();
    if(!emp){ toast("Kein Mitarbeiter gew√§hlt"); return; }
    if(!confirm(`${emp.name} wirklich l√∂schen?`)) return;
    data.employees = data.employees.filter(e=>e.id!==emp.id);
    saveData(data);
    renderEmployees();
    renderTable();
    toast("Gel√∂scht");
  });

  $("wipe").addEventListener("click", ()=>{
    if(!confirm("Wirklich ALLES l√∂schen (unwiderruflich)?")) return;
    localStorage.removeItem(STORAGE_KEY);
    data = freshData();
    saveData(data);
    $("manager").value="";
    renderEmployees();
    renderTable();
    updateKPI();
    toast("Alles gel√∂scht");
  });

  $("csvDay").addEventListener("click", ()=>{
    const d=$("date").value;
    const csv=rowsToCSV(rowsForDay(d));
    downloadFile(`zeiterfassung-${d}.csv`, csv, "text/csv;charset=utf-8");
    toast("CSV gespeichert");
  });

  $("shareDay").addEventListener("click", async ()=>{
    const d=$("date").value;
    const csv=rowsToCSV(rowsForDay(d));
    await shareCSV(`zeiterfassung-${d}.csv`, csv);
  });

  $("pdfDay").addEventListener("click", ()=>{
    const d=$("date").value;
    const rows=rowsForDay(d);
    const mgr=data.managerEmail||"‚Äî";
    const dayObj = ensureDay(d);
    const pauses = breakTimesLabel(dayObj);

    const html = `
      <h1>Zeiterfassung ‚Äì ${d}</h1>
      <div class="muted">Manager: <b>${mgr}</b></div>
      <div class="note">Pausenzeiten: <b>${pauses}</b></div>
      <table>
        <thead>
          <tr>
            <th>Datum</th><th>Mitarbeiter</th><th>Modell</th><th>Notiz</th><th>Pausenzeiten</th>
            <th class="right">Arbeit</th><th class="right">Pause</th><th class="right">Auto</th><th class="right">Netto</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${r.date}</td><td>${r.employee}</td><td>${r.model}</td><td>${r.note || ""}</td><td>${r.breakTimes}</td>
              <td class="right">${fmtHM(r.workMin)}</td>
              <td class="right">${fmtHM(r.breakMin)}</td>
              <td class="right">${fmtHM(r.autoMin)}</td>
              <td class="right"><b>${fmtHM(r.netMin)}</b></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      <div class="small">Regel: 55 Min Pause nach 6h Arbeitszeit (fehlende Pause = Auto-Abzug).</div>
    `;
    printHTML(`Zeiterfassung ${d}`, html);
  });

  $("csv30").addEventListener("click", ()=>{
    const rows=[];
    for (const d of lastNDays(30)) if (data.days[d]) rows.push(...rowsForDay(d));
    rows.sort((a,b)=>a.date.localeCompare(b.date));
    const csv=rowsToCSV(rows);
    downloadFile(`zeiterfassung-30tage-${isoDate(new Date())}.csv`, csv, "text/csv;charset=utf-8");
    toast("CSV gespeichert");
  });

  $("pdf30").addEventListener("click", ()=>{
    const rows=[];
    for (const d of lastNDays(30)) if (data.days[d]) rows.push(...rowsForDay(d));
    rows.sort((a,b)=>a.date.localeCompare(b.date));
    const mgr=data.managerEmail||"‚Äî";
    const html = `
      <h1>Zeiterfassung ‚Äì letzte 30 Tage</h1>
      <div class="muted">Manager: <b>${mgr}</b></div>
      <table>
        <thead>
          <tr>
            <th>Datum</th><th>Mitarbeiter</th><th>Modell</th><th>Notiz</th><th>Pausenzeiten</th>
            <th class="right">Arbeit</th><th class="right">Pause</th><th class="right">Auto</th><th class="right">Netto</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${r.date}</td><td>${r.employee}</td><td>${r.model}</td><td>${r.note || ""}</td><td>${r.breakTimes}</td>
              <td class="right">${fmtHM(r.workMin)}</td>
              <td class="right">${fmtHM(r.breakMin)}</td>
              <td class="right">${fmtHM(r.autoMin)}</td>
              <td class="right"><b>${fmtHM(r.netMin)}</b></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      <div class="small">Regel: 55 Min Pause nach 6h Arbeitszeit (fehlende Pause = Auto-Abzug).</div>
    `;
    printHTML("Zeiterfassung 30 Tage", html);
  });

  // Backup/Restore
  $("btnBackup").addEventListener("click", downloadBackup);
  $("btnRestoreBtn").addEventListener("click", ()=> $("restoreFile").click());
  $("restoreFile").addEventListener("change", (e)=>{
    const file=e.target.files?.[0];
    if(!file) return;
    restoreBackup(file);
    e.target.value="";
  });
}

init();
</script>
</body>
</html>
