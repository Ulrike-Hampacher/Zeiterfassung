<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Zeiterfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Zeiterfassung">
<meta name="theme-color" content="#111">
<meta name="robots" content="noindex,nofollow">

<!-- Icons (werden per JS dynamisch gesetzt) -->
<link id="dynIcon" rel="icon" href="">
<link id="dynAppleIcon" rel="apple-touch-icon" href="">

<style>
:root{
  --bg:#f4f6f8; --card:#fff; --text:#0f172a; --muted:#64748b;
  --line:#e5e7eb;

  --ok:#166534; --okbg:#dcfce7;
  --warn:#9a3412; --warnbg:#fff7ed;
  --err:#991b1b; --errbg:#fee2e2;

  --blue:#2563eb; --green:#16a34a; --red:#dc2626; --dark:#0f172a;
  --chip:#eef2ff;
}
*{box-sizing:border-box}
body{
  margin:0;padding:14px;
  font-family:-apple-system,system-ui;
  background:var(--bg);color:var(--text);
}
.card{
  background:var(--card);
  border-radius:16px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.08);
}
h1{margin:0 0 6px 0;font-size:20px}
h2{margin:6px 0 10px 0;font-size:16px}
.muted{color:var(--muted);font-size:13px}

.row{
  display:flex; flex-wrap:wrap; align-items:flex-end;
  column-gap:10px; row-gap:12px;
  margin-bottom:-12px;
}
.row>*{margin-bottom:12px;}
.right{margin-left:auto}

input,select,button{
  font-size:16px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
}
button{border:none;font-weight:700;cursor:pointer}
.btn-start{background:var(--green);color:#fff}
.btn-pause{background:var(--dark);color:#fff}
.btn-stop{background:var(--red);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-ghost{background:#eef2f7;color:#0f172a}
.btn-sm{padding:8px 10px;font-size:14px;border-radius:10px}

.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{
  padding:10px 14px;border-radius:12px;
  background:#eef2f7;cursor:pointer;
}
.tab.active{background:#111;color:#fff}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:14px;vertical-align:top}
th{text-align:left;color:#64748b}
.mono{font-family:ui-monospace,Menlo,monospace}

.badge{
  display:inline-flex; align-items:center; gap:6px;
  padding:5px 10px; border-radius:999px;
  font-size:12px; font-weight:800;
  background:var(--chip);
  border:1px solid rgba(0,0,0,.06);
  white-space:nowrap;
}
.badge.weekend{
  color:#1e40af;
  background:#eff6ff;
  border:1px solid #bfdbfe;
}
.badge.vac{ color:#2563eb; }
.badge.sick{ color:#f97316; }
.badge.hol{ color:#16a34a; }

.chip-ok{ background:var(--okbg); color:var(--ok); }
.chip-warn{ background:var(--warnbg); color:var(--warn); }
.chip-error{ background:var(--errbg); color:var(--err); }

.summarybar{
  display:flex; flex-wrap:wrap; gap:10px; align-items:center;
  margin-top:10px;
}
.summarybar .right{ margin-left:auto; }

/* Kompakt am Handy */
.w-emp{width:220px;max-width:220px}
.w-note{width:160px;max-width:160px}
.w-save{width:170px;max-width:170px}

/* Manager kompakt & "nicht am Rand kleben" */
.w-mgr-name{width:190px;max-width:190px;margin-left:-7px}
.w-mgr-mail{
  width:340px;
  max-width:88vw;
  min-width:280px;
  margin-left:-9px;
}

/* Settings inputs */
.w-pin{width:120px;max-width:120px}
.w-color{width:140px;max-width:140px}
.w-style{width:190px;max-width:190px}

/* Stack layout */
.stack{display:flex;flex-direction:column;gap:8px;align-items:flex-start}
.stack input{margin-bottom:6px}
.stack button{margin-top:4px}

.btn-app{
  background:linear-gradient(135deg,#111,#2b2b2b);
  color:#fff;
  padding:10px 14px;
  border-radius:14px;
  font-weight:800;
  box-shadow:0 6px 16px rgba(0,0,0,.18);
}
.btn-app:active{transform:scale(.98)}

/* PIN Overlay */
.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  display:none; align-items:center; justify-content:center;
  padding:14px;
}
.modal{
  width:min(520px,100%);
  background:#fff;
  border-radius:16px;
  padding:14px;
  box-shadow:0 12px 40px rgba(0,0,0,.25);
}
.modal h2{margin-top:0}
.pin{
  width:min(260px,86vw);
  max-width:86vw;
  letter-spacing:.18em;
  font-weight:800;
  text-align:center;
  font-size:18px;
  padding:10px 12px;
}

@media(max-width:360px){
  .pin{width:82vw;letter-spacing:.14em}
}
@media(max-width:340px){
  .w-emp{width:210px;max-width:210px}
  .w-note{width:150px;max-width:150px}
  .w-mgr-name{width:180px;max-width:180px;margin-left:-7px}
}
</style>
</head>

<body>

<div class="card">
  <h1>â±ï¸ Zeiterfassung</h1>
  <div class="muted">Offline Â· ğŸ” PIN (6-stellig) Â· Auto-Pause <b>55 min</b> Â· CSV & Teilen</div>

  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <button class="btn-app" id="btnAddToHome">ğŸ“² Als App hinzufÃ¼gen</button>
    <span class="muted" id="a2hsHint" style="display:none">iPhone: Teilen â–¸ â€Zum Home-Bildschirmâ€œ</span>
  </div>
</div>

<div class="card">
  <div class="tabs">
    <div class="tab active" data-tab="timer">â±ï¸ Timer</div>
    <div class="tab" data-tab="overview">ğŸ“Š Ãœbersicht</div>
    <div class="tab" data-tab="edit">âœï¸ RÃ¼ckwirkend</div>
    <div class="tab" data-tab="absence">ğŸ–ï¸ Abwesenheit</div>
    <div class="tab" data-tab="entries">ğŸ§¾ EintrÃ¤ge</div>
    <div class="tab" data-tab="settings">âš™ï¸ Settings</div>
  </div>
</div>

<!-- TIMER -->
<div class="card" id="timer">
  <h2>â±ï¸ Timer</h2>

  <div class="stack">
    <div class="muted">ğŸ‘¤ Mitarbeiter</div>
    <input id="empName" class="w-emp" placeholder="Vorname Nachname">
    <button class="btn-ghost w-save" id="saveName">ğŸ’¾ Speichern</button>
    <div class="muted" id="nameMsg"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <div><div class="muted">ğŸ“… Datum</div><input type="date" id="timerDate"></div>
    <div><div class="muted">ğŸ“ Notiz</div><input id="timerNote" class="w-note" placeholder="kurz"></div>
    <span class="right muted mono" id="timerMini"></span>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="btn-start" id="btnStart">â–¶ï¸ Start</button>
    <button class="btn-pause" id="btnPause" disabled>â¸ï¸ Pause</button>
    <button class="btn-stop" id="btnStop">â–  Stop</button>
    <span class="badge" id="timerStatus">âšª bereit</span>
    <span class="right muted mono" id="timerInfo"></span>
  </div>
</div>

<!-- OVERVIEW -->
<div class="card" id="overview" style="display:none">
  <h2>ğŸ“Š Ãœbersicht</h2>

  <div class="row">
    <div>
      <div class="muted">ğŸ§­ Modus</div>
      <select id="mode">
        <option value="week">Woche</option>
        <option value="month">Monat</option>
        <option value="year">Jahr</option>
      </select>
    </div>

    <div>
      <div class="muted">ğŸ“Œ Datum</div>
      <input type="date" id="refDate">
    </div>

    <div>
      <div class="muted">ğŸ¯ Wochen-Soll</div>
      <select id="weeklyTarget">
        <option value="2400">40:00 ğŸ‡©ğŸ‡ª</option>
        <option value="2310">38:30 ğŸ‡¦ğŸ‡¹</option>
      </select>
    </div>

    <button class="btn-ghost" id="btnRefresh">â†»</button>
    <button class="btn-blue" id="btnCSV">â¬‡ï¸ CSV</button>
    <button class="btn-ghost" id="btnShare">ğŸ“¤ Teilen</button>

    <span class="right muted mono" id="yearHint"></span>
  </div>

  <div class="summarybar" id="summaryBar" style="display:none">
    <span class="badge" id="weekChip" style="display:none">â€”</span>
    <span class="badge" id="sumChip">â€”</span>
    <span class="badge" id="avgChip" style="display:none">â€”</span>
    <span class="badge weekend right" id="weekendChip" style="display:none">ğŸŸ¦ Wochenende: 00:00</span>
  </div>

  <div style="margin-top:12px">
    <h2>ğŸ‘” Manager</h2>
    <div class="stack">
      <div class="muted">Name</div>
      <input id="mgrName" class="w-mgr-name" placeholder="Name">
      <div class="muted">E-Mail</div>
      <input id="mgrMail" class="w-mgr-mail" placeholder="vorname.nachname@firma.de">
      <button class="btn-ghost w-save" id="saveMgr">ğŸ’¾ Speichern</button>
    </div>
  </div>

  <div id="overviewTable" style="margin-top:12px"></div>
</div>

<!-- EDIT -->
<div class="card" id="edit" style="display:none">
  <h2>âœï¸ RÃ¼ckwirkend</h2>
  <div class="row">
    <div><div class="muted">ğŸ“… Datum</div><input type="date" id="eDate"></div>
    <div><div class="muted">ğŸŸ¢ Start</div><input type="time" id="eStart"></div>
    <div><div class="muted">ğŸ”´ Ende</div><input type="time" id="eEnd"></div>
    <div><div class="muted">ğŸ“ Notiz</div><input id="eNote" class="w-note"></div>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn-ghost" id="saveManual">ğŸ’¾ Speichern</button>
    <button class="btn-ghost" id="newManual">ğŸ§½ Neu</button>
    <span class="right muted mono" id="editMsg"></span>
  </div>
</div>

<!-- ABSENCE -->
<div class="card" id="absence" style="display:none">
  <h2>ğŸ–ï¸ Abwesenheit</h2>
  <div class="muted">
    Zeitraum: nur <b>Moâ€“Fr</b>. âœ… Pro Tag <b>max. 1</b> Abwesenheit. Neue Eintragung <b>Ã¼berschreibt</b> vorhandene.
  </div>

  <div class="row" style="margin-top:10px">
    <div><div class="muted">ğŸ“… Start</div><input type="date" id="aStart"></div>
    <div><div class="muted">ğŸ“… Ende</div><input type="date" id="aEnd"></div>
    <div>
      <div class="muted">ğŸ·ï¸ Typ</div>
      <select id="aType">
        <option value="vac">ğŸ–ï¸ Urlaub</option>
        <option value="sick">ğŸ¤’ Krank</option>
        <option value="hol">ğŸ‰ Feiertag</option>
      </select>
    </div>
    <button class="btn-ghost" id="addAbs">â• Speichern</button>
  </div>

  <div class="row" style="margin-top:10px">
    <div><div class="muted">ğŸ—“ï¸ Einzeltag lÃ¶schen</div><input type="date" id="aDelDate"></div>
    <button class="btn-ghost" id="delAbsDay">ğŸ—‘ï¸ LÃ¶schen</button>
    <span class="right muted mono" id="absMsg"></span>
  </div>

  <div id="absList" style="margin-top:12px"></div>
</div>

<!-- ENTRIES -->
<div class="card" id="entries" style="display:none">
  <h2>ğŸ§¾ EintrÃ¤ge</h2>
  <div class="muted">âœï¸ bearbeiten Â· ğŸ—‘ï¸ lÃ¶schen</div>
  <div id="entryList" style="margin-top:10px"></div>
</div>

<!-- SETTINGS -->
<div class="card" id="settings" style="display:none">
  <h2>âš™ï¸ Settings</h2>
  <div class="muted">ğŸ” Daten lokal verschlÃ¼sselt. PIN gilt pro Session (solange Safari offen bleibt).</div>

  <div class="row" style="margin-top:10px">
    <button class="btn-ghost" id="btnLock">ğŸ”’ Sperren</button>
    <button class="btn-stop" id="btnResetThisYear">ğŸ§¹ Jahr lÃ¶schen</button>
    <button class="btn-ghost" id="btnResetAll">ğŸ§¨ Alles lÃ¶schen</button>
  </div>

  <div class="card" style="margin-top:12px;background:#fbfbfb">
    <h2>ğŸ¨ App-Icon</h2>
    <div class="muted">WÃ¤hle Style + Farbe â†’ â€Icon anwendenâ€œ â†’ dann iPhone: Home-Icon lÃ¶schen & neu hinzufÃ¼gen.</div>
    <div class="row" style="margin-top:10px">
      <div>
        <div class="muted">Style</div>
        <select id="iconStyle" class="w-style">
          <option value="A">A Â· Minimal modern</option>
          <option value="B" selected>B Â· Friendly clean</option>
          <option value="C">C Â· Corporate</option>
        </select>
      </div>
      <div>
        <div class="muted">Farbe</div>
        <input id="iconColor" class="w-color" type="color" value="#2563eb">
      </div>
      <button class="btn-blue" id="btnApplyIcon">âœ¨ Icon anwenden</button>
      <button class="btn-ghost" id="btnDownloadIcon">â¬‡ï¸ Icon PNG</button>
      <span class="right muted mono" id="iconMsg"></span>
    </div>
  </div>

  <div class="muted" style="margin-top:8px">â€Jahr lÃ¶schenâ€œ bezieht sich auf das Jahr vom ğŸ“Œ Datum in der Ãœbersicht.</div>
</div>

<!-- PIN Overlay -->
<div class="overlay" id="ovl">
  <div class="modal">
    <h2>ğŸ” Zeiterfassung entsperren</h2>
    <div class="muted" id="ovlText">Bitte 6-stellige PIN eingeben.</div>
    <div style="margin-top:10px;display:flex;justify-content:center">
      <input id="pinInput" class="pin" inputmode="numeric" maxlength="6" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off">
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn-blue" id="btnUnlock">âœ… Entsperren</button>
      <button class="btn-ghost" id="btnSetPin">ğŸ†• PIN setzen</button>
      <span class="right muted mono" id="pinMsg"></span>
    </div>
    <div class="muted" style="margin-top:10px">PIN vergessen = Daten nicht entschlÃ¼sselbar (nur Reset mÃ¶glich).</div>
  </div>
</div>

<script>
(() => {
  // ===== Config =====
  const NS="ZEITERFASSUNG";
  const AUTO_BREAK=55;                 // Minuten Auto-Pause
  const TOL_WEEK_MIN = 10*60;          // Â±10h pro Woche Toleranz
  const PIN_LEN=6;

  const ICON_KEY = NS+"::icon_png_dataurl";     // gespeichertes PNG DataURL
  const ICON_PREF = NS+"::icon_prefs";          // Style+Color

  const $=id=>document.getElementById(id);
  const pad=n=>String(n).padStart(2,"0");
  const b64 = (buf)=>btoa(String.fromCharCode(...new Uint8Array(buf)));
  const ub64 = (s)=>Uint8Array.from(atob(s), c=>c.charCodeAt(0));
  const rand = (n)=>crypto.getRandomValues(new Uint8Array(n));

  const hhmm=(m)=>{
    if(!Number.isFinite(m)) return "--:--";
    const s=m<0?"-":"";
    m=Math.abs(Math.round(m));
    return s + pad(Math.floor(m/60)) + ":" + pad(m%60);
  };
  const d0=(s)=>{ const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); };
  const wd=(d)=> d.getDay()>=1 && d.getDay()<=5;
  const isWeekend=(d)=> d.getDay()===0 || d.getDay()===6;
  const toDateStr=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function absLabel(t){ return t==="vac"?"Urlaub":t==="sick"?"Krank":t==="hol"?"Feiertag":t; }
  function absBadge(t){
    if(t==="vac")  return `<span class="badge vac">ğŸ–ï¸ Urlaub</span>`;
    if(t==="sick") return `<span class="badge sick">ğŸ¤’ Krank</span>`;
    if(t==="hol")  return `<span class="badge hol">ğŸ‰ Feiertag</span>`;
    return `<span class="badge">${t}</span>`;
  }
  const weekendBadge=()=>`<span class="badge weekend">ğŸŸ¦ Wochenende</span>`;

  function getWeeklyTargetMinutes(){
    const v=Number($("weeklyTarget").value);
    return (Number.isFinite(v) && v>0) ? v : 2400;
  }
  function csvSafeCell(s){
    s=(s??"").toString();
    const t=s.trimStart();
    if(t.startsWith("=")||t.startsWith("+")||t.startsWith("-")||t.startsWith("@")) return "'"+s;
    return s;
  }

  // ===== Icon Generator (3 styles) =====
  function iconSVG(style, color){
    const c = color || "#2563eb";
    const bgA = "#0b1220";      // dunkel
    const bgB = "#ffffff";      // hell
    const stroke = "#0f172a";
    const white = "#ffffff";

    // Minimal modern (A): Dark gradient + clock ring + subtle "tick"
    if(style==="A"){
      return `
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#111827"/>
      <stop offset="1" stop-color="#0b1220"/>
    </linearGradient>
    <filter id="s" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="18" stdDeviation="20" flood-color="#000" flood-opacity=".25"/>
    </filter>
  </defs>
  <rect width="1024" height="1024" rx="220" fill="url(#g)"/>
  <circle cx="512" cy="512" r="300" fill="none" stroke="${c}" stroke-width="44" filter="url(#s)"/>
  <circle cx="512" cy="512" r="240" fill="none" stroke="${white}" stroke-opacity=".10" stroke-width="18"/>
  <path d="M512 320v210l150 86" fill="none" stroke="${white}" stroke-width="46" stroke-linecap="round" stroke-linejoin="round"/>
  <circle cx="512" cy="512" r="18" fill="${white}"/>
  <path d="M230 735c120 92 444 92 564 0" fill="none" stroke="${white}" stroke-opacity=".08" stroke-width="22" stroke-linecap="round"/>
</svg>`;
    }

    // Friendly clean (B): Light card + nice badge + clock + check
    if(style==="B"){
      return `
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="${c}"/>
      <stop offset="1" stop-color="#1d4ed8"/>
    </linearGradient>
    <filter id="s" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="18" stdDeviation="18" flood-color="#000" flood-opacity=".18"/>
    </filter>
  </defs>
  <rect width="1024" height="1024" rx="220" fill="#f8fafc"/>
  <rect x="160" y="180" width="704" height="664" rx="160" fill="white" filter="url(#s)"/>
  <circle cx="512" cy="490" r="210" fill="none" stroke="url(#g)" stroke-width="44"/>
  <path d="M512 350v160l120 72" fill="none" stroke="${stroke}" stroke-width="40" stroke-linecap="round" stroke-linejoin="round"/>
  <circle cx="512" cy="490" r="16" fill="${stroke}"/>
  <rect x="300" y="690" width="424" height="92" rx="46" fill="url(#g)"/>
  <path d="M412 736l46 46 138-150" fill="none" stroke="white" stroke-width="34" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;
    }

    // Corporate (C): Strong + geometric + subtle Z without being boring
    return `
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#0b1220"/>
      <stop offset="1" stop-color="#111827"/>
    </linearGradient>
    <filter id="s" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="20" stdDeviation="22" flood-color="#000" flood-opacity=".25"/>
    </filter>
  </defs>
  <rect width="1024" height="1024" rx="220" fill="url(#g)"/>
  <path d="M230 360h564l-380 304h380v80H230l380-304H230z" fill="${c}" opacity=".95"/>
  <circle cx="512" cy="512" r="260" fill="none" stroke="white" stroke-opacity=".18" stroke-width="24"/>
  <path d="M512 370v170l120 84" fill="none" stroke="white" stroke-width="44" stroke-linecap="round" stroke-linejoin="round" filter="url(#s)"/>
  <circle cx="512" cy="512" r="16" fill="white"/>
</svg>`;
  }

  function svgToDataURL(svg){
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
  }

  async function svgToPngDataURL(svg, size=1024){
    // render svg to canvas -> png data url
    const img = new Image();
    img.decoding = "async";
    const url = svgToDataURL(svg);

    await new Promise((res, rej) => {
      img.onload = () => res();
      img.onerror = () => rej(new Error("Icon-Render fehlgeschlagen"));
      img.src = url;
    });

    const canvas = document.createElement("canvas");
    canvas.width = size; canvas.height = size;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,size,size);
    ctx.drawImage(img,0,0,size,size);
    return canvas.toDataURL("image/png");
  }

  function setIcons(iconPngDataURL, iconSvgDataURL){
    // favicon (SVG ok) + apple touch icon (PNG best)
    const fav = $("dynIcon");
    const apple = $("dynAppleIcon");
    fav.href = iconSvgDataURL || iconPngDataURL;
    apple.href = iconPngDataURL;
  }

  function loadIconPrefs(){
    try{
      const raw = localStorage.getItem(ICON_PREF);
      if(!raw) return {style:"B", color:"#2563eb"};
      const p = JSON.parse(raw);
      return {style:p.style||"B", color:p.color||"#2563eb"};
    }catch{ return {style:"B", color:"#2563eb"}; }
  }
  function saveIconPrefs(p){
    localStorage.setItem(ICON_PREF, JSON.stringify(p));
  }

  async function applyIcon(style, color){
    const svg = iconSVG(style, color);
    const svgURL = svgToDataURL(svg);
    const pngURL = await svgToPngDataURL(svg, 1024);
    localStorage.setItem(ICON_KEY, pngURL);
    saveIconPrefs({style, color});
    setIcons(pngURL, svgURL);
    return {pngURL, svgURL};
  }

  async function initIcons(){
    const p = loadIconPrefs();
    $("iconStyle").value = p.style;
    $("iconColor").value = p.color;

    const cached = localStorage.getItem(ICON_KEY);
    if(cached){
      // set cached PNG, plus svg for crisp favicon
      const svg = iconSVG(p.style, p.color);
      setIcons(cached, svgToDataURL(svg));
      return;
    }
    // first run: generate default
    try{
      await applyIcon(p.style, p.color);
    }catch{
      // fallback: just svg as favicon
      const svg = iconSVG("B","#2563eb");
      setIcons("", svgToDataURL(svg));
    }
  }

  // ===== Crypto =====
  const SALT_KEY = NS+"::salt";
  const SESSION_KEY = NS+"::session_rawkey";

  async function deriveAesKeyFromPin(pin, saltBytes){
    const enc=new TextEncoder();
    const baseKey=await crypto.subtle.importKey("raw", enc.encode(pin), {name:"PBKDF2"}, false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      {name:"PBKDF2", salt:saltBytes, iterations:150000, hash:"SHA-256"},
      baseKey, {name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]
    );
  }
  async function exportRawKey(key){ return b64(await crypto.subtle.exportKey("raw", key)); }
  async function importRawKey(rawB64){
    return crypto.subtle.importKey("raw", ub64(rawB64), {name:"AES-GCM"}, true, ["encrypt","decrypt"]);
  }
  function getOrCreateSalt(){
    let s=localStorage.getItem(SALT_KEY);
    if(!s){ s=b64(rand(16)); localStorage.setItem(SALT_KEY,s); }
    return ub64(s);
  }
  async function ensureSessionKey(pin){
    const aes=await deriveAesKeyFromPin(pin, getOrCreateSalt());
    sessionStorage.setItem(SESSION_KEY, await exportRawKey(aes));
    return aes;
  }
  async function getSessionKey(){
    const raw=sessionStorage.getItem(SESSION_KEY);
    if(!raw) return null;
    try{ return await importRawKey(raw); }catch{ return null; }
  }
  async function encryptJson(aesKey, obj){
    const iv=rand(12);
    const enc=new TextEncoder();
    const pt=enc.encode(JSON.stringify(obj));
    const ct=await crypto.subtle.encrypt({name:"AES-GCM", iv}, aesKey, pt);
    return {v:1, iv:b64(iv), ct:b64(ct)};
  }
  async function decryptJson(aesKey, blob){
    const pt=await crypto.subtle.decrypt({name:"AES-GCM", iv:ub64(blob.iv)}, aesKey, ub64(blob.ct));
    return JSON.parse(new TextDecoder().decode(pt));
  }
  function yearKey(y){ return NS+"::year::"+y; }

  async function readYearState(y){
    const aes=await getSessionKey();
    if(!aes) throw new Error("LOCKED");
    const raw=localStorage.getItem(yearKey(y));
    if(!raw) return {emp:"", mgr:{name:"",mail:""}, E:[], A:[]};
    const tmp=await decryptJson(aes, JSON.parse(raw));
    return {
      emp: tmp.emp || "",
      mgr: tmp.mgr || {name:"",mail:""},
      E: Array.isArray(tmp.E)?tmp.E:[],
      A: Array.isArray(tmp.A)?tmp.A:[]
    };
  }
  async function writeYearState(y, state){
    const aes=await getSessionKey();
    if(!aes) throw new Error("LOCKED");
    const blob=await encryptJson(aes, state);
    localStorage.setItem(yearKey(y), JSON.stringify(blob));
  }

  // ===== App State =====
  let Y=new Date().getFullYear();
  let S={emp:"", mgr:{name:"",mail:""}, E:[], A:[]};
  let run=null;
  let editingId=null;

  function showOverlay(msg){
    $("ovl").style.display="flex";
    $("pinMsg").textContent="";
    $("pinInput").value="";
    $("ovlText").textContent=msg||`Bitte ${PIN_LEN}-stellige PIN eingeben.`;
    setTimeout(()=>$("pinInput").focus(),50);
  }
  function hideOverlay(){ $("ovl").style.display="none"; }

  function setTimerStatus(txt, cls){
    $("timerStatus").textContent = txt;
    $("timerStatus").className = "badge" + (cls ? (" "+cls) : "");
  }

  function tab(name){
    ["timer","overview","edit","absence","entries","settings"].forEach(id=>{
      $(id).style.display=(id===name)?"":"none";
    });
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===name));
  }
  document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>tab(t.dataset.tab));

  function getRefYear(){
    const v=$("refDate").value;
    return v ? d0(v).getFullYear() : new Date().getFullYear();
  }

  async function loadYear(y){
    Y=y; $("yearHint").textContent=`Jahr: ${Y}`;
    const aes=await getSessionKey();
    if(!aes){ showOverlay("Bitte PIN eingeben, um Daten zu laden."); return false; }

    const raw=localStorage.getItem(yearKey(Y));
    if(!raw){ S={emp:"",mgr:{name:"",mail:""},E:[],A:[]}; applyStateToUI(); return true; }

    try{
      S=await decryptJson(aes, JSON.parse(raw));
      S.emp=S.emp||""; S.mgr=S.mgr||{name:"",mail:""};
      S.E=Array.isArray(S.E)?S.E:[]; S.A=Array.isArray(S.A)?S.A:[];
      applyStateToUI(); return true;
    }catch{
      showOverlay("PIN falsch oder Daten nicht lesbar. Bitte erneut versuchen (oder Reset).");
      return false;
    }
  }

  async function saveYear(){
    const aes=await getSessionKey();
    if(!aes){ showOverlay("Bitte PIN eingeben, um zu speichern."); return false; }
    localStorage.setItem(yearKey(Y), JSON.stringify(await encryptJson(aes,S)));
    return true;
  }

  function applyStateToUI(){
    $("empName").value=S.emp||"";
    $("mgrName").value=S.mgr?.name||"";
    $("mgrMail").value=S.mgr?.mail||"";
    $("timerMini").textContent=S.emp?("ğŸ‘¤ "+S.emp):"";
    $("nameMsg").textContent=S.emp?"âœ… gespeichert":"";
  }

  // ===== PIN =====
  $("btnUnlock").onclick=async()=>{
    const pin=($("pinInput").value||"").trim();
    if(pin.length!==PIN_LEN||!/^\d+$/.test(pin)){ $("pinMsg").textContent=`PIN muss ${PIN_LEN} Ziffern haben.`; return; }
    await ensureSessionKey(pin);
    hideOverlay();
    await loadYear(getRefYear());
    await renderAll();
    tab("timer");
  };
  $("btnSetPin").onclick=async()=>{
    const pin=($("pinInput").value||"").trim();
    if(pin.length!==PIN_LEN||!/^\d+$/.test(pin)){ $("pinMsg").textContent=`PIN muss ${PIN_LEN} Ziffern haben.`; return; }
    await ensureSessionKey(pin);
    hideOverlay();
    await loadYear(getRefYear());
    await saveYear();
    await renderAll();
    alert("âœ… PIN gesetzt. Bitte merken!");
  };
  $("btnLock").onclick=()=>{
    sessionStorage.removeItem(SESSION_KEY);
    showOverlay("ğŸ”’ Gesperrt. Bitte PIN eingeben.");
  };

  // ===== Add to Home hint =====
  const isiOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  $("btnAddToHome").onclick = () => {
    if(isiOS){
      $("a2hsHint").style.display = "";
      alert("ğŸ“² iPhone/iPad: Tippe auf Teilen (â¬†ï¸) â†’ â€Zum Home-Bildschirmâ€œ.\nWenn du das Icon geÃ¤ndert hast: alte Kachel lÃ¶schen & neu hinzufÃ¼gen.");
    }else{
      alert("ğŸ“² Android/Chrome: MenÃ¼ â‹® â†’ â€Zum Startbildschirm hinzufÃ¼genâ€œ.");
    }
  };

  // ===== Name/Manager =====
  $("saveName").onclick=async()=>{ S.emp=($("empName").value||"").trim(); await saveYear(); applyStateToUI(); };
  $("saveMgr").onclick=async()=>{ S.mgr={name:($("mgrName").value||"").trim(), mail:($("mgrMail").value||"").trim()}; await saveYear(); alert("âœ… Manager gespeichert"); };

  // ===== Timer =====
  $("btnStart").onclick=async()=>{
    if(run) return alert("Timer lÃ¤uft schon.");
    if(!S.emp) return alert("Bitte Name speichern.");
    if(!$("timerDate").value) return alert("Bitte Datum wÃ¤hlen.");
    const entryYear=d0($("timerDate").value).getFullYear();
    if(entryYear!==Y){ const ok=await loadYear(entryYear); if(!ok) return; }

    const now=new Date(); now.setSeconds(0,0);
    const d=d0($("timerDate").value);
    const start=new Date(d.getFullYear(),d.getMonth(),d.getDate(),now.getHours(),now.getMinutes(),0,0);
    run={date:$("timerDate").value,start,pauseMin:0,pauseStart:null,note:($("timerNote").value||"").trim()};

    $("btnPause").disabled=false; $("btnPause").textContent="â¸ï¸ Pause";
    setTimerStatus("ğŸŸ¢ lÃ¤uft","chip-ok");
    $("timerInfo").textContent=`Start ${pad(start.getHours())}:${pad(start.getMinutes())}`;
  };

  $("btnPause").onclick=()=>{
    if(!run) return;
    const now=new Date(); now.setSeconds(0,0);
    if(!run.pauseStart){
      run.pauseStart=now; $("btnPause").textContent="â–¶ï¸ Weiter";
      setTimerStatus("â¸ï¸ Pause","chip-warn");
    }else{
      run.pauseMin += Math.max(0, Math.round((now-run.pauseStart)/60000));
      run.pauseStart=null; $("btnPause").textContent="â¸ï¸ Pause";
      setTimerStatus("ğŸŸ¢ lÃ¤uft","chip-ok");
    }
  };

  $("btnStop").onclick=async()=>{
    if(!run) return alert("Kein Timer lÃ¤uft.");
    const end=new Date(); end.setSeconds(0,0);
    if(run.pauseStart){
      run.pauseMin += Math.max(0, Math.round((end-run.pauseStart)/60000));
      run.pauseStart=null;
    }
    const gross=Math.round((end-run.start)/60000);
    if(gross<=0){ setTimerStatus("âŒ Zeit ungÃ¼ltig","chip-error"); return; }

    const auto=(gross>=AUTO_BREAK)?AUTO_BREAK:0;
    const pause=auto+run.pauseMin;

    S.E.push({id:(crypto.randomUUID?crypto.randomUUID():"id_"+Date.now()), d:run.date, s:run.start.toISOString(), e:end.toISOString(), p:pause, n:run.note||""});
    run=null;

    $("btnPause").disabled=true; $("btnPause").textContent="â¸ï¸ Pause";
    setTimerStatus("âœ… gespeichert","chip-ok");
    $("timerInfo").textContent="";
    await saveYear();
    await renderAll();
  };

  // ===== RÃ¼ckwirkend =====
  $("newManual").onclick=()=>{
    editingId=null; $("eStart").value=""; $("eEnd").value=""; $("eNote").value=""; $("editMsg").textContent="";
  };
  $("saveManual").onclick=async()=>{
    if(!$("eDate").value||!$("eStart").value||!$("eEnd").value) return;
    const d=$("eDate").value;
    const [sh,sm]=$("eStart").value.split(":").map(Number);
    const [eh,em]=$("eEnd").value.split(":").map(Number);
    const s=new Date(d0(d).setHours(sh,sm,0,0));
    const e=new Date(d0(d).setHours(eh,em,0,0));
    const gross=Math.round((e-s)/60000);
    if(gross<=0){ $("editMsg").textContent="âŒ Ende muss nach Start"; return; }

    const yr=d0(d).getFullYear();
    if(yr!==Y){ const ok=await loadYear(yr); if(!ok) return; }

    const obj={id:editingId||(crypto.randomUUID?crypto.randomUUID():"m_"+Date.now()), d, s:s.toISOString(), e:e.toISOString(), p:(gross>=AUTO_BREAK?AUTO_BREAK:0), n:($("eNote").value||"").trim()};
    if(editingId){
      const idx=S.E.findIndex(x=>x.id===editingId);
      if(idx>=0) S.E[idx]=obj; else S.E.push(obj);
      $("editMsg").textContent="âœ… aktualisiert";
    }else{
      S.E.push(obj); editingId=obj.id; $("editMsg").textContent="âœ… gespeichert";
    }
    await saveYear();
    await renderAll();
  };

  // ===== Abwesenheit: Ende folgt Start (Standard gleicher Tag) =====
  let aEndTouched = false;
  function resetAbsAutoEnd(todayStr){
    aEndTouched = false;
    $("aEnd").value = $("aStart").value || todayStr;
  }
  $("aEnd").addEventListener("change", ()=>{ aEndTouched = true; });
  $("aStart").addEventListener("change", ()=>{
    if(!aEndTouched) $("aEnd").value = $("aStart").value;
  });

  // Abwesenheit Zeitraum: pro Tag 1, neue Ã¼berschreibt
  $("addAbs").onclick=async()=>{
    $("absMsg").textContent="";
    const startV=$("aStart").value;
    const endV=$("aEnd").value;
    if(!startV || !endV) return alert("Start und Ende wÃ¤hlen.");
    const t=$("aType").value;

    const start=d0(startV);
    const end=d0(endV);
    if(end < start) return alert("Ende muss nach Start sein.");

    let added=0, replaced=0;
    const perYear = new Map();

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      if(!wd(d)) continue;                    // nur Mo-Fr
      const ds=toDateStr(d);
      const y=d.getFullYear();

      if(!perYear.has(y)){
        const st = await readYearState(y);
        perYear.set(y, st);
      }
      const st = perYear.get(y);

      // âœ… Ãœberschreiben: entferne alle Abwesenheiten am Tag
      const beforeLen = st.A.length;
      st.A = st.A.filter(a => a.d !== ds);
      const rem = beforeLen - st.A.length;
      if(rem>0) replaced += rem;

      st.A.push({id:(crypto.randomUUID?crypto.randomUUID():"a_"+Date.now()+Math.random()), d:ds, t});
      added++;
    }

    for(const [y, st] of perYear.entries()) await writeYearState(y, st);

    await loadYear(getRefYear());
    await renderAll();
    $("absMsg").textContent = `âœ… ${added} Tage gespeichert` + (replaced ? ` Â· â™»ï¸ ${replaced} Ã¼berschrieben` : "");
  };

  // Einzeltag lÃ¶schen
  $("delAbsDay").onclick=async()=>{
    $("absMsg").textContent="";
    const ds=$("aDelDate").value;
    if(!ds) return;
    const y=d0(ds).getFullYear();
    const st = await readYearState(y);
    const before=st.A.length;
    st.A = st.A.filter(a=>a.d!==ds);
    const removed = before - st.A.length;
    await writeYearState(y, st);

    await loadYear(getRefYear());
    await renderAll();
    $("absMsg").textContent = removed ? `ğŸ—‘ï¸ ${removed} Eintrag(e) am ${ds} gelÃ¶scht` : `â„¹ï¸ nichts gefunden am ${ds}`;
  };

  // ===== Reset =====
  $("btnResetThisYear").onclick=async()=>{
    const yr=getRefYear();
    if(confirm(`Wirklich alle Daten fÃ¼r ${yr} lÃ¶schen?`)){
      localStorage.removeItem(yearKey(yr));
      if(yr===Y){ S={emp:"",mgr:{name:"",mail:""},E:[],A:[]}; applyStateToUI(); }
      await renderAll(); alert("âœ… Jahr gelÃ¶scht");
    }
  };
  $("btnResetAll").onclick=async()=>{
    if(confirm("Wirklich ALLE Jahre lÃ¶schen?")){
      const del=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k && k.startsWith(NS+"::year::")) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      S={emp:"",mgr:{name:"",mail:""},E:[],A:[]};
      applyStateToUI();
      await renderAll();
      alert("âœ… Alles gelÃ¶scht");
    }
  };

  // ===== Overview ranges =====
  function weekRangeISO(ref){
    const d=new Date(ref); d.setHours(0,0,0,0);
    const monIndex=(d.getDay()+6)%7;
    const start=new Date(d); start.setDate(d.getDate()-monIndex);
    const end=new Date(start); end.setDate(start.getDate()+6);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function monthRange(ref){
    const d=new Date(ref);
    const start=new Date(d.getFullYear(),d.getMonth(),1);
    const end=new Date(d.getFullYear(),d.getMonth()+1,0);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function yearRange(y){
    const start=new Date(y,0,1); start.setHours(0,0,0,0);
    const end=new Date(y,11,31); end.setHours(0,0,0,0);
    return [start,end];
  }
  function isoWeekKey(dateObj){
    const d=new Date(dateObj); d.setHours(0,0,0,0);
    d.setDate(d.getDate()+3-((d.getDay()+6)%7));
    const y=d.getFullYear();
    const week1=new Date(y,0,4); week1.setHours(0,0,0,0);
    week1.setDate(week1.getDate()+3-((week1.getDay()+6)%7));
    const w=1+Math.round((d-week1)/(7*24*60*60*1000));
    return `${y}-W${pad(w)}`;
  }

  function getPeriodRange(){
    const v=$("refDate").value;
    const ref=v ? d0(v) : new Date();
    const yr=ref.getFullYear();
    let start,end;
    if($("mode").value==="year") [start,end]=yearRange(yr);
    else if($("mode").value==="month") [start,end]=monthRange(ref);
    else [start,end]=weekRangeISO(ref);
    return {yr,start,end};
  }

  async function getMergedForRange(start, end){
    const years = new Set([start.getFullYear(), end.getFullYear()]);
    const allE=[], allA=[];
    let emp=S.emp||"", mgr=S.mgr||{name:"",mail:""};
    for(const y of years){
      const st = await readYearState(y);
      if(!emp && st.emp) emp=st.emp;
      if((!mgr?.mail && st.mgr?.mail) || (!mgr?.name && st.mgr?.name)) mgr=st.mgr;
      allE.push(...(st.E||[]));
      allA.push(...(st.A||[]));
    }
    return {allE, allA, emp, mgr};
  }

  function chipClassByWeeklyTolerance(deltaMin, weeksEquivalent){
    const tol = TOL_WEEK_MIN * Math.max(1, weeksEquivalent);
    return (Math.abs(deltaMin) <= tol) ? "chip-ok" : "chip-warn";
  }

  async function renderOverviewTable(){
    const {start,end}=getPeriodRange();
    $("yearHint").textContent = `Bereich: ${start.getFullYear()}â€“${end.getFullYear()}`;

    const W=getWeeklyTargetMinutes();
    const DAY=W/5;

    const startS=toDateStr(start), endS=toDateStr(end);
    const merged = await getMergedForRange(start, end);
    const E = merged.allE;
    const A = merged.allA;

    const istBy={};
    for(const e of E){
      if(e.d < startS || e.d > endS) continue;
      const net=((new Date(e.e)-new Date(e.s))/60000) - (e.p||0);
      if(!Number.isFinite(net)) continue;
      istBy[e.d]=(istBy[e.d]||0)+Math.round(net);
    }

    const dayNames=["So","Mo","Di","Mi","Do","Fr","Sa"];
    let istSum=0, sollSum=0, workdays=0, weekendMin=0;

    let html=`<table><thead><tr>
      <th>Datum</th><th>Tag</th><th>IST</th><th>SOLL</th><th>Abw.</th><th>SALDO</th>
    </tr></thead><tbody>`;

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const ds=toDateStr(d);
      const ist=Number.isFinite(istBy[ds]) ? istBy[ds] : 0;
      const isW=wd(d);

      if(isWeekend(d) && ist>0) weekendMin += ist;

      const absTypes=A.filter(a=>a.d===ds).map(a=>a.t);
      const soll = Math.round(isW ? (absTypes.length>0 ? 0 : DAY) : 0);
      const saldo=ist-soll;

      istSum += ist;
      sollSum += soll;
      if(isW) workdays += 1;

      let abw = absTypes.length ? absTypes.map(absBadge).join(" ") : "";
      if(isWeekend(d) && ist>0) abw = (abw ? (abw+" ") : "") + weekendBadge();

      html+=`<tr>
        <td class="mono">${ds}</td>
        <td>${dayNames[d.getDay()]}</td>
        <td class="mono">${hhmm(ist)}</td>
        <td class="mono">${hhmm(soll)}</td>
        <td>${abw}</td>
        <td class="mono">${hhmm(saldo)}</td>
      </tr>`;
    }
    html+=`</tbody></table>`;
    $("overviewTable").innerHTML=html;

    const delta=istSum-sollSum;
    const weeksEq = workdays ? (workdays/5) : 1;

    $("summaryBar").style.display="";

    const sumCls = chipClassByWeeklyTolerance(delta, weeksEq);
    $("sumChip").className = "badge " + sumCls;
    $("sumChip").textContent = `IST ${hhmm(istSum)} Â· SOLL ${hhmm(sollSum)} Â· Î” ${hhmm(delta)} (Â±10:00/Woche)`;

    if($("mode").value==="week"){
      $("weekChip").style.display="";
      $("weekendChip").style.display="";
      const wCls = chipClassByWeeklyTolerance(delta, 1);
      $("weekChip").className = "badge " + wCls;
      $("weekChip").textContent = `Woche: IST ${hhmm(istSum)} Â· SOLL ${hhmm(sollSum)} Â· Î” ${hhmm(delta)}`;
      $("weekendChip").textContent = `ğŸŸ¦ Wochenende: ${hhmm(weekendMin)}`;
    }else{
      $("weekChip").style.display="none";
      $("weekendChip").style.display="none";
    }

    if($("mode").value==="month"){
      const weeks=new Map();
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const ds=toDateStr(d);
        const wk=isoWeekKey(d);
        if(!weeks.has(wk)) weeks.set(wk,{ist:0,weekdays:0,absDays:0});
        const b=weeks.get(wk);
        b.ist += (istBy[ds]||0);
        if(wd(d)){
          b.weekdays += 1;
          if(A.some(a=>a.d===ds)) b.absDays += 1;
        }
      }
      const active=[...weeks.values()].filter(w=>w.weekdays>0);
      const avgIst = active.length ? active.map(w=>w.ist*(5/w.weekdays)).reduce((s,v)=>s+v,0)/active.length : 0;
      const avgSoll= active.length ? active.map(w=>W - (w.absDays*(W/5))).reduce((s,v)=>s+v,0)/active.length : W;
      const dAvg=avgIst-avgSoll;

      const avgCls = chipClassByWeeklyTolerance(dAvg, 1);
      $("avgChip").style.display="";
      $("avgChip").className = "badge " + avgCls;
      $("avgChip").textContent = `Ã˜/Woche ${hhmm(avgIst)} (Soll ${hhmm(avgSoll)}) Â· Î” ${hhmm(dAvg)}`;
    }else{
      $("avgChip").style.display="none";
    }
  }

  // ===== Abwesenheit BlÃ¶cke (Anzeige) =====
  function renderAbsList(){
    if(!S.A.length){
      $("absList").innerHTML=`<div class="muted">Keine Abwesenheiten im Jahr ${Y}.</div>`;
      return;
    }
    const arr = S.A.slice().sort((a,b)=>a.d.localeCompare(b.d));
    const blocks=[]; let cur=null;

    function nextWorkdayStr(ds){
      let d=d0(ds);
      do{ d.setDate(d.getDate()+1); }while(!wd(d));
      return toDateStr(d);
    }

    for(const x of arr){
      if(!cur){ cur={t:x.t,start:x.d,end:x.d,ids:[x.id],days:1}; continue; }
      const expected=nextWorkdayStr(cur.end);
      if(x.t===cur.t && x.d===expected){
        cur.end=x.d; cur.ids.push(x.id); cur.days+=1;
      }else{
        blocks.push(cur);
        cur={t:x.t,start:x.d,end:x.d,ids:[x.id],days:1};
      }
    }
    if(cur) blocks.push(cur);

    const rows=blocks.map((b,i)=>{
      const range=(b.start===b.end)?b.start:`${b.start}â€“${b.end}`;
      return `<tr>
        <td class="mono">${range}</td>
        <td>${absBadge(b.t)} <span class="muted">(${b.days} WT)</span></td>
        <td><button class="btn-ghost btn-sm" data-del-block="${i}">ğŸ—‘ï¸</button></td>
      </tr>`;
    }).join("");

    $("absList").innerHTML=`<table>
      <thead><tr><th>Zeitraum</th><th>Typ</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;

    document.querySelectorAll("[data-del-block]").forEach(btn=>{
      btn.onclick=async()=>{
        const idx=Number(btn.getAttribute("data-del-block"));
        const ids=new Set(blocks[idx].ids);
        S.A=S.A.filter(x=>!ids.has(x.id));
        await saveYear();
        await renderAll();
      };
    });
  }

  // ===== Entry List =====
  function renderEntryList(){
    const entries=S.E.slice().sort((a,b)=>b.d.localeCompare(a.d));
    if(!entries.length){
      $("entryList").innerHTML=`<div class="muted">Noch keine EintrÃ¤ge im Jahr ${Y}.</div>`;
      return;
    }
    const rows=entries.map(e=>{
      const net=((new Date(e.e)-new Date(e.s))/60000) - (e.p||0);
      return `<tr>
        <td class="mono">${e.d}</td>
        <td class="mono">Netto ${hhmm(net)} Â· Pause ${hhmm(e.p||0)} Â· ${e.n||""}</td>
        <td>
          <button class="btn-ghost btn-sm" data-edit="${e.id}">âœï¸</button>
          <button class="btn-ghost btn-sm" data-del="${e.id}">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    }).join("");

    $("entryList").innerHTML=`<table>
      <thead><tr><th>Datum</th><th>Info</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;

    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=async()=>{
        const id=b.getAttribute("data-del");
        S.E=S.E.filter(x=>x.id!==id);
        await saveYear();
        await renderAll();
      };
    });
    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const id=b.getAttribute("data-edit");
        const e=S.E.find(x=>x.id===id);
        if(!e) return;
        editingId=id;
        $("eDate").value=e.d;
        const s=new Date(e.s), en=new Date(e.e);
        $("eStart").value=`${pad(s.getHours())}:${pad(s.getMinutes())}`;
        $("eEnd").value=`${pad(en.getHours())}:${pad(en.getMinutes())}`;
        $("eNote").value=e.n||"";
        $("editMsg").textContent="Bearbeiten aktiv";
        tab("edit");
      };
    });
  }

  async function renderAll(){
    applyStateToUI();
    await renderOverviewTable();
    renderAbsList();
    renderEntryList();
  }

  // ===== CSV / Share =====
  async function getMergedForCurrentRange(){
    const {start,end}=getPeriodRange();
    const merged=await getMergedForRange(start,end);
    return {start,end,merged};
  }

  function buildCSVForRange(merged, start, end){
    const sep=";";
    const W=getWeeklyTargetMinutes();
    const emp=(merged.emp||S.emp||"");
    const mgr=(merged.mgr||S.mgr||{name:"",mail:""});
    const startS=toDateStr(start), endS=toDateStr(end);

    const rows=[];
    rows.push(["Mitarbeiter","Von","Bis","WochenSoll_min","Datum","Start","Ende","Pause_min","Netto_min","Netto_hhmm","Notiz","ManagerName","ManagerMail"].join(sep));

    const entries=merged.allE.filter(e=>e.d>=startS && e.d<=endS).sort((a,b)=>a.d.localeCompare(b.d));
    for(const e of entries){
      const net=((new Date(e.e)-new Date(e.s))/60000)-(e.p||0);
      const d = d0(e.d);
      const wkHint = isWeekend(d) ? "Wochenende" : "";
      const note = [wkHint, (e.n||"")].filter(Boolean).join(" Â· ");

      rows.push([
        csvSafeCell(emp), startS, endS, String(W),
        e.d, e.s, e.e, String(e.p||0),
        Number.isFinite(net)?String(Math.round(net)):"",
        hhmm(net),
        csvSafeCell(note),
        csvSafeCell(mgr?.name||""),
        csvSafeCell(mgr?.mail||"")
      ].join(sep));
    }

    const abs=merged.allA.filter(a=>a.d>=startS && a.d<=endS).sort((a,b)=>a.d.localeCompare(b.d));
    for(const a of abs){
      rows.push([
        csvSafeCell(emp), startS, endS, String(W),
        a.d, "", "", "0", "0", "00:00",
        csvSafeCell("Abwesenheit: "+absLabel(a.t)),
        csvSafeCell(mgr?.name||""),
        csvSafeCell(mgr?.mail||"")
      ].join(sep));
    }
    return rows.join("\n");
  }

  async function downloadCSV(){
    const {start,end,merged}=await getMergedForCurrentRange();
    if(!(merged.emp||S.emp)) return alert("Bitte Name speichern.");
    const csv=buildCSVForRange(merged,start,end);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`Zeiterfassung_${toDateStr(start)}_${toDateStr(end)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  async function shareCSV(){
    const {start,end,merged}=await getMergedForCurrentRange();
    if(!(merged.emp||S.emp)) return alert("Bitte Name speichern.");
    const csv=buildCSVForRange(merged,start,end);
    const file=new File([new Blob([csv],{type:"text/csv"})], "zeiterfassung.csv", {type:"text/csv"});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:`Zeiterfassung â€“ ${merged.emp||S.emp}`, files:[file]});
      return;
    }
    alert("Teilen nicht verfÃ¼gbar. Bitte CSV herunterladen und manuell senden.");
  }

  $("btnCSV").onclick=downloadCSV;
  $("btnShare").onclick=shareCSV;
  $("btnRefresh").onclick=renderAll;
  $("mode").onchange=renderAll;
  $("weeklyTarget").onchange=renderAll;

  $("refDate").onchange=async()=>{
    await loadYear(getRefYear());
    await renderAll();
  };

  // ===== Icon Settings UI =====
  $("btnApplyIcon").onclick = async()=>{
    try{
      const style = $("iconStyle").value;
      const color = $("iconColor").value;
      await applyIcon(style, color);
      $("iconMsg").textContent = "âœ… Icon gespeichert";
      alert("âœ¨ Icon angewendet.\nJetzt iPhone: Home-Icon lÃ¶schen & Seite neu â€Zum Home-Bildschirmâ€œ hinzufÃ¼gen.");
    }catch(e){
      $("iconMsg").textContent = "âŒ Icon Fehler";
      alert("Icon konnte nicht erzeugt werden.");
    }
  };

  $("btnDownloadIcon").onclick = async()=>{
    try{
      const p = loadIconPrefs();
      const svg = iconSVG(p.style, p.color);
      const png = await svgToPngDataURL(svg, 1024);
      const a=document.createElement("a");
      a.href=png;
      a.download="icon_1024.png";
      document.body.appendChild(a); a.click(); a.remove();
    }catch{
      alert("PNG Download nicht mÃ¶glich.");
    }
  };

  // ===== Init defaults =====
  const today=new Date().toISOString().slice(0,10);
  $("timerDate").value=today;
  $("refDate").value=today;
  $("eDate").value=today;
  $("aStart").value=today;
  $("aEnd").value=today;
  $("aDelDate").value=today;
  resetAbsAutoEnd(today);

  $("btnPause").disabled=true;
  setTimerStatus("âšª bereit","");

  // ===== Boot =====
  (async()=>{
    await initIcons();

    const k=await getSessionKey();
    if(!k){ showOverlay("Bitte PIN setzen oder eingeben, um zu starten."); return; }
    await loadYear(getRefYear());
    await renderAll();
    tab("timer");
  })();

})();
</script>

</body>
</html>
