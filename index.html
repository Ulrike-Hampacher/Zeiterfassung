<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Zeiterfassung</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Zeiterfassung" />
<meta name="theme-color" content="#0b1220" />
<meta name="robots" content="noindex,nofollow" />

<link id="appleIcon" rel="apple-touch-icon" href="" />
<link id="faviconIcon" rel="icon" href="" />

<style>
:root{
  --bg:#f4f6f8; --card:#fff; --text:#0f172a; --muted:#64748b;
  --line:#e5e7eb;
  --ok:#166534; --okbg:#dcfce7;
  --warn:#9a3412; --warnbg:#fff7ed;
  --primary:#2563eb;
  --chip:#eef2ff;
  --shadow:0 2px 12px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:-apple-system,system-ui;background:var(--bg);color:var(--text)}
.card{background:var(--card);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:var(--shadow)}
h1{margin:0 0 6px 0;font-size:20px}
h2{margin:6px 0 10px 0;font-size:16px}
.muted{color:var(--muted);font-size:13px}
.mono{font-family:ui-monospace,Menlo,monospace}

.row{display:flex;flex-wrap:wrap;align-items:flex-end;column-gap:10px;row-gap:12px}
.right{margin-left:auto}

input,select,button,textarea{
  font-size:16px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff
}
textarea{resize:none}
button{border:none;font-weight:800;cursor:pointer}
button:disabled{opacity:.55;cursor:not-allowed}

.btn-start{background:#16a34a;color:#fff}
.btn-pause{background:#111827;color:#fff}
.btn-stop{background:#dc2626;color:#fff}
.btn-blue{background:var(--primary);color:#fff}
.btn-ghost{background:#eef2f7;color:#0f172a}
.btn-sm{padding:8px 10px;font-size:14px;border-radius:10px}

.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:10px 14px;border-radius:12px;background:#eef2f7;cursor:pointer}
.tab.active{background:#111;color:#fff}

.badge{
  display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;
  font-size:12px;font-weight:900;background:var(--chip);
  border:1px solid rgba(0,0,0,.06);white-space:nowrap
}
.chip-ok{background:var(--okbg);color:var(--ok)}
.chip-warn{background:var(--warnbg);color:var(--warn)}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:14px;vertical-align:top}
th{text-align:left;color:#64748b}

.w-emp{width:220px;max-width:220px}
.w-note{width:160px;max-width:160px}
.w-save{width:170px;max-width:170px}
.w-edit-note{width:220px;max-width:220px;height:44px}

.w-mgr-name{width:190px;max-width:190px;margin-left:-7px}
.w-mgr-mail{width:360px;max-width:88vw;min-width:320px;margin-left:-9px}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px}
.modal{width:min(560px,100%);background:#fff;border-radius:16px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.25)}
.modal h2{margin-top:0}
.pin{width:min(360px,86vw);max-width:86vw;letter-spacing:.08em;font-weight:900;text-align:center;font-size:18px;padding:10px 12px}

@media(max-width:340px){
  .w-emp{width:210px;max-width:210px}
  .w-note{width:150px;max-width:150px}
  .w-edit-note{width:200px;max-width:200px}
  .w-mgr-name{width:180px;max-width:180px;margin-left:-7px}
  .w-mgr-mail{min-width:320px}
}

/* ===== PRINT/PDF ===== */
@media print{
  body{background:#fff;padding:0}
  .card{box-shadow:none;border-radius:0;margin:0 0 12px 0}
  #tabsCard, #timer, #edit, #absence, #entries, #settings, #ovl {display:none !important;}
  #overview{display:block !important;}
  #overviewControls, #mgrControls, #btnRefresh, #btnCSV, #btnShare, #btnPDF {display:none !important;}
  #appHeader{display:block !important;}
  #topHint{display:none !important;}
  a[href]:after{content:""}
  table{page-break-inside:auto}
  tr{page-break-inside:avoid;page-break-after:auto}
}
</style>
</head>

<body>

<div class="card" id="appHeader">
  <h1 id="appTitle">Zeiterfassung</h1>
  <div class="muted" id="topHint"></div>
</div>

<div class="card" id="tabsCard">
  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="timer"></div>
    <div class="tab" data-tab="overview"></div>
    <div class="tab" data-tab="edit"></div>
    <div class="tab" data-tab="absence"></div>
    <div class="tab" data-tab="entries"></div>
    <div class="tab" data-tab="settings"></div>
  </div>
</div>

<!-- TIMER -->
<div class="card" id="timer">
  <h2 id="hTimer"></h2>

  <div class="row" style="margin-bottom:10px">
    <div class="muted" style="width:100%" id="lblEmp"></div>
    <input id="empName" class="w-emp" placeholder="Vorname Nachname" />
    <button class="btn-ghost w-save" id="saveName"></button>
    <span class="right muted mono" id="timerMini"></span>
  </div>
  <div class="muted" id="nameMsg"></div>

  <div class="row" style="margin-top:12px">
    <div>
      <div class="muted" id="lblDate"></div>
      <input type="date" id="timerDate" />
    </div>
    <div>
      <div class="muted" id="lblNote"></div>
      <input id="timerNote" class="w-note" placeholder="kurz" />
    </div>
    <span class="right muted mono" id="timerInfo"></span>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="btn-start" id="btnStart"></button>
    <button class="btn-pause" id="btnPause" disabled></button>
    <button class="btn-stop" id="btnStop"></button>
    <span class="badge" id="timerStatus"></span>
  </div>
</div>

<!-- OVERVIEW -->
<div class="card" id="overview" style="display:none">
  <h2 id="hOverview"></h2>

  <div class="row" id="overviewControls">
    <div>
      <div class="muted" id="lblMode"></div>
      <select id="mode">
        <option value="week"></option>
        <option value="month"></option>
        <option value="year"></option>
      </select>
    </div>
    <div>
      <div class="muted" id="lblRef"></div>
      <input type="date" id="refDate" />
    </div>
    <div>
      <div class="muted" id="lblTarget"></div>
      <select id="weeklyTarget">
        <option value="2400">40:00 üá©üá™</option>
        <option value="2310">38:30 üá¶üáπ</option>
      </select>
    </div>

    <button class="btn-ghost" id="btnRefresh"></button>
    <button class="btn-blue" id="btnCSV"></button>
    <button class="btn-ghost" id="btnShare"></button>
    <button class="btn-ghost" id="btnPDF"></button>
    <span class="right muted mono" id="rangeHint"></span>
  </div>

  <div class="row" style="margin-top:12px">
    <span class="badge" id="sumChip">‚Äî</span>
    <span class="badge right" id="avgChip" style="display:none">‚Äî</span>
  </div>

  <div style="margin-top:14px">
    <h2 id="hMgr"></h2>
    <div class="row" id="mgrControls">
      <div class="muted" style="width:100%" id="lblMgrName"></div>
      <input id="mgrName" class="w-mgr-name" placeholder="Name" />
      <div class="muted" style="width:100%" id="lblMgrMail"></div>
      <input id="mgrMail" class="w-mgr-mail" placeholder="vorname.nachname@firma.de" />
      <button class="btn-ghost w-save" id="saveMgr"></button>
    </div>
  </div>

  <div id="overviewTable" style="margin-top:12px"></div>
</div>

<!-- EDIT -->
<div class="card" id="edit" style="display:none">
  <h2 id="hEdit"></h2>
  <div class="row">
    <div><div class="muted" id="lblEDate"></div><input type="date" id="eDate" /></div>
    <div><div class="muted" id="lblEStart"></div><input type="time" id="eStart" /></div>
    <div><div class="muted" id="lblEEnd"></div><input type="time" id="eEnd" /></div>
    <div><div class="muted" id="lblENote"></div><input id="eNote" class="w-edit-note" placeholder="optional" /></div>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn-ghost" id="saveManual"></button>
    <button class="btn-ghost" id="newManual"></button>
    <span class="right muted mono" id="editMsg"></span>
  </div>
</div>

<!-- ABSENCE -->
<div class="card" id="absence" style="display:none">
  <h2 id="hAbs"></h2>
  <div class="muted" id="absHint"></div>

  <div class="row" style="margin-top:10px" id="absRow1">
    <div><div class="muted" id="lblAStart"></div><input type="date" id="aStart" /></div>
    <div><div class="muted" id="lblAEnd"></div><input type="date" id="aEnd" /></div>
    <div>
      <div class="muted" id="lblAType"></div>
      <select id="aType">
        <option value="vac"></option>
        <option value="sick"></option>
        <option value="hol"></option>
      </select>
    </div>
    <button class="btn-ghost" id="addAbs"></button>
  </div>

  <div class="row" style="margin-top:12px" id="absRow2">
    <div><div class="muted" id="lblADel"></div><input type="date" id="aDelDate" /></div>
    <button class="btn-ghost" id="delAbsDay"></button>
    <span class="right muted mono" id="absMsg"></span>
  </div>

  <div id="absList" style="margin-top:12px"></div>
</div>

<!-- ENTRIES -->
<div class="card" id="entries" style="display:none">
  <h2 id="hEntries"></h2>

  <div class="row" id="entriesControls">
    <div>
      <div class="muted" id="lblEntriesFilter"></div>
      <select id="entriesFilter">
        <option value="week"></option>
        <option value="month"></option>
        <option value="year"></option>
        <option value="custom"></option>
      </select>
    </div>

    <div id="entriesFromWrap" style="display:none">
      <div class="muted" id="lblEntriesFrom"></div>
      <input type="date" id="entriesFrom" />
    </div>

    <div id="entriesToWrap" style="display:none">
      <div class="muted" id="lblEntriesTo"></div>
      <input type="date" id="entriesTo" />
    </div>

    <div class="right">
      <div class="muted" id="lblEntriesSearch"></div>
      <input id="entriesSearch" placeholder="..." />
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <span class="badge" id="entriesSum">‚Äî</span>
    <button class="btn-ghost right" id="entriesExportCSV"></button>
  </div>

  <div id="entryList" style="margin-top:12px"></div>
</div>

<!-- SETTINGS -->
<div class="card" id="settings" style="display:none">
  <h2 id="hSettings"></h2>
  <div class="muted" id="secHint"></div>

  <div class="row" style="margin-top:12px">
    <button class="btn-ghost" id="btnLock"></button>
    <button class="btn-ghost" id="btnChangePin"></button>
    <button class="btn-ghost" id="btnNewRecovery"></button>
  </div>

  <div class="row" style="margin-top:12px">
    <div>
      <div class="muted" id="lblEmoji"></div>
      <select id="emojiMode">
        <option value="fun">Mehr</option>
        <option value="pro">Weniger</option>
        <option value="off">Aus</option>
      </select>
    </div>
    <div>
      <div class="muted" id="lblHeaderMode"></div>
      <select id="headerMode">
        <option value="full">Gro√ü</option>
        <option value="compact">Kompakt</option>
        <option value="off">Aus</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="btn-stop" id="btnResetThisYear"></button>
    <button class="btn-ghost" id="btnResetAll"></button>
  </div>
</div>

<!-- PIN Overlay -->
<div class="overlay" id="ovl">
  <div class="modal">
    <h2 id="pinTitle">Zeiterfassung entsperren</h2>
    <div class="muted" id="ovlText">Bitte PIN eingeben.</div>

    <div style="margin-top:10px;display:flex;justify-content:center">
      <input id="pinInput" class="pin" inputmode="text" maxlength="80" placeholder="PIN oder Recovery-Key" autocomplete="off" />
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <div class="muted" id="lblAuthMode"></div>
        <select id="authMode">
          <option value="pin">PIN</option>
          <option value="recovery">Recovery-Key</option>
        </select>
      </div>
      <span class="right muted mono" id="pinMsg"></span>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn-blue" id="btnUnlock">Entsperren</button>
      <button class="btn-ghost" id="btnSetPin">PIN setzen</button>
      <button class="btn-ghost" id="btnCopyRecovery" style="display:none">Recovery kopieren</button>
    </div>

    <div class="muted" style="margin-top:10px" id="pinFooter"></div>

    <div class="card" id="recoveryBox" style="display:none;margin-top:12px;background:#fbfbfb">
      <h2 id="recoveryTitle">Dein Recovery-Key</h2>
      <div class="muted" id="recoveryHint">Bitte in Passwortmanager speichern.</div>
      <div class="mono" id="recoveryText" style="margin-top:8px;font-size:16px;font-weight:900"></div>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== Config =====
  const NS="ZEITERFASSUNG";
  const AUTO_BREAK=55;     // min (Auto-Abzug)
  const TOL_WEEK_MIN=600;  // +-10h

  const EMOJI_PREF = NS+"::emoji_mode";
  const HEADER_PREF= NS+"::header_mode";

  const VAULT_KEY = NS+"::vault_v1";
  const SESSION_MASTER = NS+"::session_master_raw";
  const HOME_ICON_PNG_KEY = NS+"::home_icon_blue_clock_yellowz_png";

  const $=id=>document.getElementById(id);
  const pad=n=>String(n).padStart(2,"0");
  const b64 = (buf)=>btoa(String.fromCharCode(...new Uint8Array(buf)));
  const ub64 = (s)=>Uint8Array.from(atob(s), c=>c.charCodeAt(0));
  const rand = (n)=>crypto.getRandomValues(new Uint8Array(n));
  const toDateStr=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const d0=(s)=>{ const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); };
  const wd=(d)=> d.getDay()>=1 && d.getDay()<=5;
  const isWeekend=(d)=> d.getDay()===0 || d.getDay()===6;

  const hhmm=(m)=>{
    if(!Number.isFinite(m)) return "--:--";
    const s=m<0?"-":"";
    m=Math.abs(Math.round(m));
    return s + pad(Math.floor(m/60)) + ":" + pad(m%60);
  };
  const safeText=(s)=> (s??"").toString();

  function getEmojiMode(){ return localStorage.getItem(EMOJI_PREF) || "fun"; }   // fun|pro|off
  function getHeaderMode(){ return localStorage.getItem(HEADER_PREF) || "full"; } // full|compact|off
  function eOn(){ return getEmojiMode()!=="off"; }
  function ePro(){ return getEmojiMode()==="pro"; }

  // ===== Central Emoji/Text map (ALL places use this) =====
  const T = {
    tabs:{
      timer:{fun:"‚è±Ô∏è Timer", pro:"Timer", off:"Timer"},
      overview:{fun:"üìä √úbersicht", pro:"√úbersicht", off:"√úbersicht"},
      edit:{fun:"üóìÔ∏è R√ºckwirkend", pro:"R√ºckwirkend", off:"R√ºckwirkend"},
      absence:{fun:"üèñÔ∏è Abwesenheit", pro:"Abwesenheit", off:"Abwesenheit"},
      entries:{fun:"üßæ Eintr√§ge", pro:"Eintr√§ge", off:"Eintr√§ge"},
      settings:{fun:"‚öôÔ∏è Settings", pro:"Settings", off:"Settings"},
    },
    headings:{
      timer:{fun:"‚è±Ô∏è Timer", pro:"Timer", off:"Timer"},
      overview:{fun:"üìä √úbersicht", pro:"√úbersicht", off:"√úbersicht"},
      edit:{fun:"üóìÔ∏è R√ºckwirkend", pro:"R√ºckwirkend", off:"R√ºckwirkend"},
      absence:{fun:"üèñÔ∏è Abwesenheit", pro:"Abwesenheit", off:"Abwesenheit"},
      entries:{fun:"üßæ Eintr√§ge", pro:"Eintr√§ge", off:"Eintr√§ge"},
      settings:{fun:"‚öôÔ∏è Settings", pro:"Settings", off:"Settings"},
      manager:{fun:"üëî Manager", pro:"Manager", off:"Manager"},
    },
    labels:{
      emp:{fun:"üë§ Mitarbeiter", pro:"Mitarbeiter", off:"Mitarbeiter"},
      date:{fun:"üìÖ Datum", pro:"Datum", off:"Datum"},
      note:{fun:"üìù Notiz", pro:"Notiz", off:"Notiz"},
      mode:{fun:"üß≠ Modus", pro:"Modus", off:"Modus"},
      ref:{fun:"üìÖ Datum", pro:"Datum", off:"Datum"},
      target:{fun:"üéØ Wochen-Soll", pro:"Wochen-Soll", off:"Wochen-Soll"},
      mgrName:{fun:"üëî Name", pro:"Name", off:"Name"},
      mgrMail:{fun:"‚úâÔ∏è E-Mail", pro:"E-Mail", off:"E-Mail"},
      eDate:{fun:"üìÖ Datum", pro:"Datum", off:"Datum"},
      eStart:{fun:"‚è±Ô∏è Start", pro:"Start", off:"Start"},
      eEnd:{fun:"‚èπÔ∏è Ende", pro:"Ende", off:"Ende"},
      eNote:{fun:"üìù Notiz", pro:"Notiz", off:"Notiz"},
      aStart:{fun:"üìÖ Start", pro:"Start", off:"Start"},
      aEnd:{fun:"üìÖ Ende", pro:"Ende", off:"Ende"},
      aType:{fun:"üè∑Ô∏è Typ", pro:"Typ", off:"Typ"},
      aDel:{fun:"üóëÔ∏è Einzeltag l√∂schen", pro:"Einzeltag l√∂schen", off:"Einzeltag l√∂schen"},
      authMode:{fun:"üîê Entsperren mit", pro:"Entsperren mit", off:"Entsperren mit"},
      emoji:{fun:"üòä Emojis", pro:"Emojis", off:"Emojis"},
      header:{fun:"üßæ Header", pro:"Header", off:"Header"},
      entriesFilter:{fun:"üß© Filter", pro:"Filter", off:"Filter"},
      entriesFrom:{fun:"üìÖ Von", pro:"Von", off:"Von"},
      entriesTo:{fun:"üìÖ Bis", pro:"Bis", off:"Bis"},
      entriesSearch:{fun:"üîé Suche (Notiz)", pro:"Suche (Notiz)", off:"Suche (Notiz)"},
    },
    options:{
      week:{fun:"üìÜ Woche", pro:"Woche", off:"Woche"},
      month:{fun:"üóìÔ∏è Monat", pro:"Monat", off:"Monat"},
      year:{fun:"üìÖ Jahr", pro:"Jahr", off:"Jahr"},
      custom:{fun:"üß∑ Zeitraum", pro:"Zeitraum", off:"Zeitraum"},
      vac:{fun:"üèñÔ∏è Urlaub", pro:"Urlaub", off:"Urlaub"},
      sick:{fun:"ü§í Krank", pro:"Krank", off:"Krank"},
      hol:{fun:"üéâ Feiertag", pro:"Feiertag", off:"Feiertag"},
    },
    btn:{
      save:{fun:"üíæ Speichern", pro:"Speichern", off:"Speichern"},
      start:{fun:"‚ñ∂Ô∏è Start", pro:"Start", off:"Start"},
      pause:{fun:"‚è∏Ô∏è Pause", pro:"Pause", off:"Pause"},
      resume:{fun:"‚ñ∂Ô∏è Weiter", pro:"Weiter", off:"Weiter"},
      stop:{fun:"‚èπÔ∏è Stop", pro:"Stop", off:"Stop"},
      refresh:{fun:"üîÑ", pro:"‚Üª", off:"‚Üª"},
      csv:{fun:"‚¨áÔ∏è CSV", pro:"CSV", off:"CSV"},
      share:{fun:"üì§ Teilen", pro:"Teilen", off:"Teilen"},
      pdf:{fun:"üñ®Ô∏è PDF", pro:"PDF", off:"PDF"},
      new:{fun:"üÜï Neu", pro:"Neu", off:"Neu"},
      del:{fun:"üóëÔ∏è L√∂schen", pro:"L√∂schen", off:"L√∂schen"},
      lock:{fun:"üîí Sperren", pro:"Sperren", off:"Sperren"},
      pinchg:{fun:"üîÅ PIN √§ndern", pro:"PIN √§ndern", off:"PIN √§ndern"},
      rec:{fun:"üß© Recovery-Key", pro:"Recovery-Key", off:"Recovery-Key"},
      yearReset:{fun:"üßπ Jahr l√∂schen", pro:"Jahr l√∂schen", off:"Jahr l√∂schen"},
      allReset:{fun:"üß® Alles l√∂schen", pro:"Alles l√∂schen", off:"Alles l√∂schen"},
      edit:{fun:"‚úçÔ∏è", pro:"Edit", off:"Edit"},
      trash:{fun:"üóëÔ∏è", pro:"Del", off:"Del"},
    },
    status:{
      ready:{fun:"‚ö™ bereit", pro:"bereit", off:"bereit"},
      running:{fun:"üü¢ l√§uft", pro:"l√§uft", off:"l√§uft"},
      paused:{fun:"‚è∏Ô∏è Pause", pro:"Pause", off:"Pause"},
      saved:{fun:"‚úÖ gespeichert", pro:"gespeichert", off:"gespeichert"},
    },
    hint:{
      top:{fun:"‚ú® Offline ¬∑ üîê PIN+Recovery ¬∑ ‚è≥ Auto-Pause 55 min ¬∑ üßæ Eintr√§ge vollst√§ndig ¬∑ üñ®Ô∏è PDF",
           pro:"Offline ¬∑ PIN+Recovery ¬∑ Auto-Pause 55 min ¬∑ Eintr√§ge ¬∑ PDF",
           off:"Offline ¬∑ PIN+Recovery ¬∑ Auto-Pause 55 min ¬∑ Eintr√§ge ¬∑ PDF"},
      abs:{fun:"üìÜ Zeitraum ¬∑ Mo‚ÄìFr ¬∑ pro Tag max. 1 (√ºberschreibt doppelte Eintr√§ge)",
           pro:"Zeitraum ¬∑ Mo‚ÄìFr ¬∑ pro Tag max. 1 (√ºberschreibt doppelte Eintr√§ge)",
           off:"Zeitraum ¬∑ Mo‚ÄìFr ¬∑ pro Tag max. 1 (√ºberschreibt doppelte Eintr√§ge)"},
      sec:{fun:"üîê Lokal verschl√ºsselt ¬∑ Entsperrt bleibt bis Safari geschlossen wird",
           pro:"Lokal verschl√ºsselt ¬∑ Entsperrt bleibt bis Safari geschlossen wird",
           off:"Lokal verschl√ºsselt ¬∑ Entsperrt bleibt bis Safari geschlossen wird"},
      pinFooter:{fun:"üß© PIN vergessen? ‚Üí Recovery-Key nutzen. PIN+Recovery vergessen ‚Üí nur Reset (Daten weg).",
                 pro:"PIN vergessen? ‚Üí Recovery-Key nutzen. PIN+Recovery vergessen ‚Üí nur Reset (Daten weg).",
                 off:"PIN vergessen? ‚Üí Recovery-Key nutzen. PIN+Recovery vergessen ‚Üí nur Reset (Daten weg)."},
    }
  };
  const tr = (obj)=> obj[getEmojiMode()] ?? obj.pro ?? "";

  // ===== Tabs =====
  function tab(name){
    ["timer","overview","edit","absence","entries","settings"].forEach(id=>{
      $(id).style.display=(id===name)?"":"none";
    });
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===name));
  }
  document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>tab(t.dataset.tab));

  // ===== Icon (Blue + central clock + glowing yellow Z) =====
  function svgToDataURL(svg){ return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim()); }
  async function svgToPngDataURL(svg, size=1024){
    const img = new Image();
    img.decoding="async";
    const url = svgToDataURL(svg);
    await new Promise((res, rej)=>{ img.onload=res; img.onerror=()=>rej(new Error("ICON")); img.src=url; });
    const canvas=document.createElement("canvas");
    canvas.width=size; canvas.height=size;
    const ctx=canvas.getContext("2d");
    ctx.drawImage(img,0,0,size,size);
    return canvas.toDataURL("image/png");
  }

  function homeIconSVG_BlueClock_GlowYellowZ(){
    const blue1="#0ea5e9", blue2="#2563eb";
    const dark="#0b1220";
    const yellow="#facc15";
    const white="#e5e7eb";
    return `
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="${blue1}"/>
      <stop offset="1" stop-color="${blue2}"/>
    </linearGradient>
    <radialGradient id="shine" cx="50%" cy="30%" r="70%">
      <stop offset="0" stop-color="rgba(255,255,255,0.28)"/>
      <stop offset="1" stop-color="rgba(255,255,255,0)"/>
    </radialGradient>

    <filter id="shadow" x="-25%" y="-25%" width="150%" height="150%">
      <feDropShadow dx="0" dy="22" stdDeviation="18" flood-color="#000" flood-opacity=".22"/>
    </filter>

    <filter id="zglow" x="-35%" y="-35%" width="170%" height="170%">
      <feGaussianBlur stdDeviation="14" result="b"/>
      <feColorMatrix in="b" type="matrix"
        values="1 0 0 0 0
                0 0.9 0 0 0
                0 0 0.1 0 0
                0 0 0 1 0" result="g"/>
      <feMerge>
        <feMergeNode in="g"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>

  <rect width="1024" height="1024" rx="220" fill="url(#bg)"/>
  <rect width="1024" height="1024" rx="220" fill="url(#shine)"/>

  <!-- Z (gelb, glow) leicht hinter der Uhr -->
  <g filter="url(#zglow)" opacity="0.95">
    <path d="M250 290H774V404L480 668H774V782H250V670L545 406H250V290Z"
      fill="${yellow}"/>
  </g>

  <!-- Uhr zentral -->
  <g filter="url(#shadow)">
    <circle cx="512" cy="540" r="270" fill="rgba(11,18,32,0.20)" stroke="rgba(255,255,255,0.40)" stroke-width="10"/>
    <circle cx="512" cy="540" r="250" fill="rgba(11,18,32,0.16)" stroke="rgba(255,255,255,0.25)" stroke-width="6"/>

    <!-- Striche -->
    <g stroke="rgba(255,255,255,0.65)" stroke-width="10" stroke-linecap="round">
      <line x1="512" y1="300" x2="512" y2="335"/>
      <line x1="512" y1="745" x2="512" y2="780"/>
      <line x1="272" y1="540" x2="307" y2="540"/>
      <line x1="717" y1="540" x2="752" y2="540"/>
    </g>

    <!-- Zeiger -->
    <g stroke="${white}" stroke-width="18" stroke-linecap="round">
      <line x1="512" y1="540" x2="512" y2="430"/>
      <line x1="512" y1="540" x2="610" y2="590"/>
    </g>

    <circle cx="512" cy="540" r="16" fill="${white}"/>
  </g>
</svg>`;
  }

  async function initHomeIcon(){
    const ICON_VERSION="BLUECLOCK_ZGLOW_Y1";
    const KEY = HOME_ICON_PNG_KEY + "::" + ICON_VERSION;
    let png = localStorage.getItem(KEY);
    if(!png){
      png = await svgToPngDataURL(homeIconSVG_BlueClock_GlowYellowZ(), 1024);
      localStorage.setItem(KEY, png);
    }
    $("appleIcon").href = png;
    $("faviconIcon").href = png;
  }

  // ===== Vault / Crypto =====
  function hex(bytes){ return [...bytes].map(b=>b.toString(16).padStart(2,"0")).join(""); }
  function chunk(s,n){ return (s.match(new RegExp(".{1,"+n+"}","g"))||[]).join("-"); }

  async function pbkdf2KeyFromSecret(secret, saltBytes){
    const enc=new TextEncoder();
    const baseKey = await crypto.subtle.importKey("raw", enc.encode(secret), {name:"PBKDF2"}, false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      {name:"PBKDF2", salt:saltBytes, iterations:150000, hash:"SHA-256"},
      baseKey, {name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]
    );
  }
  async function exportRawAes(key){ return b64(await crypto.subtle.exportKey("raw", key)); }
  async function importRawAes(rawB64){
    return crypto.subtle.importKey("raw", ub64(rawB64), {name:"AES-GCM"}, true, ["encrypt","decrypt"]);
  }
  async function aesEncrypt(key, obj){
    const iv=rand(12);
    const pt=new TextEncoder().encode(JSON.stringify(obj));
    const ct=await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, pt);
    return {iv:b64(iv), ct:b64(ct)};
  }
  async function aesDecrypt(key, blob){
    const pt=await crypto.subtle.decrypt({name:"AES-GCM", iv:ub64(blob.iv)}, key, ub64(blob.ct));
    return JSON.parse(new TextDecoder().decode(pt));
  }

  function hasVault(){ return !!localStorage.getItem(VAULT_KEY); }
  async function getSessionMaster(){
    const raw=sessionStorage.getItem(SESSION_MASTER);
    if(!raw) return null;
    try{ return await importRawAes(raw); }catch{ return null; }
  }
  async function setSessionMaster(masterKey){
    sessionStorage.setItem(SESSION_MASTER, await exportRawAes(masterKey));
  }
  function clearSessionMaster(){ sessionStorage.removeItem(SESSION_MASTER); }

  async function createVaultWithPin(pin){
    const master = await crypto.subtle.generateKey({name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]);

    const recBytes=rand(16);
    const recovery = chunk(hex(recBytes).toUpperCase(), 4);

    const pinSalt=rand(16);
    const recSalt=rand(16);

    const pinKey=await pbkdf2KeyFromSecret(pin, pinSalt);
    const recKey=await pbkdf2KeyFromSecret(recovery, recSalt);

    const masterRaw=await exportRawAes(master);
    const wrapPin=await aesEncrypt(pinKey, {master: masterRaw});
    const wrapRec=await aesEncrypt(recKey, {master: masterRaw});
    const verifier=await aesEncrypt(master, {ok:"ZEITERFASSUNG"});

    const vault={ v:1, pinSalt:b64(pinSalt), recSalt:b64(recSalt), wrapPin, wrapRec, verifier };
    localStorage.setItem(VAULT_KEY, JSON.stringify(vault));
    await setSessionMaster(master);
    return recovery;
  }

  async function unlockWithSecret(secret, mode){
    const raw=localStorage.getItem(VAULT_KEY);
    if(!raw) throw new Error("NO_VAULT");
    const vault=JSON.parse(raw);

    const pinSalt=ub64(vault.pinSalt);
    const recSalt=ub64(vault.recSalt);
    const wrap = (mode==="recovery") ? vault.wrapRec : vault.wrapPin;
    const salt = (mode==="recovery") ? recSalt : pinSalt;

    const k=await pbkdf2KeyFromSecret(secret, salt);
    const unwrapped = await aesDecrypt(k, wrap);
    const master = await importRawAes(unwrapped.master);

    const ok = await aesDecrypt(master, vault.verifier);
    if(ok?.ok !== "ZEITERFASSUNG") throw new Error("BAD_SECRET");

    await setSessionMaster(master);
    return true;
  }

  async function changePin(newPin){
    const master=await getSessionMaster();
    if(!master) throw new Error("LOCKED");
    const raw=localStorage.getItem(VAULT_KEY);
    if(!raw) throw new Error("NO_VAULT");
    const vault=JSON.parse(raw);

    const pinSalt=rand(16);
    const pinKey=await pbkdf2KeyFromSecret(newPin, pinSalt);
    const masterRaw=await exportRawAes(master);
    vault.pinSalt=b64(pinSalt);
    vault.wrapPin=await aesEncrypt(pinKey, {master: masterRaw});
    localStorage.setItem(VAULT_KEY, JSON.stringify(vault));
  }

  async function rotateRecovery(){
    const master=await getSessionMaster();
    if(!master) throw new Error("LOCKED");
    const raw=localStorage.getItem(VAULT_KEY);
    if(!raw) throw new Error("NO_VAULT");
    const vault=JSON.parse(raw);

    const recBytes=rand(16);
    const recovery = chunk(hex(recBytes).toUpperCase(), 4);

    const recSalt=rand(16);
    const recKey=await pbkdf2KeyFromSecret(recovery, recSalt);
    const masterRaw=await exportRawAes(master);

    vault.recSalt=b64(recSalt);
    vault.wrapRec=await aesEncrypt(recKey, {master: masterRaw});
    localStorage.setItem(VAULT_KEY, JSON.stringify(vault));
    return recovery;
  }

  function yearKey(y){ return NS+"::year::"+y; }

  async function encryptJson(obj){
    const master=await getSessionMaster();
    if(!master) throw new Error("LOCKED");
    return await aesEncrypt(master, obj);
  }
  async function decryptJson(blob){
    const master=await getSessionMaster();
    if(!master) throw new Error("LOCKED");
    return await aesDecrypt(master, blob);
  }

  async function readYearState(y){
    const raw=localStorage.getItem(yearKey(y));
    if(!raw) return {emp:"", mgr:{name:"",mail:""}, E:[], A:[]};
    const obj=await decryptJson(JSON.parse(raw));
    return {
      emp: obj.emp || "",
      mgr: obj.mgr || {name:"",mail:""},
      E: Array.isArray(obj.E)?obj.E:[],
      A: Array.isArray(obj.A)?obj.A:[]
    };
  }
  async function writeYearState(y, state){
    localStorage.setItem(yearKey(y), JSON.stringify(await encryptJson(state)));
  }

  // ===== App state =====
  let Y=new Date().getFullYear();
  let S={emp:"", mgr:{name:"",mail:""}, E:[], A:[]};
  let run=null;           // {date,start,pauseMin,pauseStart,note}
  let editingId=null;     // entry id being edited

  // ===== UI apply =====
  function applyUIStrings(){
    // tabs
    document.querySelectorAll(".tab").forEach(el=>{
      const k=el.dataset.tab;
      el.textContent = tr(T.tabs[k]);
    });

    $("hTimer").textContent = tr(T.headings.timer);
    $("hOverview").textContent = tr(T.headings.overview);
    $("hEdit").textContent = tr(T.headings.edit);
    $("hAbs").textContent = tr(T.headings.absence);
    $("hEntries").textContent = tr(T.headings.entries);
    $("hSettings").textContent = tr(T.headings.settings);
    $("hMgr").textContent = tr(T.headings.manager);

    $("lblEmp").textContent = tr(T.labels.emp);
    $("lblDate").textContent = tr(T.labels.date);
    $("lblNote").textContent = tr(T.labels.note);

    $("lblMode").textContent = tr(T.labels.mode);
    $("lblRef").textContent = tr(T.labels.ref);
    $("lblTarget").textContent = tr(T.labels.target);

    $("lblMgrName").textContent = tr(T.labels.mgrName);
    $("lblMgrMail").textContent = tr(T.labels.mgrMail);

    $("lblEDate").textContent = tr(T.labels.eDate);
    $("lblEStart").textContent = tr(T.labels.eStart);
    $("lblEEnd").textContent = tr(T.labels.eEnd);
    $("lblENote").textContent = tr(T.labels.eNote);

    $("lblAStart").textContent = tr(T.labels.aStart);
    $("lblAEnd").textContent = tr(T.labels.aEnd);
    $("lblAType").textContent = tr(T.labels.aType);
    $("lblADel").textContent = tr(T.labels.aDel);

    $("lblEntriesFilter").textContent = tr(T.labels.entriesFilter);
    $("lblEntriesFrom").textContent = tr(T.labels.entriesFrom);
    $("lblEntriesTo").textContent = tr(T.labels.entriesTo);
    $("lblEntriesSearch").textContent = tr(T.labels.entriesSearch);

    // mode options
    $("mode").options[0].text = tr(T.options.week);
    $("mode").options[1].text = tr(T.options.month);
    $("mode").options[2].text = tr(T.options.year);

    // absence options
    $("aType").options[0].text = tr(T.options.vac);
    $("aType").options[1].text = tr(T.options.sick);
    $("aType").options[2].text = tr(T.options.hol);

    // entries filter options
    const ef=$("entriesFilter").options;
    ef[0].text = tr(T.options.week);
    ef[1].text = tr(T.options.month);
    ef[2].text = tr(T.options.year);
    ef[3].text = tr(T.options.custom);

    // buttons
    $("saveName").textContent = tr(T.btn.save);
    $("saveMgr").textContent = tr(T.btn.save);
    $("btnStart").textContent = tr(T.btn.start);
    $("btnPause").textContent = tr(T.btn.pause);
    $("btnStop").textContent = tr(T.btn.stop);
    $("btnRefresh").textContent = tr(T.btn.refresh);
    $("btnCSV").textContent = tr(T.btn.csv);
    $("btnShare").textContent = tr(T.btn.share);
    $("btnPDF").textContent = tr(T.btn.pdf);

    $("saveManual").textContent = tr(T.btn.save);
    $("newManual").textContent = tr(T.btn.new);

    $("addAbs").textContent = tr(T.btn.save);
    $("delAbsDay").textContent = tr(T.btn.del);

    $("entriesExportCSV").textContent = tr(T.btn.csv);

    $("btnLock").textContent = tr(T.btn.lock);
    $("btnChangePin").textContent = tr(T.btn.pinchg);
    $("btnNewRecovery").textContent = tr(T.btn.rec);
    $("btnResetThisYear").textContent = tr(T.btn.yearReset);
    $("btnResetAll").textContent = tr(T.btn.allReset);

    // hints
    $("topHint").textContent = tr(T.hint.top);
    $("absHint").textContent = tr(T.hint.abs);
    $("secHint").textContent = tr(T.hint.sec);
    $("lblAuthMode").textContent = tr(T.labels.authMode);
    $("pinFooter").textContent = tr(T.hint.pinFooter);

    $("lblEmoji").textContent = tr(T.labels.emoji);
    $("lblHeaderMode").textContent = tr(T.labels.header);

    // status (default if not set)
    if(!$("timerStatus").textContent) $("timerStatus").textContent = tr(T.status.ready);
  }

  function applyHeaderMode(){
    const mode=getHeaderMode();
    const header=$("appHeader");
    if(mode==="off"){ header.style.display="none"; return; }
    header.style.display="";
    if(mode==="compact"){ $("topHint").style.display="none"; }
    else $("topHint").style.display="";
  }

  function setTimerStatus(key, cls){
    $("timerStatus").textContent = tr(T.status[key] || T.status.ready);
    $("timerStatus").className = "badge" + (cls ? (" "+cls) : "");
  }

  function applyStateToUI(){
    $("empName").value=S.emp||"";
    $("mgrName").value=S.mgr?.name||"";
    $("mgrMail").value=S.mgr?.mail||"";
    $("timerMini").textContent=S.emp ? ((eOn() && !ePro()) ? "üë§ "+S.emp : S.emp) : "";
    $("nameMsg").textContent=S.emp ? (eOn() ? "‚úÖ gespeichert" : "gespeichert") : "";
  }

  // ===== Overlay =====
  function showOverlay(msg){
    $("ovl").style.display="flex";
    $("pinMsg").textContent="";
    $("pinInput").value="";
    $("recoveryBox").style.display="none";
    $("btnCopyRecovery").style.display="none";
    $("ovlText").textContent=msg||"Bitte PIN eingeben.";
    $("btnSetPin").style.display = hasVault() ? "none" : "";
    $("authMode").value="pin";
    setTimeout(()=>$("pinInput").focus(), 50);
  }
  function hideOverlay(){ $("ovl").style.display="none"; }

  // ===== Time helpers (no NaN) =====
  function parseISO(s){
    const d=new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }
  function netMinutes(entry){
    const s=parseISO(entry.s);
    const e=parseISO(entry.e);
    if(!s || !e) return null;
    const gross=(e-s)/60000;
    if(!Number.isFinite(gross) || gross<=0) return null;
    const p=Number(entry.p||0);
    return Math.round(gross - p);
  }
  function fmtTimeHM(d){
    if(!d) return "--:--";
    return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // ===== Year switching =====
  function getRefYear(){
    const v=$("refDate").value;
    return v ? d0(v).getFullYear() : new Date().getFullYear();
  }
  async function loadYear(y){
    Y=y;
    S=await readYearState(Y);
    applyStateToUI();
  }
  async function saveYear(){ await writeYearState(Y, S); }

  // ===== Timer (Start/Pause/Stop) =====
  $("btnStart").onclick=async()=>{
    if(run) return alert(eOn()?"‚õî Timer l√§uft schon.":"Timer l√§uft schon.");
    if(!S.emp) return alert(eOn()?"üë§ Bitte Name speichern.":"Bitte Name speichern.");
    if(!$("timerDate").value) return alert(eOn()?"üìÖ Bitte Datum w√§hlen.":"Bitte Datum w√§hlen.");

    const entryYear=d0($("timerDate").value).getFullYear();
    if(entryYear!==Y) await loadYear(entryYear);

    const now=new Date(); now.setSeconds(0,0);
    const d=d0($("timerDate").value);
    const start=new Date(d.getFullYear(),d.getMonth(),d.getDate(),now.getHours(),now.getMinutes(),0,0);

    run={date:$("timerDate").value,start,pauseMin:0,pauseStart:null,note:($("timerNote").value||"").trim()};
    $("btnPause").disabled=false;
    $("btnPause").textContent=tr(T.btn.pause);
    setTimerStatus("running","chip-ok");
    $("timerInfo").textContent=`${eOn()?"‚è±Ô∏è ":""}Start ${fmtTimeHM(start)}`;
  };

  $("btnPause").onclick=()=>{
    if(!run) return;
    const now=new Date(); now.setSeconds(0,0);
    if(!run.pauseStart){
      run.pauseStart=now;
      $("btnPause").textContent=tr(T.btn.resume);
      setTimerStatus("paused","chip-warn");
    }else{
      run.pauseMin += Math.max(0, Math.round((now-run.pauseStart)/60000));
      run.pauseStart=null;
      $("btnPause").textContent=tr(T.btn.pause);
      setTimerStatus("running","chip-ok");
    }
  };

  $("btnStop").onclick=async()=>{
    if(!run) return alert(eOn()?"‚ö™ Kein Timer l√§uft.":"Kein Timer l√§uft.");
    const end=new Date(); end.setSeconds(0,0);

    if(run.pauseStart){
      run.pauseMin += Math.max(0, Math.round((end-run.pauseStart)/60000));
      run.pauseStart=null;
    }

    const gross=Math.round((end-run.start)/60000);
    if(!Number.isFinite(gross) || gross<=0){ setTimerStatus("ready",""); run=null; return; }

    const auto=(gross>=AUTO_BREAK)?AUTO_BREAK:0;
    const pause=auto+run.pauseMin;

    S.E.push({
      id:(crypto.randomUUID?crypto.randomUUID():"id_"+Date.now()),
      d:run.date, s:run.start.toISOString(), e:end.toISOString(),
      p:pause, n:run.note||""
    });

    run=null;
    $("btnPause").disabled=true;
    $("btnPause").textContent=tr(T.btn.pause);
    setTimerStatus("saved","chip-ok");
    $("timerInfo").textContent="";
    await saveYear();
    await renderAll();
  };

  // ===== R√ºckwirkend =====
  $("newManual").onclick=()=>{
    editingId=null;
    $("eStart").value=""; $("eEnd").value=""; $("eNote").value="";
    $("editMsg").textContent="";
  };

  $("saveManual").onclick=async()=>{
    $("editMsg").textContent="";
    if(!$("eDate").value||!$("eStart").value||!$("eEnd").value){
      $("editMsg").textContent = eOn() ? "‚ö†Ô∏è Bitte Datum/Start/Ende setzen" : "Bitte Datum/Start/Ende setzen";
      return;
    }
    const d=$("eDate").value;
    const [sh,sm]=$("eStart").value.split(":").map(Number);
    const [eh,em]=$("eEnd").value.split(":").map(Number);
    const s=new Date(d0(d).setHours(sh,sm,0,0));
    const e=new Date(d0(d).setHours(eh,em,0,0));
    const gross=Math.round((e-s)/60000);
    if(!Number.isFinite(gross) || gross<=0){
      $("editMsg").textContent = eOn() ? "‚õî Ende muss nach Start" : "Ende muss nach Start";
      return;
    }

    const yr=d0(d).getFullYear();
    if(yr!==Y) await loadYear(yr);

    const obj={
      id:editingId||(crypto.randomUUID?crypto.randomUUID():"m_"+Date.now()),
      d, s:s.toISOString(), e:e.toISOString(),
      p:(gross>=AUTO_BREAK?AUTO_BREAK:0),
      n:($("eNote").value||"").trim()
    };

    if(editingId){
      const idx=S.E.findIndex(x=>x.id===editingId);
      if(idx>=0) S.E[idx]=obj; else S.E.push(obj);
      $("editMsg").textContent = eOn() ? "‚úÖ aktualisiert" : "aktualisiert";
    }else{
      S.E.push(obj);
      editingId=obj.id;
      $("editMsg").textContent = eOn() ? "‚úÖ gespeichert" : "gespeichert";
    }

    await saveYear();
    await renderAll();
  };

  // ===== Abwesenheit (Zeitraum + pro Tag max 1 = verhindert doppelt) =====
  let aEndTouched=false;
  $("aEnd").addEventListener("change",()=>{aEndTouched=true});
  $("aStart").addEventListener("change",()=>{ if(!aEndTouched) $("aEnd").value=$("aStart").value; });

  function absLabel(t){
    if(t==="vac") return tr(T.options.vac);
    if(t==="sick") return tr(T.options.sick);
    if(t==="hol") return tr(T.options.hol);
    return t;
  }
  function absBadge(t){
    return `<span class="badge">${absLabel(t)}</span>`;
  }

  $("addAbs").onclick=async()=>{
    $("absMsg").textContent="";
    const startV=$("aStart").value, endV=$("aEnd").value;
    if(!startV||!endV) return alert(eOn()?"‚ö†Ô∏è Start und Ende w√§hlen.":"Start und Ende w√§hlen.");
    const t=$("aType").value;
    const start=d0(startV), end=d0(endV);
    if(end<start) return alert(eOn()?"‚õî Ende muss nach Start sein.":"Ende muss nach Start sein.");

    let added=0, replaced=0;
    const perYear=new Map();

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      if(!wd(d)) continue; // nur Mo-Fr
      const ds=toDateStr(d);
      const y=d.getFullYear();

      if(!perYear.has(y)) perYear.set(y, await readYearState(y));
      const st=perYear.get(y);

      const before=st.A.length;
      st.A = st.A.filter(a=>a.d!==ds);        // verhindert doppelte (Urlaub+Feiertag etc.)
      replaced += (before - st.A.length);

      st.A.push({id:(crypto.randomUUID?crypto.randomUUID():"a_"+Date.now()+Math.random()), d:ds, t});
      added++;
    }

    for(const [y,st] of perYear.entries()) await writeYearState(y, st);

    await loadYear(getRefYear());
    await renderAll();

    $("absMsg").textContent = eOn()
      ? `‚úÖ ${added} Tage gespeichert` + (replaced?` (‚ôªÔ∏è ${replaced} ersetzt)`:"")
      : `${added} Tage gespeichert` + (replaced?` (${replaced} ersetzt)`:"");
  };

  $("delAbsDay").onclick=async()=>{
    $("absMsg").textContent="";
    const ds=$("aDelDate").value;
    if(!ds) return;
    const y=d0(ds).getFullYear();
    const st=await readYearState(y);
    const before=st.A.length;
    st.A=st.A.filter(a=>a.d!==ds);
    await writeYearState(y, st);
    await loadYear(getRefYear());
    await renderAll();
    const removed=before-st.A.length;
    $("absMsg").textContent = removed
      ? (eOn()?`üóëÔ∏è ${removed} gel√∂scht`:`${removed} gel√∂scht`)
      : (eOn()?"ü§∑ nichts gefunden":"nichts gefunden");
  };

  // ===== √úbersicht =====
  function weekRangeISO(ref){
    const d=new Date(ref); d.setHours(0,0,0,0);
    const monIndex=(d.getDay()+6)%7;
    const start=new Date(d); start.setDate(d.getDate()-monIndex);
    const end=new Date(start); end.setDate(start.getDate()+6);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function monthRange(ref){
    const d=new Date(ref);
    const start=new Date(d.getFullYear(),d.getMonth(),1);
    const end=new Date(d.getFullYear(),d.getMonth()+1,0);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function yearRange(y){
    const start=new Date(y,0,1); start.setHours(0,0,0,0);
    const end=new Date(y,11,31); end.setHours(0,0,0,0);
    return [start,end];
  }
  function getWeeklyTargetMinutes(){
    const v=Number($("weeklyTarget").value);
    return (Number.isFinite(v) && v>0) ? v : 2400;
  }
  function getPeriodRange(){
    const v=$("refDate").value;
    const ref=v?d0(v):new Date();
    const yr=ref.getFullYear();
    if($("mode").value==="year") return yearRange(yr);
    if($("mode").value==="month") return monthRange(ref);
    return weekRangeISO(ref);
  }
  function isoWeekKey(dateObj){
    const d=new Date(dateObj); d.setHours(0,0,0,0);
    d.setDate(d.getDate()+3-((d.getDay()+6)%7));
    const y=d.getFullYear();
    const week1=new Date(y,0,4); week1.setHours(0,0,0,0);
    week1.setDate(week1.getDate()+3-((week1.getDay()+6)%7));
    const w=1+Math.round((d-week1)/(7*24*60*60*1000));
    return `${y}-W${pad(w)}`;
  }
  function chipClassByWeeklyTolerance(deltaMin, weeksEquivalent){
    const tol = TOL_WEEK_MIN * Math.max(1, weeksEquivalent);
    return (Math.abs(deltaMin) <= tol) ? "chip-ok" : "chip-warn";
  }

  async function getMergedForRange(start,end){
    const years=new Set([start.getFullYear(), end.getFullYear()]);
    const allE=[], allA=[];
    let emp=S.emp||"", mgr=S.mgr||{name:"",mail:""};
    for(const y of years){
      const st=await readYearState(y);
      if(!emp && st.emp) emp=st.emp;
      if((!mgr?.mail && st.mgr?.mail) || (!mgr?.name && st.mgr?.name)) mgr=st.mgr;
      allE.push(...(st.E||[]));
      allA.push(...(st.A||[]));
    }
    return {allE,allA,emp,mgr};
  }

  async function renderOverview(){
    const [start,end]=getPeriodRange();
    const W=getWeeklyTargetMinutes();
    const DAY=W/5;
    const startS=toDateStr(start), endS=toDateStr(end);
    const merged=await getMergedForRange(start,end);
    const E=merged.allE, A=merged.allA;

    $("rangeHint").textContent = `${startS} ‚Üí ${endS}`;

    const istBy={};
    for(const e of E){
      if(e.d<startS||e.d>endS) continue;
      const nm=netMinutes(e);
      if(!Number.isFinite(nm)) continue;
      istBy[e.d]=(istBy[e.d]||0)+nm;
    }

    const dayNames=["So","Mo","Di","Mi","Do","Fr","Sa"];
    let istSum=0, sollSum=0, workdays=0;

    let html=`<table><thead><tr>
      <th>${eOn() && !ePro() ? "üìÖ Datum" : "Datum"}</th>
      <th>${eOn() && !ePro() ? "üìå Tag" : "Tag"}</th>
      <th>${eOn() && !ePro() ? "‚úÖ IST" : "IST"}</th>
      <th>${eOn() && !ePro() ? "üéØ SOLL" : "SOLL"}</th>
      <th>${eOn() && !ePro() ? "üè∑Ô∏è Abw." : "Abw."}</th>
      <th>${eOn() && !ePro() ? "Œî" : "Œî"}</th>
    </tr></thead><tbody>`;

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const ds=toDateStr(d);
      const ist=Number.isFinite(istBy[ds]) ? istBy[ds] : 0;

      const absTypes=A.filter(a=>a.d===ds).map(a=>a.t);
      const isW=wd(d);
      const soll = Math.round(isW ? (absTypes.length>0 ? 0 : DAY) : 0);
      const delta=ist-soll;

      istSum += ist; sollSum += soll;
      if(isW) workdays++;

      let abw = absTypes.length ? absTypes.map(t=>absBadge(t)).join(" ") : "";
      if(isWeekend(d) && ist>0){
        const em = (eOn() && !ePro()) ? "üóìÔ∏è " : "";
        abw = (abw ? (abw+" ") : "") + `<span class="badge">${em}Wochenende</span>`;
      }

      html+=`<tr>
        <td class="mono">${ds}</td>
        <td>${dayNames[d.getDay()]}</td>
        <td class="mono">${hhmm(ist)}</td>
        <td class="mono">${hhmm(soll)}</td>
        <td>${abw}</td>
        <td class="mono">${hhmm(delta)}</td>
      </tr>`;
    }
    html+=`</tbody></table>`;
    $("overviewTable").innerHTML=html;

    const delta=istSum-sollSum;
    const weeksEq = workdays ? (workdays/5) : 1;
    const cls = chipClassByWeeklyTolerance(delta, weeksEq);
    $("sumChip").className="badge "+cls;

    const okEmoji = (eOn() && !ePro()) ? "üß≠ " : "";
    const warnEmoji = (eOn() && !ePro()) ? "‚ö†Ô∏è " : "";
    const head = (cls==="chip-ok") ? okEmoji : warnEmoji;

    $("sumChip").textContent = `${head}IST ${hhmm(istSum)} ¬∑ SOLL ${hhmm(sollSum)} ¬∑ Œî ${hhmm(delta)} (¬±10:00/Woche ok)`;

    if($("mode").value==="month"){
      const weeks=new Map();
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const ds=toDateStr(d);
        const wk = isoWeekKey(d);
        if(!weeks.has(wk)) weeks.set(wk,{ist:0,weekdays:0,absDays:0});
        const b=weeks.get(wk);
        b.ist += (istBy[ds]||0);
        if(wd(d)){
          b.weekdays += 1;
          if(A.some(a=>a.d===ds)) b.absDays += 1;
        }
      }
      const active=[...weeks.values()].filter(w=>w.weekdays>0);
      const avgIst = active.length ? active.map(w=>w.ist*(5/w.weekdays)).reduce((s,v)=>s+v,0)/active.length : 0;
      const avgSoll= active.length ? active.map(w=>W - (w.absDays*(W/5))).reduce((s,v)=>s+v,0)/active.length : W;
      const dAvg=avgIst-avgSoll;

      const cls2 = chipClassByWeeklyTolerance(dAvg, 1);
      $("avgChip").style.display="";
      $("avgChip").className="badge "+cls2;
      const head2 = (cls2==="chip-ok") ? ((eOn() && !ePro())?"‚úÖ ":"") : ((eOn() && !ePro())?"‚ö†Ô∏è ":"");
      $("avgChip").textContent = `${head2}√ò/Woche ${hhmm(avgIst)} (Soll ${hhmm(avgSoll)}) ¬∑ Œî ${hhmm(dAvg)}`;
    }else{
      $("avgChip").style.display="none";
    }
  }

  // ===== Eintr√§ge (vollst√§ndig) =====
  function rangeForEntries(filter){
    const ref = $("refDate").value ? d0($("refDate").value) : new Date();
    if(filter==="week") return weekRangeISO(ref);
    if(filter==="month") return monthRange(ref);
    if(filter==="year") return yearRange(ref.getFullYear());
    // custom:
    const f=$("entriesFrom").value, t=$("entriesTo").value;
    if(f && t){
      const s=d0(f), e=d0(t);
      return s<=e ? [s,e] : [e,s];
    }
    return weekRangeISO(ref);
  }

  function normalizeSearch(s){
    return (s||"").trim().toLowerCase();
  }

  function entryRowHTML(e){
    const s=parseISO(e.s);
    const en=parseISO(e.e);
    const net=netMinutes(e);
    const pause=Number(e.p||0);
    return `
<tr>
  <td class="mono">${e.d}</td>
  <td class="mono">${fmtTimeHM(s)}</td>
  <td class="mono">${fmtTimeHM(en)}</td>
  <td class="mono">${hhmm(pause)}</td>
  <td class="mono">${hhmm(net)}</td>
  <td>${safeText(e.n||"")}</td>
  <td>
    <button class="btn-ghost btn-sm" data-edit="${e.id}">${tr(T.btn.edit)}</button>
    <button class="btn-ghost btn-sm" data-del="${e.id}">${tr(T.btn.trash)}</button>
  </td>
</tr>`;
  }

  async function renderEntries(){
    const filter=$("entriesFilter").value;
    const [start,end]=rangeForEntries(filter);
    const startS=toDateStr(start), endS=toDateStr(end);
    const merged=await getMergedForRange(start,end);

    const query = normalizeSearch($("entriesSearch").value);
    const entries = merged.allE
      .filter(e=>e.d>=startS && e.d<=endS)
      .filter(e=> !query || normalizeSearch(e.n).includes(query))
      .sort((a,b)=> (b.d+a.s).localeCompare(a.d+b.s));

    let sum=0;
    for(const e of entries){
      const nm=netMinutes(e);
      if(Number.isFinite(nm)) sum += nm;
    }

    const chipEmoji = (eOn() && !ePro()) ? "üßæ " : "";
    $("entriesSum").textContent = `${chipEmoji}${startS} ‚Üí ${endS} ¬∑ ${entries.length} ${eOn()?"Eintr√§ge":"Eintr√§ge"} ¬∑ Œ£ ${hhmm(sum)}`;

    if(!entries.length){
      $("entryList").innerHTML = `<div class="muted">${eOn()?"ü§∑ ":""}Keine Eintr√§ge im Zeitraum.</div>`;
      return;
    }

    const th = (eOn() && !ePro()) ? {
      d:"üìÖ Datum", s:"‚è±Ô∏è Start", e:"‚èπÔ∏è Ende", p:"‚è∏Ô∏è Pause", n:"‚úÖ Netto", note:"üìù Notiz", act:"‚öôÔ∏è"
    } : {
      d:"Datum", s:"Start", e:"Ende", p:"Pause", n:"Netto", note:"Notiz", act:""
    };

    let html = `<table><thead><tr>
      <th>${th.d}</th><th>${th.s}</th><th>${th.e}</th><th>${th.p}</th><th>${th.n}</th><th>${th.note}</th><th>${th.act}</th>
    </tr></thead><tbody>`;

    for(const e of entries) html += entryRowHTML(e);
    html += `</tbody></table>`;
    $("entryList").innerHTML = html;

    // bind edit/delete
    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=async()=>{
        const id=b.getAttribute("data-del");
        const allYears=[start.getFullYear(), end.getFullYear()];
        // delete from whichever year contains id
        for(const y of new Set(allYears)){
          const st=await readYearState(y);
          const before=st.E.length;
          st.E=st.E.filter(x=>x.id!==id);
          if(st.E.length!==before){
            await writeYearState(y, st);
            if(y===Y) S=st;
            break;
          }
        }
        await loadYear(getRefYear());
        await renderAll();
      };
    });

    document.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=async()=>{
        const id=b.getAttribute("data-edit");
        // find entry across years in range
        const years=[start.getFullYear(), end.getFullYear()];
        let found=null;
        for(const y of new Set(years)){
          const st=await readYearState(y);
          const e=st.E.find(x=>x.id===id);
          if(e){ found={y, e}; break; }
        }
        if(!found) return;

        // load that year and put into R√ºckwirkend editor
        if(found.y!==Y) await loadYear(found.y);
        editingId=id;

        const e=found.e;
        $("eDate").value=e.d;
        const s=parseISO(e.s), en=parseISO(e.e);
        $("eStart").value = s ? `${pad(s.getHours())}:${pad(s.getMinutes())}` : "";
        $("eEnd").value = en ? `${pad(en.getHours())}:${pad(en.getMinutes())}` : "";
        $("eNote").value = e.n || "";
        $("editMsg").textContent = eOn() ? "‚úçÔ∏è Bearbeiten aktiv" : "Bearbeiten aktiv";
        tab("edit");
      };
    });
  }

  // ===== CSV / Share / PDF =====
  function csvSafe(s){
    s=safeText(s);
    const t=s.trimStart();
    if(t.startsWith("=")||t.startsWith("+")||t.startsWith("-")||t.startsWith("@")) return "'"+s;
    return s;
  }

  async function buildCSV(){
    const [start,end]=getPeriodRange();
    const merged=await getMergedForRange(start,end);
    const W=getWeeklyTargetMinutes();
    const startS=toDateStr(start), endS=toDateStr(end);
    const sep=";";

    const rows=[];
    rows.push(["Mitarbeiter","Von","Bis","WochenSoll_min","Datum","Start","Ende","Pause_min","Netto_min","Netto_hhmm","Notiz","ManagerName","ManagerMail"].join(sep));

    const entries=merged.allE.filter(e=>e.d>=startS && e.d<=endS).sort((a,b)=>a.d.localeCompare(b.d));
    for(const e of entries){
      const nm=netMinutes(e);
      rows.push([
        csvSafe(merged.emp||S.emp||""), startS, endS, String(W),
        e.d, e.s, e.e, String(e.p||0),
        Number.isFinite(nm)?String(Math.round(nm)):"",
        hhmm(nm),
        csvSafe(e.n||""),
        csvSafe(merged.mgr?.name||""),
        csvSafe(merged.mgr?.mail||"")
      ].join(sep));
    }

    const abs=merged.allA.filter(a=>a.d>=startS && a.d<=endS).sort((a,b)=>a.d.localeCompare(b.d));
    for(const a of abs){
      rows.push([
        csvSafe(merged.emp||S.emp||""), startS, endS, String(W),
        a.d, "", "", "0", "0", "00:00",
        csvSafe("Abwesenheit: "+a.t),
        csvSafe(merged.mgr?.name||""),
        csvSafe(merged.mgr?.mail||"")
      ].join(sep));
    }

    return rows.join("\n");
  }

  $("btnCSV").onclick=async()=>{
    if(!S.emp) return alert(eOn()?"üë§ Bitte Name speichern.":"Bitte Name speichern.");
    const csv=await buildCSV();
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`Zeiterfassung_${$("mode").value}_${$("refDate").value}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  };

  $("btnShare").onclick=async()=>{
    if(!S.emp) return alert(eOn()?"üë§ Bitte Name speichern.":"Bitte Name speichern.");
    const csv=await buildCSV();
    const file=new File([new Blob([csv],{type:"text/csv"})], "Zeiterfassung.csv", {type:"text/csv"});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:`Zeiterfassung ‚Äì ${S.emp}`, files:[file]});
      return;
    }
    alert(eOn()?"üì§ Teilen nicht verf√ºgbar. Bitte CSV herunterladen und manuell senden.":"Teilen nicht verf√ºgbar. Bitte CSV herunterladen.");
  };

  $("btnPDF").onclick=async()=>{
    await renderOverview();
    tab("overview");
    setTimeout(()=>window.print(), 200);
  };

  // ===== Save buttons =====
  $("saveName").onclick=async()=>{
    S.emp=($("empName").value||"").trim();
    await saveYear();
    applyStateToUI();
  };
  $("saveMgr").onclick=async()=>{
    S.mgr={name:($("mgrName").value||"").trim(), mail:($("mgrMail").value||"").trim()};
    await saveYear();
    alert(eOn()?"‚úÖ Manager gespeichert":"Manager gespeichert");
  };

  // ===== Settings security =====
  $("btnLock").onclick=()=>{
    clearSessionMaster();
    showOverlay(eOn()?"üîí Gesperrt. Entsperre mit PIN oder Recovery-Key.":"Gesperrt. Entsperre mit PIN oder Recovery-Key.");
  };
  $("btnChangePin").onclick=async()=>{
    try{
      const master=await getSessionMaster();
      if(!master){ alert(eOn()?"üîê Bitte zuerst entsperren.":"Bitte zuerst entsperren."); return; }
      const newPin = prompt("Neue PIN (mind. 6 Zeichen):");
      if(!newPin || newPin.trim().length<6) return;
      await changePin(newPin.trim());
      alert(eOn()?"‚úÖ PIN ge√§ndert":"PIN ge√§ndert");
    }catch{
      alert(eOn()?"‚ùå Konnte PIN nicht √§ndern":"Konnte PIN nicht √§ndern");
    }
  };
  $("btnNewRecovery").onclick=async()=>{
    try{
      const master=await getSessionMaster();
      if(!master){ alert(eOn()?"üîê Bitte zuerst entsperren.":"Bitte zuerst entsperren."); return; }
      const rec = await rotateRecovery();
      alert((eOn()?"üß© ":"")+"Neuer Recovery-Key:\n\n" + rec + "\n\nBitte sofort speichern!");
    }catch{
      alert(eOn()?"‚ùå Konnte Recovery-Key nicht erzeugen":"Konnte Recovery-Key nicht erzeugen");
    }
  };

  // ===== Reset =====
  $("btnResetThisYear").onclick=async()=>{
    const yr=getRefYear();
    if(confirm(`Wirklich alle Daten f√ºr ${yr} l√∂schen?`)){
      localStorage.removeItem(yearKey(yr));
      if(yr===Y) S={emp:"",mgr:{name:"",mail:""},E:[],A:[]};
      await renderAll();
      alert(eOn()?"‚úÖ Jahr gel√∂scht":"Jahr gel√∂scht");
    }
  };
  $("btnResetAll").onclick=async()=>{
    if(confirm("Wirklich ALLES l√∂schen (inkl. PIN/Recovery)?")){
      const del=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k && (k.startsWith(NS+"::year::") || k===VAULT_KEY || k.startsWith(HOME_ICON_PNG_KEY) || k===EMOJI_PREF || k===HEADER_PREF)) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      clearSessionMaster();
      alert(eOn()?"‚úÖ Alles gel√∂scht. Seite l√§dt neu.":"Alles gel√∂scht. Seite l√§dt neu.");
      location.reload();
    }
  };

  // ===== Overlay actions =====
  $("btnUnlock").onclick=async()=>{
    try{
      if(!hasVault()){
        $("pinMsg").textContent = eOn() ? "‚ö†Ô∏è Bitte PIN setzen." : "Bitte PIN setzen.";
        return;
      }
      const secret=($("pinInput").value||"").trim();
      if(!secret) { $("pinMsg").textContent=eOn()?"‚ö†Ô∏è Bitte eingeben.":"Bitte eingeben."; return; }
      const mode=$("authMode").value;
      await unlockWithSecret(secret, mode);
      hideOverlay();
      await loadYear(getRefYear());
      await renderAll();
      tab("timer");
    }catch{
      $("pinMsg").textContent = eOn() ? "‚ùå falsch" : "falsch";
    }
  };

  $("btnSetPin").onclick=async()=>{
    try{
      if(hasVault()){
        $("pinMsg").textContent=eOn()?"‚ö†Ô∏è PIN existiert schon.":"PIN existiert schon.";
        return;
      }
      const pin=($("pinInput").value||"").trim();
      if(pin.length<6){ $("pinMsg").textContent=eOn()?"‚ö†Ô∏è PIN min. 6 Zeichen.":"PIN min. 6 Zeichen."; return; }

      const recovery = await createVaultWithPin(pin);
      $("recoveryText").textContent = recovery;
      $("recoveryBox").style.display="";
      $("btnCopyRecovery").style.display="";

      $("btnCopyRecovery").onclick=async()=>{
        try{
          await navigator.clipboard.writeText(recovery);
          $("pinMsg").textContent=eOn()?"‚úÖ kopiert":"kopiert";
        }catch{
          $("pinMsg").textContent=eOn()?"‚ö†Ô∏è Bitte manuell speichern.":"Bitte manuell speichern.";
        }
      };

      $("ovlText").textContent=eOn()?"‚úÖ PIN gesetzt. Recovery-Key speichern!":"PIN gesetzt. Recovery-Key speichern!";
      $("btnSetPin").style.display="none";
    }catch{
      $("pinMsg").textContent=eOn()?"‚ùå Fehler":"Fehler";
    }
  };

  // ===== Entries control wiring =====
  function updateEntriesCustomVisibility(){
    const isCustom = $("entriesFilter").value==="custom";
    $("entriesFromWrap").style.display = isCustom ? "" : "none";
    $("entriesToWrap").style.display = isCustom ? "" : "none";
  }

  $("entriesFilter").onchange=async()=>{ updateEntriesCustomVisibility(); await renderEntries(); };
  $("entriesSearch").oninput=async()=>{ await renderEntries(); };
  $("entriesFrom").onchange=async()=>{ await renderEntries(); };
  $("entriesTo").onchange=async()=>{ await renderEntries(); };

  $("entriesExportCSV").onclick=async()=>{
    // Export exactly what "Eintr√§ge" shows (range + search)
    const filter=$("entriesFilter").value;
    const [start,end]=rangeForEntries(filter);
    const startS=toDateStr(start), endS=toDateStr(end);
    const query = normalizeSearch($("entriesSearch").value);

    const merged=await getMergedForRange(start,end);
    const entries = merged.allE
      .filter(e=>e.d>=startS && e.d<=endS)
      .filter(e=> !query || normalizeSearch(e.n).includes(query))
      .sort((a,b)=>a.d.localeCompare(b.d));

    const sep=";";
    const rows=[];
    rows.push(["Mitarbeiter","Von","Bis","Datum","Start","Ende","Pause_min","Netto_min","Netto_hhmm","Notiz"].join(sep));
    for(const e of entries){
      const nm=netMinutes(e);
      rows.push([
        csvSafe(merged.emp||S.emp||""), startS, endS,
        e.d, e.s, e.e, String(e.p||0),
        Number.isFinite(nm)?String(Math.round(nm)):"",
        hhmm(nm),
        csvSafe(e.n||"")
      ].join(sep));
    }
    const csv=rows.join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`Zeiterfassung_Eintraege_${startS}_bis_${endS}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  };

  // ===== Main refresh wiring =====
  $("btnRefresh").onclick=async()=>{ await renderAll(); };
  $("mode").onchange=async()=>{ await renderAll(); };
  $("weeklyTarget").onchange=async()=>{ await renderAll(); };
  $("refDate").onchange=async()=>{ await loadYear(getRefYear()); await renderAll(); };

  // Settings dropdown wiring
  $("emojiMode").onchange=async()=>{
    localStorage.setItem(EMOJI_PREF, $("emojiMode").value);
    applyUIStrings();
    await renderAll();
  };
  $("headerMode").onchange=async()=>{
    localStorage.setItem(HEADER_PREF, $("headerMode").value);
    applyHeaderMode();
  };

  // ===== Render lists =====
  function renderAbsList(){
    if(!S.A.length){ $("absList").innerHTML=`<div class="muted">${eOn()?"ü§∑ ":""}Keine Abwesenheiten im Jahr ${Y}.</div>`; return; }
    const arr=S.A.slice().sort((a,b)=>a.d.localeCompare(b.d));
    let html=`<table><thead><tr><th>${eOn()&&!ePro()?"üìÖ Datum":"Datum"}</th><th>${eOn()&&!ePro()?"üè∑Ô∏è Typ":"Typ"}</th></tr></thead><tbody>`;
    for(const a of arr){
      html+=`<tr><td class="mono">${a.d}</td><td>${absBadge(a.t)}</td></tr>`;
    }
    html+=`</tbody></table>`;
    $("absList").innerHTML=html;
  }

  // ===== App boot =====
  async function renderAll(){
    applyStateToUI();
    applyUIStrings();
    applyHeaderMode();
    await renderOverview();
    renderAbsList();
    await renderEntries();
  }

  // ===== Defaults =====
  const today=new Date().toISOString().slice(0,10);
  $("timerDate").value=today;
  $("refDate").value=today;
  $("eDate").value=today;
  $("aStart").value=today;
  $("aEnd").value=today;
  $("aDelDate").value=today;
  $("entriesFrom").value=today;
  $("entriesTo").value=today;
  $("entriesSearch").value="";
  $("entriesFilter").value="month";
  updateEntriesCustomVisibility();

  // ===== Start state =====
  setTimerStatus("ready","");
  $("emojiMode").value = getEmojiMode();
  $("headerMode").value = getHeaderMode();

  (async()=>{
    await initHomeIcon();
    applyUIStrings();
    applyHeaderMode();

    if(!await getSessionMaster()){
      showOverlay(hasVault() ? (eOn()?"üîê Bitte PIN oder Recovery-Key eingeben.":"Bitte PIN oder Recovery-Key eingeben.")
                             : (eOn()?"üß∑ Bitte PIN setzen (Recovery-Key wird angezeigt).":"Bitte PIN setzen (Recovery-Key wird angezeigt)."));
      return;
    }
    await loadYear(getRefYear());
    await renderAll();
    tab("timer");
  })();
})();
</script>

</body>
</html>
