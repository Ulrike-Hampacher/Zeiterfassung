<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Zeiterfassung</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Zeiterfassung" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="robots" content="noindex,nofollow" />

  <link rel="apple-touch-icon" href="icon.png?v=10">
  <link rel="icon" href="icon.png?v=10">

  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --shadow:0 2px 12px rgba(0,0,0,.08);
      --primary:#2563eb;

      /* Ampel */
      --ok:#166534;   --okbg:#dcfce7;
      --mid:#92400e;  --midbg:#fef3c7;
      --bad:#9a3412;  --badbg:#fff7ed;

      --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:14px;font-family:-apple-system,system-ui;background:var(--bg);color:var(--text)}
    .card{background:var(--card);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:var(--shadow)}
    h1{margin:0 0 6px 0;font-size:20px}
    h2{margin:10px 0 10px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .mono{font-family:ui-monospace,Menlo,monospace}
    .row{display:flex;flex-wrap:wrap;align-items:flex-end;column-gap:10px;row-gap:12px}
    .right{margin-left:auto}

    input,select,button,textarea{
      font-size:16px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff
    }
    button{border:none;font-weight:800;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}

    .btn-start{background:#16a34a;color:#fff}
    .btn-pause{background:#111827;color:#fff}
    .btn-stop{background:#dc2626;color:#fff}
    .btn-blue{background:var(--primary);color:#fff}
    .btn-ghost{background:#eef2f7;color:#0f172a}
    .btn-sm{padding:8px 10px;font-size:14px;border-radius:10px}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:12px;background:#eef2f7;cursor:pointer}
    .tab.active{background:#111;color:#fff}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:8px 12px;border-radius:999px;
      font-size:12px;font-weight:900;
      background:var(--chip);
      border:1px solid rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .badge.block{white-space:normal !important;line-height:1.25;max-width:100%;display:block}
    .chip-ok{background:var(--okbg);color:var(--ok)}
    .chip-mid{background:var(--midbg);color:var(--mid)}
    .chip-warn{background:var(--badbg);color:var(--bad)}

    .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:14px}
    .table-wrap table{min-width:560px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:14px;vertical-align:top}
    th{text-align:left;color:#64748b}

    @media(max-width:430px){
      th,td{padding:6px;font-size:13px}
      .table-wrap table{min-width:520px}
    }

    .small-badge{
      display:inline-flex;align-items:center;gap:4px;
      padding:2px 7px;border-radius:999px;
      font-size:11px;font-weight:900;line-height:1.2;
      background:#eef2f7;color:#111827;
      border:1px solid rgba(0,0,0,.10);
      vertical-align:middle; white-space:nowrap;
    }
    .small-badge .e{font-size:12px;line-height:1}

    /* widths */
    .w-emp{width:210px;max-width:210px}
    .w-save{width:170px;max-width:170px}
    .w-note{width:150px;max-width:150px}
    .w-edit-note{width:190px;max-width:190px;height:44px}
    .w-mgr-name{width:170px;max-width:170px;margin-left:-10px}
    /* âœ… Mailfeld 0,2cm nach rechts (â‰ˆ8px) */
    .w-mgr-mail{width:370px;max-width:88vw;min-width:320px;margin-left:8px}

    .entries-search-wrap{width:100%}
    #entriesSearch{width:min(340px, 92vw)}
    .note-cell{display:flex; align-items:center; gap:6px; max-width:260px}
    .note-text{overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px}

    /* overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px}
    .modal{width:min(560px,100%);background:#fff;border-radius:16px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.25)}
    .modal h2{margin-top:0}
    .pin{width:min(320px,86vw);max-width:86vw;letter-spacing:.08em;font-weight:900;text-align:center;font-size:18px;padding:10px 12px}

    /* PRINT: Manager NICHT im PDF */
    @media print{
      body{background:#fff;padding:0}
      .card{box-shadow:none;border-radius:0;margin:0 0 12px 0}
      #tabsCard, #timer, #edit, #absence, #entries, #settings, #ovl {display:none !important;}
      #overview{display:block !important;}
      #overviewControls, #btnRefresh, #btnCSV, #btnShare, #btnPDF {display:none !important;}
      #managerBlock {display:none !important;}
      #topHint{display:none !important;}
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Zeiterfassung</h1>
    <div class="muted" id="topHint">ğŸ” PIN+Recovery Â· Offline Â· Auto-Pause 55 min (nur wenn keine manuelle Pause & >6h) Â· ğŸ’¾ Crash-Save Â· ğŸŒ™ Mitternacht-Split Â· ğŸ“Š Ampel Â· ğŸ–¨ï¸ PDF Â· â¬‡ï¸ CSV</div>
  </div>

  <div class="card" id="tabsCard">
    <div class="tabs">
      <div class="tab active" data-tab="timer">â±ï¸ Timer</div>
      <div class="tab" data-tab="overview">ğŸ“Š Ãœbersicht</div>
      <div class="tab" data-tab="edit">ğŸ—“ï¸ RÃ¼ckwirkend</div>
      <div class="tab" data-tab="absence">ğŸ–ï¸ Abwesenheit</div>
      <div class="tab" data-tab="entries">ğŸ§¾ EintrÃ¤ge</div>
      <div class="tab" data-tab="settings">âš™ï¸ Settings</div>
    </div>
  </div>

  <!-- TIMER -->
  <div class="card" id="timer">
    <h2>â±ï¸ Timer</h2>

    <div class="row" style="margin-bottom:10px">
      <div class="muted" style="width:100%">ğŸ‘¤ Mitarbeiter</div>
      <input id="empName" class="w-emp" placeholder="Vorname Nachname" />
      <button class="btn-ghost w-save" id="saveName">ğŸ’¾ Speichern</button>
      <span class="right muted mono" id="timerMini"></span>
    </div>
    <div class="muted" id="nameMsg"></div>

    <div class="row" style="margin-top:12px">
      <div>
        <div class="muted">ğŸ“… Datum</div>
        <input type="date" id="timerDate" />
      </div>
      <div>
        <div class="muted">ğŸ“ Notiz (optional)</div>
        <input id="timerNote" class="w-note" placeholder="kurz (optional)" />
      </div>
      <span class="right muted mono" id="timerInfo"></span>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn-start" id="btnStart">â–¶ï¸ Start</button>
      <button class="btn-pause" id="btnPause" disabled>â¸ï¸ Pause</button>
      <button class="btn-stop" id="btnStop">â¹ï¸ Stop</button>
      <span class="badge" id="timerStatus">âšª bereit</span>
    </div>
  </div>

  <!-- OVERVIEW -->
  <div class="card" id="overview" style="display:none">
    <h2>ğŸ“Š Ãœbersicht</h2>

    <div class="muted" style="margin-top:6px;">ğŸ‘¤ Mitarbeiter: <span id="pdfEmpName">â€”</span></div>
    <div class="muted" style="margin-top:4px;">ğŸ“… Zeitraum: <span id="pdfRangeText">â€”</span></div>
    <div class="muted" style="margin-top:4px;">â±ï¸ IST/SOLL/Î”: <span id="pdfSumText">â€”</span></div>

    <div class="row" id="overviewControls" style="margin-top:12px">
      <div>
        <div class="muted">ğŸ§­ Modus</div>
        <select id="mode">
          <option value="week">ğŸ“† Woche</option>
          <option value="month">ğŸ—“ï¸ Monat</option>
          <option value="year">ğŸ“… Jahr</option>
        </select>
      </div>
      <div>
        <div class="muted">ğŸ“… Datum</div>
        <input type="date" id="refDate" />
      </div>
      <div>
        <div class="muted">ğŸ¯ Wochen-Soll</div>
        <select id="weeklyTarget">
          <option value="2400">40:00 ğŸ‡©ğŸ‡ª</option>
          <option value="2310">38:30 ğŸ‡¦ğŸ‡¹</option>
        </select>
      </div>

      <button class="btn-ghost" id="btnRefresh">ğŸ”„</button>
      <button class="btn-blue" id="btnCSV">â¬‡ï¸ CSV</button>
      <button class="btn-ghost" id="btnShare">ğŸ“¤ Teilen</button>
      <button class="btn-ghost" id="btnPDF">ğŸ–¨ï¸ PDF</button>
      <span class="right muted mono" id="rangeHint"></span>
    </div>

    <div class="row" style="margin-top:12px">
      <span class="badge block" id="sumChip">â€”</span>
      <span class="badge" id="weChip" style="display:none">â€”</span>
    </div>

    <div class="muted" style="margin-top:10px">
      ğŸŸ¢ bis Â±5:00/Woche Â· ğŸŸ¡ bis Â±10:00/Woche Â· ğŸ”´ darÃ¼ber Â·
      Abwesenheit (Urlaub/Krank/Feiertag/Ausgleichstag) wird als <b>Anrechnung</b> (Tages-Soll) gezÃ¤hlt und reduziert die Wochenzeit nicht.
    </div>

    <div id="managerBlock" style="margin-top:14px">
      <h2>ğŸ‘” Manager</h2>
      <div class="row">
        <div class="muted" style="width:100%">Name</div>
        <input id="mgrName" class="w-mgr-name" placeholder="Name" />
        <div class="muted" style="width:100%">E-Mail</div>
        <input id="mgrMail" class="w-mgr-mail" placeholder="vorname.nachname@firma.de" />
        <button class="btn-ghost w-save" id="saveMgr">ğŸ’¾ Speichern</button>
      </div>
    </div>

    <div id="overviewTable" style="margin-top:12px"></div>
  </div>

  <!-- EDIT -->
  <div class="card" id="edit" style="display:none">
    <h2>ğŸ—“ï¸ RÃ¼ckwirkend</h2>
    <div class="row">
      <div><div class="muted">ğŸ“… Datum</div><input type="date" id="eDate" /></div>
      <div><div class="muted">â±ï¸ Start</div><input type="time" id="eStart" /></div>
      <div><div class="muted">â¹ï¸ Ende</div><input type="time" id="eEnd" /></div>
      <div><div class="muted">ğŸ“ Notiz</div><input id="eNote" class="w-edit-note" placeholder="optional" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn-ghost" id="saveManual">ğŸ’¾ Speichern</button>
      <button class="btn-ghost" id="newManual">ğŸ†• Neu</button>
      <span class="right muted mono" id="editMsg"></span>
    </div>
    <div class="muted" style="margin-top:8px">
      Hinweis: RÃ¼ckwirkend zieht automatisch 55 Min Pause ab â€“ aber erst wenn die Dauer > 6:00 h ist.
    </div>
  </div>

  <!-- ABSENCE -->
  <div class="card" id="absence" style="display:none">
    <h2>ğŸ–ï¸ Abwesenheit</h2>
    <div class="muted">ğŸ“† Zeitraum Â· Moâ€“Fr Â· pro Tag max. 1 (ersetzt doppelte automatisch) Â· wird als Tages-Soll angerechnet</div>

    <div class="row" style="margin-top:10px">
      <div><div class="muted">Start</div><input type="date" id="aStart" /></div>
      <div><div class="muted">Ende</div><input type="date" id="aEnd" /></div>
      <div>
        <div class="muted">Typ</div>
        <select id="aType"></select>
      </div>
      <button class="btn-ghost" id="addAbs">ğŸ’¾ Speichern</button>
    </div>

    <div class="row" style="margin-top:12px">
      <div><div class="muted">Einzeltag lÃ¶schen</div><input type="date" id="aDelDate" /></div>
      <button class="btn-ghost" id="delAbsDay">ğŸ—‘ï¸ LÃ¶schen</button>
      <span class="right muted mono" id="absMsg"></span>
    </div>

    <div id="absList" style="margin-top:12px"></div>
  </div>

  <!-- ENTRIES -->
  <div class="card" id="entries" style="display:none">
    <h2>ğŸ§¾ EintrÃ¤ge</h2>

    <div class="row">
      <div>
        <div class="muted">ğŸ§© Filter</div>
        <select id="entriesFilter">
          <option value="week">ğŸ“† Woche</option>
          <option value="month" selected>ğŸ—“ï¸ Monat</option>
          <option value="year">ğŸ“… Jahr</option>
          <option value="custom">ğŸ§· Zeitraum</option>
        </select>
      </div>

      <div id="entriesFromWrap" style="display:none">
        <div class="muted">Von</div>
        <input type="date" id="entriesFrom" />
      </div>

      <div id="entriesToWrap" style="display:none">
        <div class="muted">Bis</div>
        <input type="date" id="entriesTo" />
      </div>

      <div class="entries-search-wrap">
        <div class="muted">ğŸ” Suche (Notiz)</div>
        <input id="entriesSearch" placeholder="z.B. Urlaub / Workshop" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <span class="badge" id="entriesSum">â€”</span>
      <button class="btn-ghost right" id="entriesExportCSV">â¬‡ï¸ CSV</button>
    </div>

    <div id="entryList" style="margin-top:12px"></div>
  </div>

  <!-- SETTINGS -->
  <div class="card" id="settings" style="display:none">
    <h2>âš™ï¸ Settings</h2>
    <div class="muted">ğŸ” Entsperrt bleibt bis Safari geschlossen wird (Session). PIN kann nur geÃ¤ndert / Recovery neu erzeugt werden.</div>

    <div class="row" style="margin-top:12px">
      <button class="btn-ghost" id="btnLock">ğŸ”’ Sperren</button>
      <button class="btn-ghost" id="btnChangePin">ğŸ” PIN Ã¤ndern</button>
      <button class="btn-ghost" id="btnNewRecovery">ğŸ§© Recovery-Key</button>
    </div>

    <h2>ğŸ˜€ Emojis</h2>
    <div class="muted">â– / â• / AUS</div>

    <div class="row" style="margin-top:10px">
      <div style="min-width:150px">
        <div class="muted">Wochenende</div>
        <div class="row" style="gap:6px">
          <button class="btn-ghost btn-sm" id="weMinus">â–</button>
          <select id="wePick"></select>
          <button class="btn-ghost btn-sm" id="wePlus">â•</button>
        </div>
      </div>

      <div style="min-width:150px">
        <div class="muted">Urlaub</div>
        <div class="row" style="gap:6px">
          <button class="btn-ghost btn-sm" id="vacMinus">â–</button>
          <select id="vacPick"></select>
          <button class="btn-ghost btn-sm" id="vacPlus">â•</button>
        </div>
      </div>

      <div style="min-width:150px">
        <div class="muted">Krank</div>
        <div class="row" style="gap:6px">
          <button class="btn-ghost btn-sm" id="sickMinus">â–</button>
          <select id="sickPick"></select>
          <button class="btn-ghost btn-sm" id="sickPlus">â•</button>
        </div>
      </div>

      <div style="min-width:150px">
        <div class="muted">Feiertag</div>
        <div class="row" style="gap:6px">
          <button class="btn-ghost btn-sm" id="holMinus">â–</button>
          <select id="holPick"></select>
          <button class="btn-ghost btn-sm" id="holPlus">â•</button>
        </div>
      </div>

      <div style="min-width:150px">
        <div class="muted">Ausgleichstag</div>
        <div class="row" style="gap:6px">
          <button class="btn-ghost btn-sm" id="compMinus">â–</button>
          <select id="compPick"></select>
          <button class="btn-ghost btn-sm" id="compPlus">â•</button>
        </div>
      </div>

      <button class="btn-ghost" id="saveEmoji">ğŸ’¾ Speichern</button>
      <button class="btn-ghost" id="resetEmoji">â†©ï¸ Standard</button>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn-stop" id="btnResetThisYear">ğŸ§¹ Jahr lÃ¶schen</button>
      <button class="btn-ghost" id="btnResetAll">ğŸ§¨ Alles lÃ¶schen</button>
    </div>
  </div>

  <!-- PIN Overlay -->
  <div class="overlay" id="ovl">
    <div class="modal">
      <h2>Zeiterfassung entsperren</h2>
      <div class="muted" id="ovlText">Bitte PIN eingeben.</div>

      <div style="margin-top:10px;display:flex;justify-content:center">
        <input id="pinInput" class="pin" inputmode="text" maxlength="80" placeholder="PIN oder Recovery-Key" autocomplete="off" />
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <div class="muted">ğŸ” Entsperren mit</div>
          <select id="authMode">
            <option value="pin" selected>PIN</option>
            <option value="recovery">Recovery-Key</option>
          </select>
        </div>
        <span class="right muted mono" id="pinMsg"></span>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn-blue" id="btnUnlock">Entsperren</button>
        <button class="btn-ghost" id="btnSetPin">PIN setzen</button>
        <button class="btn-ghost" id="btnCopyRecovery" style="display:none">Recovery kopieren</button>
      </div>

      <div class="muted" style="margin-top:10px">
        ğŸ§© PIN vergessen? â†’ Recovery-Key nutzen. Beides weg â†’ nur Reset (Daten weg).
      </div>

      <div class="card" id="recoveryBox" style="display:none;margin-top:12px;background:#fbfbfb">
        <h2>Dein Recovery-Key</h2>
        <div class="muted">Bitte in Passwortmanager speichern.</div>
        <div class="mono" id="recoveryText" style="margin-top:8px;font-size:16px;font-weight:900"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  /* =======================
     Konfiguration
  ======================== */
  const NS = "ZEITERFASSUNG";

  // âœ… Tages-Auto-Pause: 55 Min, aber erst wenn Dauer > 6h
  // âœ… UND: NUR wenn keine manuelle Pause genommen wurde (sonst doppelt)
  const AUTO_BREAK = 55;
  const AUTO_BREAK_AFTER_MIN = 6 * 60;

  const TOL_Y_WEEK = 300;                // Â±5:00 pro Woche (gelb)
  const TOL_R_WEEK = 600;                // Â±10:00 pro Woche (rot)

  const VAULT_KEY = NS+"::vault_v1";
  const SESSION_MASTER = NS+"::session_master_raw";
  const YEAR_KEY = (y)=> NS+"::year::"+y;

  // âœ… Crash-Save fÃ¼r laufenden Timer (verschlÃ¼sselt)
  const RUN_KEY = NS + "::run_v1";
  const RUN_SAVE_MS = 15000;

  const DEFAULT_EMOJI = { we:"ğŸ§‘â€ğŸ’»", vac:"ğŸ–ï¸", sick:"ğŸ¤’", hol:"ğŸ‰", comp:"âš–ï¸" };
  const PICKS = {
    we:   ["(aus)","ğŸ§‘â€ğŸ’»","ğŸ’¼","âš¡ï¸","ğŸ› ï¸","ğŸ•’"],
    vac:  ["(aus)","ğŸ–ï¸","ğŸŒ´","âœˆï¸","â›±ï¸","ğŸŒ"],
    sick: ["(aus)","ğŸ¤’","ğŸ©º","ğŸ˜·","ğŸ’Š","ğŸ›Œ"],
    hol:  ["(aus)","ğŸ‰","ğŸ“…","ğŸŠ","â­ï¸","ğŸ›ï¸"],
    comp: ["(aus)","âš–ï¸","ğŸ”","ğŸ§˜","âœ…","ğŸ•Šï¸"]
  };

  /* =======================
     Helpers
  ======================== */
  const $ = (id)=>document.getElementById(id);
  const pad = (n)=>String(n).padStart(2,"0");
  const toDateStr = (d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const d0 = (s)=>{ const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); };
  const wd = (d)=> d.getDay()>=1 && d.getDay()<=5;
  const isWeekend = (d)=> d.getDay()===0 || d.getDay()===6;
  const norm = (s)=>(s||"").toString().trim().toLowerCase();
  const parseISO = (s)=>{ const d=new Date(s); return isNaN(d.getTime())?null:d; };
  const fmtTimeHM = (d)=> d?`${pad(d.getHours())}:${pad(d.getMinutes())}`:"--:--";
  const hhmm = (m)=>{
    if(!Number.isFinite(m)) return "--:--";
    const s=m<0?"-":"";
    m=Math.abs(Math.round(m));
    return s + pad(Math.floor(m/60)) + ":" + pad(m%60);
  };

  function smallBadge(emoji, text){
    const e = emoji ? `<span class="e">${emoji}</span>` : "";
    const t = text ? `<span>${text}</span>` : "";
    return `<span class="small-badge">${e}${t}</span>`;
  }

  function tab(name){
    ["timer","overview","edit","absence","entries","settings"].forEach(id=>{
      $(id).style.display=(id===name)?"":"none";
    });
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===name));
  }
  document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>tab(t.dataset.tab));

  /* =======================
     Security (PIN + Recovery)
  ======================== */
  const b64 = (buf)=>btoa(String.fromCharCode(...new Uint8Array(buf)));
  const ub64 = (s)=>Uint8Array.from(atob(s), c=>c.charCodeAt(0));
  const rand = (n)=>crypto.getRandomValues(new Uint8Array(n));
  const hex  = (bytes)=>[...bytes].map(b=>b.toString(16).padStart(2,"0")).join("");
  const chunk=(s,n)=>(s.match(new RegExp(".{1,"+n+"}","g"))||[]).join("-");

  async function pbkdf2KeyFromSecret(secret, saltBytes){
    const enc=new TextEncoder();
    const baseKey = await crypto.subtle.importKey("raw", enc.encode(secret), {name:"PBKDF2"}, false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      {name:"PBKDF2", salt:saltBytes, iterations:150000, hash:"SHA-256"},
      baseKey, {name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]
    );
  }
  async function exportRawAes(key){ return b64(await crypto.subtle.exportKey("raw", key)); }
  async function importRawAes(rawB64){
    return crypto.subtle.importKey("raw", ub64(rawB64), {name:"AES-GCM"}, true, ["encrypt","decrypt"]);
  }
  async function aesEncrypt(key, obj){
    const iv=rand(12);
    const pt=new TextEncoder().encode(JSON.stringify(obj));
    const ct=await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, pt);
    return {iv:b64(iv), ct:b64(ct)};
  }
  async function aesDecrypt(key, blob){
    const pt=await crypto.subtle.decrypt({name:"AES-GCM", iv:ub64(blob.iv)}, key, ub64(blob.ct));
    return JSON.parse(new TextDecoder().decode(pt));
  }

  function hasVault(){ return !!localStorage.getItem(VAULT_KEY); }
  async function getSessionMaster(){
    const raw=sessionStorage.getItem(SESSION_MASTER);
    if(!raw) return null;
    try{ return await importRawAes(raw); }catch{ return null; }
  }
  async function setSessionMaster(masterKey){
    sessionStorage.setItem(SESSION_MASTER, await exportRawAes(masterKey));
  }
  function clearSessionMaster(){ sessionStorage.removeItem(SESSION_MASTER); }

  async function createVaultWithPin(pin){
    const master = await crypto.subtle.generateKey({name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]);
    const recBytes=rand(16);
    const recovery = chunk(hex(recBytes).toUpperCase(), 4);

    const pinSalt=rand(16);
    const recSalt=rand(16);
    const pinKey=await pbkdf2KeyFromSecret(pin, pinSalt);
    const recKey=await pbkdf2KeyFromSecret(recovery, recSalt);

    const masterRaw=await exportRawAes(master);
    const wrapPin=await aesEncrypt(pinKey, {master: masterRaw});
    const wrapRec=await aesEncrypt(recKey, {master: masterRaw});
    const verifier=await aesEncrypt(master, {ok:"ZEITERFASSUNG"});

    const vault={ v:1, pinSalt:b64(pinSalt), recSalt:b64(recSalt), wrapPin, wrapRec, verifier };
    localStorage.setItem(VAULT_KEY, JSON.stringify(vault));
    await setSessionMaster(master);
    return recovery;
  }

  async function unlockWithSecret(secret, mode){
    const raw=localStorage.getItem(VAULT_KEY);
    if(!raw) throw new Error("NO_VAULT");
    const vault=JSON.parse(raw);
    const pinSalt=ub64(vault.pinSalt);
    const recSalt=ub64(vault.recSalt);

    const wrap = (mode==="recovery") ? vault.wrapRec : vault.wrapPin;
    const salt = (mode==="recovery") ? recSalt : pinSalt;

    const k=await pbkdf2KeyFromSecret(secret, salt);
    const unwrapped = await aesDecrypt(k, wrap);
    const master = await importRawAes(unwrapped.master);

    const ok = await aesDecrypt(master, vault.verifier);
    if(ok?.ok !== "ZEITERFASSUNG") throw new Error("BAD_SECRET");

    await setSessionMaster(master);
    return true;
  }

  async function changePin(newPin){
    const master=await getSessionMaster();
    if(!master) throw new Error("LOCKED");
    const raw=localStorage.getItem(VAULT_KEY);
    if(!raw) throw new Error("NO_VAULT");

    const vault=JSON.parse(raw);
    const pinSalt=rand(16);
    const pinKey=await pbkdf2KeyFromSecret(newPin, pinSalt);
    const masterRaw=await exportRawAes(master);

    vault.pinSalt=b64(pinSalt);
    vault.wrapPin=await aesEncrypt(pinKey, {master: masterRaw});
    localStorage.setItem(VAULT_KEY, JSON.stringify(vault));
  }

  async function rotateRecovery(){
    const master=await getSessionMaster();
    if(!master) throw new Error("LOCKED");
    const raw=localStorage.getItem(VAULT_KEY);
    if(!raw) throw new Error("NO_VAULT");

    const vault=JSON.parse(raw);
    const recBytes=rand(16);
    const recovery = chunk(hex(recBytes).toUpperCase(), 4);
    const recSalt=rand(16);
    const recKey=await pbkdf2KeyFromSecret(recovery, recSalt);
    const masterRaw=await exportRawAes(master);

    vault.recSalt=b64(recSalt);
    vault.wrapRec=await aesEncrypt(recKey, {master: masterRaw});
    localStorage.setItem(VAULT_KEY, JSON.stringify(vault));
    return recovery;
  }

  async function encryptJson(obj){
    const master=await getSessionMaster();
    if(!master) throw new Error("LOCKED");
    return await aesEncrypt(master, obj);
  }
  async function decryptJson(blob){
    const master=await getSessionMaster();
    if(!master) throw new Error("LOCKED");
    return await aesDecrypt(master, blob);
  }

  /* =======================
     Datenmodell
  ======================== */
  let Y = new Date().getFullYear();
  let S = { emp:"", mgrName:"", mgrMail:"", emojis:{...DEFAULT_EMOJI}, E:[], A:[] };

  // âœ… laufender Timer mit Crash-Save
  let run = null;

  async function saveRun(){
    try{
      const master = await getSessionMaster();
      if(!master || !run) return;

      const payload = {
        v: 1,
        y: Y,
        run: {
          date: run.date,
          start: run.start ? run.start.toISOString() : null,
          pauseMin: run.pauseMin || 0,
          pauseStart: run.pauseStart ? run.pauseStart.toISOString() : null,
          note: run.note || ""
        }
      };
      localStorage.setItem(RUN_KEY, JSON.stringify(await encryptJson(payload)));
    }catch(e){
      console.warn("saveRun failed", e);
    }
  }
  function clearRun(){ localStorage.removeItem(RUN_KEY); }

  async function restoreRunIfAny(){
    try{
      const raw = localStorage.getItem(RUN_KEY);
      if(!raw) return false;

      const payload = await decryptJson(JSON.parse(raw));
      if(!payload?.run?.date || !payload?.run?.start) return false;

      const start = parseISO(payload.run.start);
      if(!start) return false;

      const yr = d0(payload.run.date).getFullYear();
      if(yr !== Y) await loadYear(yr);

      run = {
        date: payload.run.date,
        start,
        pauseMin: Number(payload.run.pauseMin||0),
        pauseStart: payload.run.pauseStart ? parseISO(payload.run.pauseStart) : null,
        note: (payload.run.note||"").trim()
      };

      $("timerDate").value = run.date;
      $("timerNote").value = run.note || "";
      $("btnPause").disabled = false;

      if(run.pauseStart){
        $("btnPause").textContent="â–¶ï¸ Weiter";
        setTimerStatus("â¸ï¸ Pause (wiederhergestellt)", "chip-mid");
        $("timerInfo").textContent=`Pause seit ${fmtTimeHM(run.pauseStart)}`;
      }else{
        $("btnPause").textContent="â¸ï¸ Pause";
        setTimerStatus("ğŸŸ¢ lÃ¤uft (wiederhergestellt)", "chip-ok");
        $("timerInfo").textContent=`Start ${fmtTimeHM(run.start)}`;
      }
      return true;
    }catch(e){
      console.warn("restoreRunIfAny failed", e);
      localStorage.removeItem(RUN_KEY);
      return false;
    }
  }

  async function readYearState(y){
    const raw=localStorage.getItem(YEAR_KEY(y));
    if(!raw) return {emp:"", mgrName:"", mgrMail:"", emojis:{...DEFAULT_EMOJI}, E:[], A:[]};
    const obj=await decryptJson(JSON.parse(raw));
    return {
      emp: obj.emp || "",
      mgrName: obj.mgrName || "",
      mgrMail: obj.mgrMail || "",
      emojis: {...DEFAULT_EMOJI, ...(obj.emojis||{})},
      E: Array.isArray(obj.E)?obj.E:[],
      A: Array.isArray(obj.A)?obj.A:[]
    };
  }
  async function writeYearState(y, state){
    localStorage.setItem(YEAR_KEY(y), JSON.stringify(await encryptJson(state)));
  }
  async function loadYear(y){
    Y=y;
    S=await readYearState(Y);

    $("empName").value=S.emp||"";
    $("mgrName").value=S.mgrName||"";
    $("mgrMail").value=S.mgrMail||"";

    $("timerMini").textContent=S.emp ? "ğŸ‘¤ "+S.emp : "";
    $("nameMsg").textContent=S.emp ? "âœ… gespeichert" : "";
    $("pdfEmpName").textContent=S.emp || "â€”";

    loadEmojiUI();
  }
  async function saveYear(){ await writeYearState(Y, S); }

  /* =======================
     Emoji Settings
  ======================== */
  function emojiOrMarker(v){ return (v==="(aus)") ? "(aus)" : v; }
  function emojiDisplay(savedValue, fallback){
    if (savedValue === "(aus)") return "";
    if (!savedValue) return fallback;
    return savedValue;
  }
  function fillSelect(sel, arr){
    sel.innerHTML="";
    arr.forEach(v=>{
      const o=document.createElement("option");
      o.value=v; o.textContent=v;
      sel.appendChild(o);
    });
  }
  function setPick(sel, arr, emoji){
    const v = emoji ? emoji : "(aus)";
    sel.value = arr.includes(v) ? v : "(aus)";
  }
  function cyclePick(sel, arr, dir){
    let i = arr.indexOf(sel.value);
    if(i<0) i=0;
    i = (i + dir + arr.length) % arr.length;
    sel.value = arr[i];
  }

  function refreshAbsenceDropdown(){
    const saved = (S.emojis || {});
    const em = {
      vac:  emojiDisplay(saved.vac,  DEFAULT_EMOJI.vac),
      sick: emojiDisplay(saved.sick, DEFAULT_EMOJI.sick),
      hol:  emojiDisplay(saved.hol,  DEFAULT_EMOJI.hol),
      comp: emojiDisplay(saved.comp, DEFAULT_EMOJI.comp),
    };
    const s=$("aType");
    const cur=s.value || "vac";
    s.innerHTML="";
    const opts=[
      {v:"vac",  t:`${em.vac  ? em.vac+" "  : ""}Urlaub`},
      {v:"sick", t:`${em.sick ? em.sick+" " : ""}Krank`},
      {v:"hol",  t:`${em.hol  ? em.hol+" "  : ""}Feiertag`},
      {v:"comp", t:`${em.comp ? em.comp+" " : ""}Ausgleichstag`},
    ];
    for(const o of opts){
      const op=document.createElement("option");
      op.value=o.v;
      op.textContent=o.t;
      s.appendChild(op);
    }
    s.value = ["vac","sick","hol","comp"].includes(cur) ? cur : "vac";
  }

  function loadEmojiUI(){
    fillSelect($("wePick"), PICKS.we);
    fillSelect($("vacPick"), PICKS.vac);
    fillSelect($("sickPick"), PICKS.sick);
    fillSelect($("holPick"), PICKS.hol);
    fillSelect($("compPick"), PICKS.comp);

    setPick($("wePick"), PICKS.we, S.emojis.we);
    setPick($("vacPick"), PICKS.vac, S.emojis.vac);
    setPick($("sickPick"), PICKS.sick, S.emojis.sick);
    setPick($("holPick"), PICKS.hol, S.emojis.hol);
    setPick($("compPick"), PICKS.comp, S.emojis.comp);

    refreshAbsenceDropdown();
  }

  $("weMinus").onclick  =()=>cyclePick($("wePick"),  PICKS.we,  -1);
  $("wePlus").onclick   =()=>cyclePick($("wePick"),  PICKS.we,  +1);
  $("vacMinus").onclick =()=>cyclePick($("vacPick"), PICKS.vac, -1);
  $("vacPlus").onclick  =()=>cyclePick($("vacPick"), PICKS.vac, +1);
  $("sickMinus").onclick=()=>cyclePick($("sickPick"),PICKS.sick,-1);
  $("sickPlus").onclick =()=>cyclePick($("sickPick"),PICKS.sick,+1);
  $("holMinus").onclick =()=>cyclePick($("holPick"), PICKS.hol, -1);
  $("holPlus").onclick  =()=>cyclePick($("holPick"), PICKS.hol, +1);
  $("compMinus").onclick=()=>cyclePick($("compPick"),PICKS.comp,-1);
  $("compPlus").onclick =()=>cyclePick($("compPick"),PICKS.comp,+1);

  $("saveEmoji").onclick = async ()=>{
    S.emojis = {
      we:   emojiOrMarker($("wePick").value),
      vac:  emojiOrMarker($("vacPick").value),
      sick: emojiOrMarker($("sickPick").value),
      hol:  emojiOrMarker($("holPick").value),
      comp: emojiOrMarker($("compPick").value),
    };
    await saveYear();
    loadEmojiUI();
    await renderAll();
    alert("ğŸ˜€ Emojis gespeichert");
  };
  $("resetEmoji").onclick = async ()=>{
    S.emojis = {...DEFAULT_EMOJI};
    await saveYear();
    loadEmojiUI();
    await renderAll();
    alert("â†©ï¸ Standard Emojis gesetzt");
  };

  /* =======================
     Overlay UI
  ======================== */
  function showOverlay(msg){
    $("ovl").style.display="flex";
    $("pinMsg").textContent="";
    $("pinInput").value="";
    $("recoveryBox").style.display="none";
    $("btnCopyRecovery").style.display="none";
    $("ovlText").textContent=msg||"Bitte PIN eingeben.";
    $("btnSetPin").style.display = hasVault() ? "none" : "";
    $("authMode").value="pin";
    setTimeout(()=>$("pinInput").focus(), 50);
  }
  function hideOverlay(){ $("ovl").style.display="none"; }

  /* =======================
     Timer / Entries Helpers
  ======================== */
  function setTimerStatus(txt, cls){
    $("timerStatus").textContent=txt;
    $("timerStatus").className="badge"+(cls?(" "+cls):"");
  }

  function netMinutes(entry){
    const s=parseISO(entry.s), e=parseISO(entry.e);
    if(!s||!e) return null;
    const gross=(e-s)/60000;
    if(!Number.isFinite(gross)||gross<=0) return null;
    const p=Number(entry.p||0);
    return Math.round(gross-p);
  }

  function autoBreakForGross(grossMin, manualPauseMin){
    const hasManualPause = (manualPauseMin||0) > 0;
    if(hasManualPause) return 0;
    return (Number.isFinite(grossMin) && grossMin > AUTO_BREAK_AFTER_MIN) ? AUTO_BREAK : 0;
  }

  /* =======================
     Timer: Mitternacht-Split
  ======================== */
  async function splitAtMidnightIfNeeded(){
    if(!run) return;

    const now = new Date();
    const todayStr = toDateStr(now);
    if(todayStr === run.date) return;

    const boundary = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);

    if(run.pauseStart){
      run.pauseMin += Math.max(0, Math.round((boundary - run.pauseStart)/60000));
      run.pauseStart = boundary;
    }

    const segGross = Math.round((boundary - run.start)/60000);
    if(Number.isFinite(segGross) && segGross > 0){
      const segDate  = toDateStr(run.start);
      const segYear  = d0(segDate).getFullYear();

      const auto = autoBreakForGross(segGross, run.pauseMin||0);
      const pause = (run.pauseMin || 0) + auto;

      if(segYear !== Y){
        await saveYear();
        await loadYear(segYear);
      }

      S.E.push({
        id:(crypto.randomUUID?crypto.randomUUID():"mid_"+Date.now()),
        d: segDate,
        s: run.start.toISOString(),
        e: boundary.toISOString(),
        p: pause,
        n: run.note || ""
      });

      await saveYear();
    }

    const newYear = boundary.getFullYear();
    if(newYear !== Y) await loadYear(newYear);

    run.start = boundary;
    run.date  = toDateStr(boundary);
    run.pauseMin = 0;

    $("timerDate").value = run.date;
    $("timerInfo").textContent = `lÃ¤uft weiter ab 00:00`;
    await saveRun();
    await renderAll();
  }

  setInterval(async ()=>{ if(run) await splitAtMidnightIfNeeded(); }, 15000);
  setInterval(async ()=>{ if(run) await saveRun(); }, RUN_SAVE_MS);

  window.addEventListener("pagehide", ()=>{ if(run) saveRun(); });
  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState==="hidden" && run) saveRun();
  });

  /* =======================
     Timer Actions
  ======================== */
  $("btnStart").onclick=async()=>{
    if(run) return alert("â›” Timer lÃ¤uft schon.");
    if(!S.emp) return alert("ğŸ‘¤ Bitte Name speichern.");
    if(!$("timerDate").value) return alert("ğŸ“… Bitte Datum wÃ¤hlen.");

    const entryYear=d0($("timerDate").value).getFullYear();
    if(entryYear!==Y) await loadYear(entryYear);

    const now=new Date(); now.setSeconds(0,0);
    const d=d0($("timerDate").value);
    const start=new Date(d.getFullYear(),d.getMonth(),d.getDate(),now.getHours(),now.getMinutes(),0,0);

    run={
      date:$("timerDate").value,
      start,
      pauseMin:0,
      pauseStart:null,
      note:($("timerNote").value||"").trim()
    };

    $("btnPause").disabled=false;
    setTimerStatus("ğŸŸ¢ lÃ¤uft", "chip-ok");
    $("timerInfo").textContent=`Start ${fmtTimeHM(start)}`;

    await saveRun();
  };

  $("btnPause").onclick=()=>{
    if(!run) return;
    const now=new Date(); now.setSeconds(0,0);

    if(!run.pauseStart){
      run.pauseStart=now;
      $("btnPause").textContent="â–¶ï¸ Weiter";
      setTimerStatus("â¸ï¸ Pause", "chip-mid");
    }else{
      run.pauseMin += Math.max(0, Math.round((now-run.pauseStart)/60000));
      run.pauseStart=null;
      $("btnPause").textContent="â¸ï¸ Pause";
      setTimerStatus("ğŸŸ¢ lÃ¤uft", "chip-ok");
    }
    saveRun();
  };

  $("btnStop").onclick=async()=>{
    if(!run) return alert("âšª Kein Timer lÃ¤uft.");

    await splitAtMidnightIfNeeded();

    const end=new Date(); end.setSeconds(0,0);

    if(run.pauseStart){
      run.pauseMin += Math.max(0, Math.round((end-run.pauseStart)/60000));
      run.pauseStart=null;
    }

    const gross=Math.round((end-run.start)/60000);
    if(!Number.isFinite(gross)||gross<=0){ run=null; clearRun(); return; }

    const auto = autoBreakForGross(gross, run.pauseMin||0);
    const pause = (run.pauseMin||0) + auto;

    const entryDate = run.date;
    const entryYear = d0(entryDate).getFullYear();
    if(entryYear!==Y) await loadYear(entryYear);

    S.E.push({
      id:(crypto.randomUUID?crypto.randomUUID():"id_"+Date.now()),
      d: entryDate,
      s: run.start.toISOString(),
      e: end.toISOString(),
      p: pause,
      n: run.note||""
    });

    run=null;
    clearRun();

    $("btnPause").disabled=true;
    $("btnPause").textContent="â¸ï¸ Pause";
    $("timerInfo").textContent="";
    setTimerStatus("âœ… gespeichert", "chip-ok");

    await saveYear();
    await renderAll();
  };

  $("saveName").onclick=async()=>{
    S.emp=($("empName").value||"").trim();
    await saveYear();
    $("timerMini").textContent=S.emp ? "ğŸ‘¤ "+S.emp : "";
    $("nameMsg").textContent=S.emp ? "âœ… gespeichert" : "";
    $("pdfEmpName").textContent=S.emp || "â€”";
  };
  $("saveMgr").onclick=async()=>{
    S.mgrName=($("mgrName").value||"").trim();
    S.mgrMail=($("mgrMail").value||"").trim();
    await saveYear();
    alert("âœ… Manager gespeichert");
  };

  /* =======================
     RÃ¼ckwirkend
     - Auto-Pause 55 nur wenn Dauer > 6h (unabhÃ¤ngig von â€manueller Pauseâ€œ, weil manuell gibtâ€™s hier nicht)
  ======================== */
  $("saveManual").onclick=async()=>{
    $("editMsg").textContent="";
    if(!$("eDate").value||!$("eStart").value||!$("eEnd").value){
      $("editMsg").textContent="âš ï¸ Bitte Datum/Start/Ende setzen";
      return;
    }
    const d=$("eDate").value;
    const [sh,sm]=$("eStart").value.split(":").map(Number);
    const [eh,em]=$("eEnd").value.split(":").map(Number);
    const s=new Date(d0(d).setHours(sh,sm,0,0));
    const e=new Date(d0(d).setHours(eh,em,0,0));
    const gross=Math.round((e-s)/60000);
    if(!Number.isFinite(gross)||gross<=0){ $("editMsg").textContent="â›” Ende muss nach Start"; return; }

    const yr=d0(d).getFullYear();
    if(yr!==Y) await loadYear(yr);

    const auto = (gross > AUTO_BREAK_AFTER_MIN) ? AUTO_BREAK : 0;

    S.E.push({
      id:(crypto.randomUUID?crypto.randomUUID():"m_"+Date.now()),
      d, s:s.toISOString(), e:e.toISOString(),
      p:auto,
      n:($("eNote").value||"").trim()
    });

    await saveYear();
    $("editMsg").textContent="âœ… gespeichert";
    await renderAll();
  };
  $("newManual").onclick=()=>{
    $("eStart").value=""; $("eEnd").value=""; $("eNote").value="";
    $("editMsg").textContent="";
  };

  /* =======================
     Abwesenheit / Ãœbersicht / EintrÃ¤ge / CSV / Settings / Boot
     (unverÃ¤ndert aus deinem bisherigen Code â€“ hier der Rest 1:1)
  ======================== */

  /* --- Abwesenheit: exakt wie vorher --- */
  let aEndTouched=false;
  $("aEnd").addEventListener("input", ()=>{ aEndTouched=true; });
  $("aStart").addEventListener("input", ()=>{
    if(!aEndTouched) $("aEnd").value=$("aStart").value;
  });
  $("aStart").addEventListener("change", ()=>{
    const s=$("aStart").value;
    const e=$("aEnd").value;
    if(!e || e < s){
      $("aEnd").value=s;
      aEndTouched=false;
    }
  });
  $("aEnd").addEventListener("change", ()=>{
    if($("aEnd").value === $("aStart").value) aEndTouched=false;
  });

  function renderAbsList(){
    if(!S.A.length){
      $("absList").innerHTML=`<div class="muted">ğŸ¤· Keine Abwesenheiten im Jahr ${Y}.</div>`;
      return;
    }
    const saved=S.emojis||{};
    const em={
      vac:  emojiDisplay(saved.vac, DEFAULT_EMOJI.vac),
      sick: emojiDisplay(saved.sick,DEFAULT_EMOJI.sick),
      hol:  emojiDisplay(saved.hol, DEFAULT_EMOJI.hol),
      comp: emojiDisplay(saved.comp,DEFAULT_EMOJI.comp),
    };
    const arr=S.A.slice().sort((a,b)=>a.d.localeCompare(b.d));
    let html=`<div class="table-wrap"><table><thead><tr><th>ğŸ“… Datum</th><th>ğŸ·ï¸ Typ</th></tr></thead><tbody>`;
    for(const a of arr){
      const t = a.t==="vac"  ? smallBadge(em.vac,"Urlaub")
              : a.t==="sick" ? smallBadge(em.sick,"Krank")
              : a.t==="hol"  ? smallBadge(em.hol,"Feiertag")
              :               smallBadge(em.comp,"Ausgleichstag");
      html+=`<tr><td class="mono">${a.d}</td><td>${t}</td></tr>`;
    }
    html+=`</tbody></table></div>`;
    $("absList").innerHTML=html;
  }

  $("addAbs").onclick=async()=>{
    $("absMsg").textContent="";
    const startV=$("aStart").value, endV=$("aEnd").value;
    if(!startV||!endV) return alert("âš ï¸ Start und Ende wÃ¤hlen.");
    const t=$("aType").value;
    if(!["vac","sick","hol","comp"].includes(t)) return alert("âš ï¸ Typ ungÃ¼ltig.");

    const start=d0(startV), end=d0(endV);
    if(end<start) return alert("â›” Ende muss nach Start sein.");

    let added=0, replaced=0;
    const perYear=new Map();

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      if(!wd(d)) continue;
      const ds=toDateStr(d);
      const y=d.getFullYear();

      if(!perYear.has(y)) perYear.set(y, await readYearState(y));
      const st=perYear.get(y);

      const before=st.A.length;
      st.A = st.A.filter(a=>a.d!==ds);
      replaced += (before - st.A.length);

      st.A.push({id:(crypto.randomUUID?crypto.randomUUID():"a_"+Date.now()+Math.random()), d:ds, t});
      added++;
    }

    for(const [y,st] of perYear.entries()) await writeYearState(y, st);

    await loadYear(getRefYear());
    await renderAll();
    $("absMsg").textContent = `âœ… ${added} Tage gespeichert` + (replaced?` (â™»ï¸ ${replaced} ersetzt)`:"");
  };

  $("delAbsDay").onclick=async()=>{
    $("absMsg").textContent="";
    const ds=$("aDelDate").value;
    if(!ds) return;
    const y=d0(ds).getFullYear();
    const st=await readYearState(y);
    const before=st.A.length;
    st.A=st.A.filter(a=>a.d!==ds);
    await writeYearState(y, st);
    await loadYear(getRefYear());
    await renderAll();
    const removed=before-st.A.length;
    $("absMsg").textContent = removed ? `ğŸ—‘ï¸ ${removed} gelÃ¶scht` : "ğŸ¤· nichts gefunden";
  };

  /* --- Range / Targets: wie vorher --- */
  function weekRangeISO(ref){
    const d=new Date(ref); d.setHours(0,0,0,0);
    const monIndex=(d.getDay()+6)%7;
    const start=new Date(d); start.setDate(d.getDate()-monIndex);
    const end=new Date(start); end.setDate(start.getDate()+6);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function monthRange(ref){
    const d=new Date(ref);
    const start=new Date(d.getFullYear(),d.getMonth(),1);
    const end=new Date(d.getFullYear(),d.getMonth()+1,0);
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    return [start,end];
  }
  function yearRange(y){
    const start=new Date(y,0,1); start.setHours(0,0,0,0);
    const end=new Date(y,11,31); end.setHours(0,0,0,0);
    return [start,end];
  }
  function getWeeklyTargetMinutes(){
    const v=Number($("weeklyTarget").value);
    return (Number.isFinite(v) && v>0) ? v : 2400;
  }
  function getPeriodRange(){
    const v=$("refDate").value;
    const ref=v?d0(v):new Date();
    const yr=ref.getFullYear();
    if($("mode").value==="year") return yearRange(yr);
    if($("mode").value==="month") return monthRange(ref);
    return weekRangeISO(ref);
  }
  function getRefYear(){
    const v=$("refDate").value;
    return v ? d0(v).getFullYear() : new Date().getFullYear();
  }

  async function getMergedForRange(start,end){
    const years=new Set([start.getFullYear(), end.getFullYear()]);
    const allE=[], allA=[];
    let emp=S.emp||"", mgrName=S.mgrName||"", mgrMail=S.mgrMail||"", emojis={...DEFAULT_EMOJI, ...(S.emojis||{})};

    for(const y of years){
      const st=await readYearState(y);
      if(!emp && st.emp) emp=st.emp;
      if(!mgrName && st.mgrName) mgrName=st.mgrName;
      if(!mgrMail && st.mgrMail) mgrMail=st.mgrMail;
      emojis = {...emojis, ...(st.emojis||{})};
      allE.push(...(st.E||[]));
      allA.push(...(st.A||[]));
    }
    return {allE,allA,emp,mgrName,mgrMail,emojis};
  }

  async function renderOverview(){
    const [start,end]=getPeriodRange();
    const W=getWeeklyTargetMinutes();
    const DAY=W/5;
    const startS=toDateStr(start), endS=toDateStr(end);

    $("rangeHint").textContent = `${startS} â†’ ${endS}`;
    $("pdfRangeText").textContent = `${startS} â†’ ${endS}`;

    const merged=await getMergedForRange(start,end);
    $("pdfEmpName").textContent = merged.emp || S.emp || "â€”";

    const saved = merged.emojis || DEFAULT_EMOJI;
    const em = {
      we:   emojiDisplay(saved.we,   DEFAULT_EMOJI.we),
      vac:  emojiDisplay(saved.vac,  DEFAULT_EMOJI.vac),
      sick: emojiDisplay(saved.sick, DEFAULT_EMOJI.sick),
      hol:  emojiDisplay(saved.hol,  DEFAULT_EMOJI.hol),
      comp: emojiDisplay(saved.comp, DEFAULT_EMOJI.comp),
    };

    const istBy=Object.create(null);
    for(const e of merged.allE){
      if(!e || !e.d) continue;
      if(e.d<startS||e.d>endS) continue;
      const nm=netMinutes(e);
      if(!Number.isFinite(nm)) continue;
      istBy[e.d]=(istBy[e.d]||0)+nm;
    }

    const absBy = Object.create(null);
    for (const a of (merged.allA || [])) {
      if (!a || !a.d || !a.t) continue;
      if (a.d < startS || a.d > endS) continue;
      const t = (a.t==="vac"||a.t==="sick"||a.t==="hol"||a.t==="comp") ? a.t : null;
      if (!t) continue;
      absBy[a.d] = t;
    }

    let istSum=0, sollSum=0, workdays=0, creditSum=0;
    let weMin=0, weDays=0;

    const dayNames=["So","Mo","Di","Mi","Do","Fr","Sa"];
    let html=`<div class="table-wrap"><table><thead><tr>
      <th>ğŸ“… Datum</th><th>Tag</th><th>IST</th><th>Anr.</th><th>SOLL</th><th>Abw.</th><th>Î”</th>
    </tr></thead><tbody>`;

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const ds=toDateStr(d);
      const ist=Number.isFinite(istBy[ds]) ? istBy[ds] : 0;

      const isW = wd(d);
      const soll = Math.round(isW ? DAY : 0);
      const absType = absBy[ds] || null;
      const credit = (isW && absType) ? Math.round(DAY) : 0;

      const istEff = ist + credit;
      const delta = istEff - soll;

      istSum += istEff;
      sollSum += soll;
      creditSum += credit;
      if(isW) workdays++;

      let abw = "";
      if(absType==="vac")  abw = smallBadge(em.vac,"Urlaub");
      if(absType==="sick") abw = smallBadge(em.sick,"Krank");
      if(absType==="hol")  abw = smallBadge(em.hol,"Feiertag");
      if(absType==="comp") abw = smallBadge(em.comp,"Ausgleichstag");

      let abw2 = abw;
      if (isWeekend(d) && ist > 0) {
        abw2 = (abw2 ? (abw2+" ") : "") + smallBadge(em.we,"WE");
        weMin += ist; weDays += 1;
      }

      html+=`<tr>
        <td class="mono">${ds}</td>
        <td>${dayNames[d.getDay()]}</td>
        <td class="mono">${hhmm(ist)}</td>
        <td class="mono">${credit?hhmm(credit):"â€”"}</td>
        <td class="mono">${hhmm(soll)}</td>
        <td>${abw2}</td>
        <td class="mono">${hhmm(delta)}</td>
      </tr>`;
    }
    html+=`</tbody></table></div>`;
    $("overviewTable").innerHTML=html;

    const delta=istSum-sollSum;
    const weeksEq = workdays ? (workdays/5) : 1;
    const tolY = TOL_Y_WEEK * Math.max(1, weeksEq);
    const tolR = TOL_R_WEEK * Math.max(1, weeksEq);

    const absDelta=Math.abs(delta);
    let cls="chip-ok", icon="ğŸŸ¢";
    if(absDelta>tolY && absDelta<=tolR){ cls="chip-mid"; icon="ğŸŸ¡"; }
    if(absDelta>tolR){ cls="chip-warn"; icon="ğŸ”´"; }

    $("sumChip").className="badge block "+cls;
    $("sumChip").innerHTML =
      `<div><b>${icon} IST ${hhmm(istSum)}</b> Â· SOLL ${hhmm(sollSum)}</div>`+
      `<div>Î” ${hhmm(delta)} <span class="muted">(Â±5:00/W Â· bis Â±10:00/W)</span></div>`+
      (creditSum>0 ? `<div class="muted">inkl. Anrechnung: ${hhmm(creditSum)}</div>` : "");

    $("pdfSumText").textContent =
      `IST ${hhmm(istSum)} Â· SOLL ${hhmm(sollSum)} Â· Î” ${hhmm(delta)}` + (creditSum>0 ? ` Â· Anr ${hhmm(creditSum)}` : "");

    if(weMin>0){
      $("weChip").style.display="";
      $("weChip").textContent = `${em.we} WE-Arbeit: ${hhmm(weMin)} (${weDays} Tag${weDays===1?"":"e"})`;
    }else{
      $("weChip").style.display="none";
    }
  }

  function rangeForEntries(filter){
    const ref = $("refDate").value ? d0($("refDate").value) : new Date();
    if(filter==="week") return weekRangeISO(ref);
    if(filter==="month") return monthRange(ref);
    if(filter==="year") return yearRange(ref.getFullYear());
    const f=$("entriesFrom").value, t=$("entriesTo").value;
    if(f && t){
      const s=d0(f), e=d0(t);
      return s<=e ? [s,e] : [e,s];
    }
    return monthRange(ref);
  }

  function entryRowHTML(e, emojis){
    const s=parseISO(e.s);
    const en=parseISO(e.e);
    const net=netMinutes(e);
    const pause=Number(e.p||0);
    const day=d0(e.d);

    const emWE = emojiDisplay(emojis.we, DEFAULT_EMOJI.we);
    const weBadge = (isWeekend(day) && Number.isFinite(net) && net>0)
      ? smallBadge(emWE,"WE")
      : "";

    const note = (e.n||"").toString();
    return `
<tr>
  <td class="mono">${e.d}</td>
  <td class="mono">${fmtTimeHM(s)}</td>
  <td class="mono">${fmtTimeHM(en)}</td>
  <td class="mono">${hhmm(pause)}</td>
  <td class="mono">${hhmm(net)}</td>
  <td>
    <div class="note-cell">
      ${weBadge}
      <span class="note-text">${note.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span>
    </div>
  </td>
  <td><button class="btn-ghost btn-sm" data-del="${e.id}">ğŸ—‘ï¸</button></td>
</tr>`;
  }

  async function renderEntries(){
    const filter=$("entriesFilter").value;
    const [start,end]=rangeForEntries(filter);
    const startS=toDateStr(start), endS=toDateStr(end);
    const merged=await getMergedForRange(start,end);

    const query = norm($("entriesSearch").value);
    const entries = (merged.allE||[])
      .filter(e=>e && e.d>=startS && e.d<=endS)
      .filter(e=> !query || norm(e.n).includes(query))
      .sort((a,b)=> (b.d+b.s).localeCompare(a.d+a.s));

    let sum=0;
    for(const e of entries){
      const nm=netMinutes(e);
      if(Number.isFinite(nm)) sum += nm;
    }
    $("entriesSum").textContent = `${startS} â†’ ${endS} Â· ${entries.length} Â· Î£ ${hhmm(sum)}`;

    if(!entries.length){
      $("entryList").innerHTML = `<div class="muted">ğŸ¤· Keine EintrÃ¤ge im Zeitraum.</div>`;
      return;
    }

    let html = `<div class="table-wrap"><table><thead><tr>
      <th>Datum</th><th>Start</th><th>Ende</th><th>Pause</th><th>Netto</th><th>Notiz</th><th></th>
    </tr></thead><tbody>`;
    for(const e of entries) html += entryRowHTML(e, merged.emojis||DEFAULT_EMOJI);
    html += `</tbody></table></div>`;
    $("entryList").innerHTML = html;

    document.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=async()=>{
        const id=b.getAttribute("data-del");
        const years=[start.getFullYear(), end.getFullYear(), Y];
        for(const y of [...new Set(years)]){
          const st=await readYearState(y);
          const before=st.E.length;
          st.E=st.E.filter(x=>x.id!==id);
          if(st.E.length!==before){
            await writeYearState(y, st);
            break;
          }
        }
        await loadYear(getRefYear());
        await renderAll();
      };
    });
  }

  function updateEntriesCustomVisibility(){
    const isCustom = $("entriesFilter").value==="custom";
    $("entriesFromWrap").style.display = isCustom ? "" : "none";
    $("entriesToWrap").style.display = isCustom ? "" : "none";
  }

  let entriesToTouched=false;
  $("entriesTo").addEventListener("input", ()=>{ entriesToTouched=true; });
  $("entriesFrom").addEventListener("input", ()=>{
    if(!entriesToTouched) $("entriesTo").value=$("entriesFrom").value;
  });
  $("entriesFrom").addEventListener("change", ()=>{
    const f=$("entriesFrom").value;
    const t=$("entriesTo").value;
    if(!t || t < f){
      $("entriesTo").value=f;
      entriesToTouched=false;
    }
  });
  $("entriesTo").addEventListener("change", ()=>{
    if($("entriesTo").value === $("entriesFrom").value) entriesToTouched=false;
  });

  function csvSafe(s){
    s=(s??"").toString();
    const t=s.trimStart();
    if(t.startsWith("=")||t.startsWith("+")||t.startsWith("-")||t.startsWith("@")) return "'"+s;
    return s;
  }

  async function buildCSV(){
    const [start,end]=getPeriodRange();
    const merged=await getMergedForRange(start,end);
    const W=getWeeklyTargetMinutes();
    const startS=toDateStr(start), endS=toDateStr(end);
    const sep=";";

    const rows=[];
    rows.push(["Mitarbeiter","Von","Bis","WochenSoll_min","Datum","StartISO","EndeISO","Pause_min","Netto_min","Netto_hhmm","Notiz","ManagerName","ManagerMail"].join(sep));

    const entries=(merged.allE||[]).filter(e=>e.d>=startS && e.d<=endS).sort((a,b)=>a.d.localeCompare(b.d));
    for(const e of entries){
      const nm=netMinutes(e);
      rows.push([
        csvSafe(merged.emp||S.emp||""), startS, endS, String(W),
        e.d, e.s, e.e, String(e.p||0),
        Number.isFinite(nm)?String(Math.round(nm)):"",
        hhmm(nm),
        csvSafe(e.n||""),
        csvSafe(merged.mgrName||S.mgrName||""),
        csvSafe(merged.mgrMail||S.mgrMail||"")
      ].join(sep));
    }
    return rows.join("\n");
  }

  $("btnCSV").onclick=async()=>{
    if(!S.emp) return alert("ğŸ‘¤ Bitte Name speichern.");
    const csv=await buildCSV();
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`Zeiterfassung_${$("mode").value}_${$("refDate").value}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  };
  $("entriesExportCSV").onclick=async()=>{ $("btnCSV").click(); };

  $("btnShare").onclick=async()=>{
    if(!S.emp) return alert("ğŸ‘¤ Bitte Name speichern.");
    const csv=await buildCSV();
    const file=new File([new Blob([csv],{type:"text/csv"})], "Zeiterfassung.csv", {type:"text/csv"});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:`Zeiterfassung â€“ ${S.emp}`, files:[file]});
      return;
    }
    alert("ğŸ“¤ Teilen nicht verfÃ¼gbar. Bitte CSV herunterladen und manuell senden.");
  };

  $("btnPDF").onclick = async () => {
    try {
      tab("overview");
      await renderOverview();
      await new Promise(r => requestAnimationFrame(() => r()));
      await new Promise(r => requestAnimationFrame(() => r()));
      setTimeout(() => window.print(), 350);
    } catch (e) {
      console.error(e);
      alert("âŒ PDF konnte nicht gestartet werden.");
    }
  };

  $("btnLock").onclick=()=>{
    clearSessionMaster();
    showOverlay("ğŸ”’ Gesperrt. Entsperre mit PIN oder Recovery-Key.");
  };

  $("btnChangePin").onclick=async()=>{
    try{
      const master=await getSessionMaster();
      if(!master){ alert("ğŸ” Bitte zuerst entsperren."); return; }
      const newPin = prompt("Neue PIN (mind. 6 Zeichen):");
      if(!newPin || newPin.trim().length<6) return;
      await changePin(newPin.trim());
      alert("âœ… PIN geÃ¤ndert");
    }catch{ alert("âŒ Konnte PIN nicht Ã¤ndern"); }
  };

  $("btnNewRecovery").onclick=async()=>{
    try{
      const master=await getSessionMaster();
      if(!master){ alert("ğŸ” Bitte zuerst entsperren."); return; }
      const rec = await rotateRecovery();
      alert("ğŸ§© Neuer Recovery-Key:\n\n" + rec + "\n\nBitte sofort speichern!");
    }catch{ alert("âŒ Konnte Recovery-Key nicht erzeugen"); }
  };

  $("btnResetThisYear").onclick=async()=>{
    const yr=getRefYear();
    if(confirm(`Wirklich alle Daten fÃ¼r ${yr} lÃ¶schen?`)){
      localStorage.removeItem(YEAR_KEY(yr));
      await loadYear(getRefYear());
      await renderAll();
      alert("âœ… Jahr gelÃ¶scht");
    }
  };

  $("btnResetAll").onclick=async()=>{
    if(confirm("Wirklich ALLES lÃ¶schen (inkl. PIN/Recovery)?")){
      const del=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k && (k.startsWith(NS+"::year::") || k===VAULT_KEY || k===RUN_KEY)) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      clearSessionMaster();
      alert("âœ… Alles gelÃ¶scht. Seite lÃ¤dt neu.");
      location.reload();
    }
  };

  $("btnUnlock").onclick=async()=>{
    try{
      if(!hasVault()){ $("pinMsg").textContent="âš ï¸ Bitte PIN setzen."; return; }
      const secret=($("pinInput").value||"").trim();
      if(!secret) { $("pinMsg").textContent="âš ï¸ Bitte eingeben."; return; }
      const mode=$("authMode").value;
      await unlockWithSecret(secret, mode);
      hideOverlay();

      await loadYear(getRefYear());
      await renderAll();

      await restoreRunIfAny();
      tab("timer");
    }catch{ $("pinMsg").textContent="âŒ falsch"; }
  };

  $("btnSetPin").onclick=async()=>{
    try{
      if(hasVault()){ $("pinMsg").textContent="âš ï¸ PIN existiert schon."; return; }
      const pin=($("pinInput").value||"").trim();
      if(pin.length<6){ $("pinMsg").textContent="âš ï¸ PIN min. 6 Zeichen."; return; }
      const recovery = await createVaultWithPin(pin);
      $("recoveryText").textContent = recovery;
      $("recoveryBox").style.display="";
      $("btnCopyRecovery").style.display="";
      $("btnCopyRecovery").onclick=async()=>{
        try{ await navigator.clipboard.writeText(recovery); $("pinMsg").textContent="âœ… kopiert"; }
        catch{ $("pinMsg").textContent="âš ï¸ Bitte manuell speichern."; }
      };
      $("ovlText").textContent="âœ… PIN gesetzt. Recovery-Key speichern!";
      $("btnSetPin").style.display="none";
    }catch{ $("pinMsg").textContent="âŒ Fehler"; }
  };

  $("btnRefresh").onclick=async()=>{ await renderAll(); };
  $("mode").onchange=async()=>{ await renderAll(); };
  $("weeklyTarget").onchange=async()=>{ await renderAll(); };
  $("refDate").onchange=async()=>{ await loadYear(getRefYear()); await renderAll(); };

  $("entriesFilter").onchange=async()=>{ updateEntriesCustomVisibility(); await renderEntries(); };
  $("entriesSearch").oninput=async()=>{ await renderEntries(); };
  $("entriesFrom").onchange=async()=>{ await renderEntries(); };
  $("entriesTo").onchange=async()=>{ await renderEntries(); };

  async function renderAll(){
    $("timerMini").textContent=S.emp ? "ğŸ‘¤ "+S.emp : "";
    $("pdfEmpName").textContent = S.emp || "â€”";
    refreshAbsenceDropdown();
    renderAbsList();
    await renderOverview();
    await renderEntries();
  }

  const today=new Date().toISOString().slice(0,10);
  $("timerDate").value=today;
  $("refDate").value=today;
  $("eDate").value=today;
  $("aStart").value=today;
  $("aEnd").value=today;
  $("aDelDate").value=today;
  $("entriesFrom").value=today;
  $("entriesTo").value=today;
  $("entriesFilter").value="month";
  updateEntriesCustomVisibility();

  (async()=>{
    const master = await getSessionMaster();
    if(!master){
      showOverlay(hasVault()
        ? "ğŸ” Bitte PIN oder Recovery-Key eingeben."
        : "ğŸ§· Bitte PIN setzen (Recovery-Key wird angezeigt).");
      return;
    }

    await loadYear(getRefYear());
    await renderAll();

    await restoreRunIfAny();
    tab("timer");
  })();

})();
</script>
</body>
</html>
